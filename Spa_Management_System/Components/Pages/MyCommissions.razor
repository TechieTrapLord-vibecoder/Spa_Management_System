@page "/my-commissions"
@using Microsoft.EntityFrameworkCore
@using Spa_Management_System.Data
@using Spa_Management_System.Models
@using Spa_Management_System.Services
@inject AppDbContext DbContext
@inject IAuthStateService AuthState

<div class="page-header">
    <h1>My Commissions</h1>
    <p class="subtitle">Track your earnings from services</p>
</div>

@if (isLoading)
{
    <div class="loading-spinner">
        <div class="spinner"></div>
        <p>Loading your commission data...</p>
    </div>
}
else if (currentEmployee == null)
{
    <div class="alert alert-warning">
        <span class="alert-icon"><span class="bi bi-exclamation-triangle"></span></span>
        <span>Your account is not linked to an employee profile. Please contact your administrator.</span>
    </div>
}
else
{
    <div class="filter-section">
        <div class="filter-group">
            <label>Period:</label>
            <select @bind="selectedPeriod" @bind:after="LoadData" class="form-select">
                <option value="this-week">This Week</option>
                <option value="this-month">This Month</option>
                <option value="last-month">Last Month</option>
                <option value="this-year">This Year</option>
                <option value="custom">Custom Range</option>
            </select>
        </div>
        @if (selectedPeriod == "custom")
        {
            <div class="filter-group">
                <label>From:</label>
                <input type="date" @bind="startDate" @bind:after="LoadData" class="form-control" />
            </div>
            <div class="filter-group">
                <label>To:</label>
                <input type="date" @bind="endDate" @bind:after="LoadData" class="form-control" />
            </div>
        }
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card earnings">
            <div class="card-icon"><span class="bi bi-cash-coin"></span></div>
            <div class="card-content">
                <h3>Total Earnings</h3>
                <p class="amount">₱@totalEarnings.ToString("N2")</p>
            </div>
        </div>
        <div class="summary-card services">
            <div class="card-icon"><span class="bi bi-star-fill"></span></div>
            <div class="card-content">
                <h3>Services Completed</h3>
                <p class="amount">@totalServices</p>
            </div>
        </div>
        <div class="summary-card avg">
            <div class="card-icon"><span class="bi bi-bar-chart-line"></span></div>
            <div class="card-content">
                <h3>Average Per Service</h3>
                <p class="amount">₱@(totalServices > 0 ? (totalEarnings / totalServices).ToString("N2") : "0.00")</p>
            </div>
        </div>
        @if (pendingEarnings > 0)
        {
            <div class="summary-card pending">
                <div class="card-icon"><span class="bi bi-clock-history"></span></div>
                <div class="card-content">
                    <h3>Pending Payment</h3>
                    <p class="amount pending-amount">₱@pendingEarnings.ToString("N2")</p>
                </div>
            </div>
        }
    </div>

    <!-- Commission Details Table -->
    <div class="table-container">
        <h3>Commission Details</h3>
        @if (commissionItems.Count == 0)
        {
            <div class="empty-state">
                <span class="empty-icon"><span class="bi bi-clipboard"></span></span>
                <p>No commission records found for the selected period.</p>
            </div>
        }
        else
        {
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Service</th>
                        <th>Customer</th>
                        <th>Service Price</th>
                        <th>Commission Rate</th>
                        <th>Status</th>
                        <th>Earnings</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in GetPagedItems())
                    {
                        <tr class="@(item.IsPaid ? "" : "pending-row")">
                            <td>@item.Date.ToString("MMM dd, yyyy")</td>
                            <td>@item.ServiceName</td>
                            <td>@item.CustomerName</td>
                            <td>₱@item.ServicePrice.ToString("N2")</td>
                            <td>@(item.CommissionType == "percentage" ? $"{item.CommissionRate:N1}%" : $"₱{item.CommissionRate:N2}")</td>
                            <td>
                                @if (item.IsPaid)
                                {
                                    <span class="status-badge paid"><span class="bi bi-check-circle-fill"></span> Paid</span>
                                }
                                else
                                {
                                    <span class="status-badge pending"><span class="bi bi-clock-fill"></span> Pending</span>
                                }
                            </td>
                            <td class="earnings @(item.IsPaid ? "" : "pending-earnings")">₱@item.CommissionAmount.ToString("N2")</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="6" style="text-align: right; font-weight: bold;">Earned (Paid):</td>
                        <td class="earnings" style="font-weight: bold;">₱@totalEarnings.ToString("N2")</td>
                    </tr>
                    @if (pendingEarnings > 0)
                    {
                        <tr>
                            <td colspan="6" style="text-align: right; font-weight: bold; color: #856404;">Pending:</td>
                            <td class="pending-earnings" style="font-weight: bold;">₱@pendingEarnings.ToString("N2")</td>
                        </tr>
                    }
                </tfoot>
            </table>
            
            @if (TotalPages > 1)
            {
                <div class="table-pagination">
                    <div class="pagination-info">
                        Showing @(Math.Min((currentPage - 1) * pageSize + 1, commissionItems.Count)) to @(Math.Min(currentPage * pageSize, commissionItems.Count)) of @commissionItems.Count entries
                    </div>
                    <div class="pagination-controls">
                        <button class="page-btn" @onclick="PreviousPage" disabled="@(currentPage <= 1)">‹ Prev</button>
                        @foreach (var pageNum in GetVisiblePages())
                        {
                            @if (pageNum == -1)
                            {
                                <span class="page-ellipsis">...</span>
                            }
                            else
                            {
                                <button class="page-btn @(currentPage == pageNum ? "active" : "")" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                            }
                        }
                        <button class="page-btn" @onclick="NextPage" disabled="@(currentPage >= TotalPages)">Next ›</button>
                    </div>
                </div>
            }
        }
    </div>
}

@code {
    private bool isLoading = true;
    private Employee? currentEmployee;
    private string selectedPeriod = "this-month";
    private DateTime startDate = DateTime.Today.AddDays(-30);
    private decimal pendingEarnings;
    private DateTime endDate = DateTime.Today;

    private decimal totalEarnings;
    private int totalServices;
    private List<CommissionItem> commissionItems = new();
    
    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;
    private int TotalPages => (int)Math.Ceiling((double)commissionItems.Count / pageSize);
    
    private List<CommissionItem> GetPagedItems()
    {
        return commissionItems
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }
    
    private void PreviousPage()
    {
        if (currentPage > 1) currentPage--;
    }
    
    private void NextPage()
    {
        if (currentPage < TotalPages) currentPage++;
    }
    
    private void GoToPage(int page)
    {
        currentPage = page;
    }
    
    // Get visible page numbers with ellipsis for large page counts
    private List<int> GetVisiblePages()
    {
        var pages = new List<int>();
        
        if (TotalPages <= 7)
        {
            for (int i = 1; i <= TotalPages; i++)
                pages.Add(i);
        }
        else
        {
            pages.Add(1);
            
            if (currentPage > 3)
                pages.Add(-1); // Ellipsis
            
            int start = Math.Max(2, currentPage - 1);
            int end = Math.Min(TotalPages - 1, currentPage + 1);
            
            if (currentPage <= 3)
            {
                start = 2;
                end = 5;
            }
            
            if (currentPage >= TotalPages - 2)
            {
                start = TotalPages - 4;
                end = TotalPages - 1;
            }
            
            for (int i = start; i <= end; i++)
                pages.Add(i);
            
            if (currentPage < TotalPages - 2)
                pages.Add(-1); // Ellipsis
            
            pages.Add(TotalPages);
        }
        
        return pages;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        currentPage = 1; // Reset to page 1 when loading new data
        StateHasChanged();

        try
        {
            // Get current user's employee ID
            var currentUserId = AuthState.CurrentUser?.EmployeeId;
            
            if (currentUserId == null)
            {
                currentEmployee = null;
                isLoading = false;
                return;
            }

            // Load current employee
            currentEmployee = await DbContext.Employees
                .FirstOrDefaultAsync(e => e.EmployeeId == currentUserId);

            if (currentEmployee == null)
            {
                isLoading = false;
                return;
            }

            // Calculate date range based on selected period
            CalculateDateRange();

            // Load commission data for THIS THERAPIST ONLY
            // Include both paid and completed (pending payment) appointments
            var commissions = await DbContext.AppointmentServices
                .Include(a => a.Appointment)
                    .ThenInclude(apt => apt.Customer)
                        .ThenInclude(c => c.Person)
                .Include(a => a.Service)
                .Where(a => a.TherapistEmployeeId == currentUserId) // Filter by current therapist
                .Where(a => a.Appointment.Status == "paid" || a.Appointment.Status == "completed") // Paid + pending payment
                .Where(a => a.Appointment.ScheduledStart >= startDate && a.Appointment.ScheduledStart <= endDate.AddDays(1))
                .OrderByDescending(a => a.Appointment.ScheduledStart)
                .ToListAsync();

            commissionItems = commissions.Select(c => {
                // Use the commission settings from the Service table
                var commissionType = c.Service?.CommissionType ?? "percentage";
                var commissionValue = c.Service?.CommissionValue ?? 0m;
                
                // Calculate commission based on type
                var commissionAmount = commissionType == "percentage"
                    ? c.Price * (commissionValue / 100)
                    : commissionValue; // Fixed amount
                    
                var isPaid = c.Appointment.Status == "paid";
                
                return new CommissionItem
                {
                    Date = c.Appointment.ScheduledStart,
                    ServiceName = c.Service?.Name ?? "Unknown Service",
                    CustomerName = c.Appointment.Customer?.Person != null 
                        ? $"{c.Appointment.Customer.Person.FirstName} {c.Appointment.Customer.Person.LastName}"
                        : "Walk-in",
                    ServicePrice = c.Price,
                    CommissionRate = commissionValue,
                    CommissionType = commissionType,
                    CommissionAmount = commissionAmount,
                    IsPaid = isPaid
                };
            }).ToList();

            // Only count PAID appointments as earned
            totalEarnings = commissionItems.Where(c => c.IsPaid).Sum(c => c.CommissionAmount);
            pendingEarnings = commissionItems.Where(c => !c.IsPaid).Sum(c => c.CommissionAmount);
            totalServices = commissionItems.Count(c => c.IsPaid);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading commissions: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void CalculateDateRange()
    {
        var today = DateTime.Today;
        
        switch (selectedPeriod)
        {
            case "this-week":
                var daysFromMonday = ((int)today.DayOfWeek - (int)DayOfWeek.Monday + 7) % 7;
                startDate = today.AddDays(-daysFromMonday);
                endDate = today;
                break;
            case "this-month":
                startDate = new DateTime(today.Year, today.Month, 1);
                endDate = today;
                break;
            case "last-month":
                var lastMonth = today.AddMonths(-1);
                startDate = new DateTime(lastMonth.Year, lastMonth.Month, 1);
                endDate = new DateTime(lastMonth.Year, lastMonth.Month, DateTime.DaysInMonth(lastMonth.Year, lastMonth.Month));
                break;
            case "this-year":
                startDate = new DateTime(today.Year, 1, 1);
                endDate = today;
                break;
            // custom - use the dates as-is
        }
    }

    private class CommissionItem
    {
        public DateTime Date { get; set; }
        public string ServiceName { get; set; } = "";
        public string CustomerName { get; set; } = "";
        public decimal ServicePrice { get; set; }
        public decimal CommissionRate { get; set; }
        public string CommissionType { get; set; } = "percentage";
        public decimal CommissionAmount { get; set; }
        public bool IsPaid { get; set; }
    }
}

<style>
    .page-header {
        margin-bottom: 2rem;
    }

    .page-header h1 {
        font-size: 2rem;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .subtitle {
        color: #6c757d;
        margin: 0;
    }

    .filter-section {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .filter-group label {
        font-weight: 500;
        color: #495057;
    }

    .form-select, .form-control {
        padding: 0.5rem 1rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 0.95rem;
        min-width: 150px;
    }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .summary-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .summary-card.earnings {
        border-left: 4px solid var(--spa-success);
    }

    .summary-card.services {
        border-left: 4px solid var(--spa-info);
    }

    .summary-card.avg {
        border-left: 4px solid var(--spa-accent);
    }

    .summary-card.pending {
        border-left: 4px solid #ffc107;
        background: #fffdf5;
    }

    .pending-amount {
        color: #856404 !important;
    }

    .card-icon {
        font-size: 2.5rem;
    }

    .card-content h3 {
        font-size: 0.9rem;
        color: #6c757d;
        margin: 0 0 0.5rem 0;
    }

    .card-content .amount {
        font-size: 1.8rem;
        font-weight: bold;
        color: #2c3e50;
        margin: 0;
    }

    .table-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .table-container h3 {
        margin: 0 0 1rem 0;
        color: #2c3e50;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }

    .data-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }

    .data-table tr:hover {
        background: #f8f9fa;
    }

    .data-table .earnings {
        color: #28a745;
        font-weight: 600;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }

    .empty-icon {
        font-size: 3rem;
        display: block;
        margin-bottom: 1rem;
    }

    .loading-spinner {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--spa-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .alert {
        padding: 1rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .alert-warning {
        background: #fff3cd;
        color: #856404;
    }

    /* Status badges */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .status-badge.paid {
        background: #d4edda;
        color: #155724;
    }

    .status-badge.pending {
        background: #fff3cd;
        color: #856404;
    }

    /* Pending row styling */
    .pending-row {
        background: #fffdf5;
    }

    .pending-row:hover {
        background: #fff8e6 !important;
    }

    .pending-earnings {
        color: #856404 !important;
        font-weight: 600;
    }
</style>
