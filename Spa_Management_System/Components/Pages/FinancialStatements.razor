@page "/financial-statements"
@using Microsoft.EntityFrameworkCore
@using Spa_Management_System.Data
@using Spa_Management_System.Models
@using Spa_Management_System.Services
@inject IDbContextFactory<AppDbContext> DbContextFactory
@inject IAuthStateService AuthState
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject PdfExportService PdfService

<PageTitle>Financial Statements - Kaye Spa</PageTitle>

@if (!AuthState.IsAuthenticated)
{
    Navigation.NavigateTo("/login");
}
else
{
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h3 class="card-title" style="margin: 0;"><span class="bi bi-file-earmark-spreadsheet"></span> Financial Statements</h3>
                <p style="color: var(--spa-text-light); margin: 0.25rem 0 0 0;">Balance Sheet & Income Statement</p>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: flex-end; flex-wrap: wrap;">
                <!-- Period Selection - applies to all tabs -->
                <div class="form-group" style="margin: 0;">
                    <label class="form-label" style="font-size: 0.85rem;">Period</label>
                    <select class="form-control" @bind="selectedPeriod" @bind:after="OnPeriodChanged" style="min-width: 150px;">
                        <option value="month">Current Month</option>
                        <option value="quarter">Current Quarter</option>
                        <option value="year">Current Year</option>
                        <option value="ytd">Year to Date</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                @if (selectedPeriod == "custom")
                {
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label" style="font-size: 0.85rem;">From</label>
                        <input type="date" class="form-control" @bind="incomeStartDate" @bind:after="LoadStatements" />
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label" style="font-size: 0.85rem;">To</label>
                        <input type="date" class="form-control" @bind="incomeEndDate" @bind:after="LoadStatements" />
                    </div>
                }
                <button class="btn btn-outline" @onclick="ExportToPdf" disabled="@isExporting">
                    <span class="bi bi-file-earmark-pdf"></span> @(isExporting ? "Exporting..." : "PDF")
                </button>
                <button class="btn btn-outline" @onclick="PrintStatement">
                    <span class="bi bi-printer"></span> Print
                </button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div style="border-bottom: 2px solid var(--spa-secondary); margin-bottom: 1.5rem;">
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn @(activeTab == "balance" ? "btn-primary" : "btn-outline")" @onclick='() => activeTab = "balance"'>
                    <span class="bi bi-wallet2"></span> Balance Sheet
                </button>
                <button class="btn @(activeTab == "income" ? "btn-primary" : "btn-outline")" @onclick='() => activeTab = "income"'>
                    <span class="bi bi-graph-up"></span> Income Statement
                </button>
                <button class="btn @(activeTab == "trial" ? "btn-primary" : "btn-outline")" @onclick='() => activeTab = "trial"'>
                    <span class="bi bi-list-check"></span> Trial Balance
                </button>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" style="margin-bottom: 1rem;">
                <span class="bi bi-exclamation-triangle"></span> @errorMessage
                <button class="btn btn-sm btn-outline-danger" style="margin-left: 1rem;" @onclick="LoadStatements">
                    <span class="bi bi-arrow-clockwise"></span> Retry
                </button>
            </div>
        }
        
        @if (isLoading)
        {
            <div style="text-align: center; padding: 3rem;">
                <div class="loading"></div>
                <p style="color: var(--spa-text-light); margin-top: 1rem;">Generating statements...</p>
            </div>
        }
        else if (string.IsNullOrEmpty(errorMessage))
        {
            <!-- Balance Sheet -->
            @if (activeTab == "balance")
            {
                <div id="balanceSheetContainer">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--spa-primary); margin: 0;">Kaye Spa</h2>
                        <h4 style="color: var(--spa-text-light); margin: 0.25rem 0;">Balance Sheet</h4>
                        <p style="color: var(--spa-text-light); margin: 0;">As of @incomeEndDate.ToString("MMMM d, yyyy") (@GetPeriodDescription())</p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <!-- Assets Side -->
                        <div>
                            <h4 style="color: var(--spa-primary); border-bottom: 2px solid var(--spa-primary); padding-bottom: 0.5rem;">ASSETS</h4>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="color: var(--spa-text-dark);">Current Assets</h5>
                                <table class="table" style="margin-bottom: 0;">
                                    @foreach (var account in assetAccounts.Where(a => IsCurrentAsset(a.Code)))
                                    {
                                        <tr>
                                            <td style="padding: 0.5rem 0;">@account.Name</td>
                                            <td style="text-align: right; padding: 0.5rem 0;">₱@GetAccountBalance(account).ToString("N2")</td>
                                        </tr>
                                    }
                                    <tr style="font-weight: 600; border-top: 1px solid var(--spa-secondary);">
                                        <td style="padding: 0.5rem 0;">Total Current Assets</td>
                                        <td style="text-align: right; padding: 0.5rem 0;">₱@totalCurrentAssets.ToString("N2")</td>
                                    </tr>
                                </table>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="color: var(--spa-text-dark);">Non-Current Assets</h5>
                                <table class="table" style="margin-bottom: 0;">
                                    @foreach (var account in assetAccounts.Where(a => !IsCurrentAsset(a.Code)))
                                    {
                                        <tr>
                                            <td style="padding: 0.5rem 0;">@account.Name</td>
                                            <td style="text-align: right; padding: 0.5rem 0;">₱@GetAccountBalance(account).ToString("N2")</td>
                                        </tr>
                                    }
                                    <tr style="font-weight: 600; border-top: 1px solid var(--spa-secondary);">
                                        <td style="padding: 0.5rem 0;">Total Non-Current Assets</td>
                                        <td style="text-align: right; padding: 0.5rem 0;">₱@totalNonCurrentAssets.ToString("N2")</td>
                                    </tr>
                                </table>
                            </div>

                            <div style="padding: 1rem; background: #454F4A; border-radius: 8px; color: white;">
                                <div style="display: flex; justify-content: space-between;">
                                    <strong>TOTAL ASSETS</strong>
                                    <strong>₱@totalAssets.ToString("N2")</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Liabilities & Equity Side -->
                        <div>
                            <h4 style="color: var(--spa-primary); border-bottom: 2px solid var(--spa-primary); padding-bottom: 0.5rem;">LIABILITIES & EQUITY</h4>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="color: var(--spa-text-dark);">Current Liabilities</h5>
                                <table class="table" style="margin-bottom: 0;">
                                    @foreach (var account in liabilityAccounts.Where(a => IsCurrentLiability(a.Code)))
                                    {
                                        <tr>
                                            <td style="padding: 0.5rem 0;">@account.Name</td>
                                            <td style="text-align: right; padding: 0.5rem 0;">₱@GetAccountBalance(account).ToString("N2")</td>
                                        </tr>
                                    }
                                    <tr style="font-weight: 600; border-top: 1px solid var(--spa-secondary);">
                                        <td style="padding: 0.5rem 0;">Total Current Liabilities</td>
                                        <td style="text-align: right; padding: 0.5rem 0;">₱@totalCurrentLiabilities.ToString("N2")</td>
                                    </tr>
                                </table>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="color: var(--spa-text-dark);">Long-Term Liabilities</h5>
                                <table class="table" style="margin-bottom: 0;">
                                    @foreach (var account in liabilityAccounts.Where(a => !IsCurrentLiability(a.Code)))
                                    {
                                        <tr>
                                            <td style="padding: 0.5rem 0;">@account.Name</td>
                                            <td style="text-align: right; padding: 0.5rem 0;">₱@GetAccountBalance(account).ToString("N2")</td>
                                        </tr>
                                    }
                                    <tr style="font-weight: 600; border-top: 1px solid var(--spa-secondary);">
                                        <td style="padding: 0.5rem 0;">Total Long-Term Liabilities</td>
                                        <td style="text-align: right; padding: 0.5rem 0;">₱@totalLongTermLiabilities.ToString("N2")</td>
                                    </tr>
                                </table>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="color: var(--spa-text-dark);">Equity</h5>
                                <table class="table" style="margin-bottom: 0;">
                                    @foreach (var account in equityAccounts)
                                    {
                                        <tr>
                                            <td style="padding: 0.5rem 0;">@account.Name</td>
                                            <td style="text-align: right; padding: 0.5rem 0;">₱@GetAccountBalance(account).ToString("N2")</td>
                                        </tr>
                                    }
                                    <tr>
                                        <td style="padding: 0.5rem 0; font-style: italic;">Retained Earnings (Cumulative)</td>
                                        <td style="text-align: right; padding: 0.5rem 0; color: @(cumulativeNetIncome >= 0 ? "#28a745" : "#dc3545");">₱@cumulativeNetIncome.ToString("N2")</td>
                                    </tr>
                                    <tr style="font-weight: 600; border-top: 1px solid var(--spa-secondary);">
                                        <td style="padding: 0.5rem 0;">Total Equity</td>
                                        <td style="text-align: right; padding: 0.5rem 0;">₱@totalEquity.ToString("N2")</td>
                                    </tr>
                                </table>
                            </div>

                            <div style="padding: 1rem; background: #454F4A; border-radius: 8px; color: white;">
                                <div style="display: flex; justify-content: space-between;">
                                    <strong>TOTAL LIABILITIES & EQUITY</strong>
                                    <strong>₱@totalLiabilitiesAndEquity.ToString("N2")</strong>
                                </div>
                            </div>

                            @if (Math.Abs(totalAssets - totalLiabilitiesAndEquity) > 0.01m)
                            {
                                <div class="alert alert-warning" style="margin-top: 1rem;">
                                    <span class="bi bi-exclamation-triangle"></span>
                                    Balance sheet is out of balance by ₱@Math.Abs(totalAssets - totalLiabilitiesAndEquity).ToString("N2")
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-success" style="margin-top: 1rem;">
                                    <span class="bi bi-check-circle"></span>
                                    Balance sheet is balanced
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Income Statement -->
            @if (activeTab == "income")
            {
                <div id="incomeStatementContainer">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--spa-primary); margin: 0;">Kaye Spa</h2>
                        <h4 style="color: var(--spa-text-light); margin: 0.25rem 0;">Income Statement</h4>
                        <p style="color: var(--spa-text-light); margin: 0;">
                            For the Period @incomeStartDate.ToString("MMMM d, yyyy") to @incomeEndDate.ToString("MMMM d, yyyy")
                        </p>
                        <p style="color: var(--spa-text-light); font-size: 0.85rem; margin: 0.25rem 0 0 0;">
                            (@GetPeriodDescription())
                        </p>
                    </div>

                    <div style="max-width: 700px; margin: 0 auto;">
                        <!-- Revenue Section -->
                        <div style="margin-bottom: 2rem;">
                            <h4 style="color: var(--spa-primary); border-bottom: 2px solid var(--spa-primary); padding-bottom: 0.5rem;">REVENUE</h4>
                            <table class="table" style="margin-bottom: 0;">
                                @foreach (var account in revenueAccounts)
                                {
                                    var balance = GetIncomeAccountBalance(account);
                                    @if (balance != 0)
                                    {
                                        <tr>
                                            <td style="padding: 0.5rem 0; padding-left: 1rem;">@account.Name</td>
                                            <td style="text-align: right; padding: 0.5rem 0;">₱@balance.ToString("N2")</td>
                                        </tr>
                                    }
                                }
                                @if (!revenueAccounts.Any(a => GetIncomeAccountBalance(a) != 0))
                                {
                                    <tr>
                                        <td colspan="2" style="padding: 0.5rem 0; color: var(--spa-text-light); font-style: italic;">No revenue recorded for this period</td>
                                    </tr>
                                }
                                <tr style="font-weight: 700; background: #e8f5e9; color: #2e7d32;">
                                    <td style="padding: 0.75rem;">Total Revenue</td>
                                    <td style="text-align: right; padding: 0.75rem;">₱@totalRevenue.ToString("N2")</td>
                                </tr>
                            </table>
                        </div>

                        <!-- Expenses Section -->
                        <div style="margin-bottom: 2rem;">
                            <h4 style="color: var(--spa-primary); border-bottom: 2px solid var(--spa-primary); padding-bottom: 0.5rem;">EXPENSES</h4>
                            <table class="table" style="margin-bottom: 0;">
                                @foreach (var account in expenseAccounts)
                                {
                                    var balance = GetIncomeAccountBalance(account);
                                    @if (balance != 0)
                                    {
                                        <tr>
                                            <td style="padding: 0.5rem 0; padding-left: 1rem;">@account.Name</td>
                                            <td style="text-align: right; padding: 0.5rem 0;">₱@balance.ToString("N2")</td>
                                        </tr>
                                    }
                                }
                                @if (!expenseAccounts.Any(a => GetIncomeAccountBalance(a) != 0))
                                {
                                    <tr>
                                        <td colspan="2" style="padding: 0.5rem 0; color: var(--spa-text-light); font-style: italic;">No expenses recorded for this period</td>
                                    </tr>
                                }
                                <tr style="font-weight: 700; background: #ffebee; color: #c62828;">
                                    <td style="padding: 0.75rem;">Total Expenses</td>
                                    <td style="text-align: right; padding: 0.75rem;">₱@totalExpenses.ToString("N2")</td>
                                </tr>
                            </table>
                        </div>

                        <!-- Net Income -->
                        <div style="padding: 1.5rem; background: @(netIncome >= 0 ? "var(--spa-success)" : "var(--spa-danger)"); border-radius: 12px; color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">@(netIncome >= 0 ? "NET INCOME" : "NET LOSS")</div>
                                    <div style="font-size: 0.8rem; opacity: 0.8;">Revenue - Expenses</div>
                                </div>
                                <div style="font-size: 2rem; font-weight: 700;">₱@Math.Abs(netIncome).ToString("N2")</div>
                            </div>
                        </div>

                        <!-- Key Ratios -->
                        <div style="margin-top: 2rem; padding: 1.5rem; background: var(--spa-light); border-radius: 12px;">
                            <h5 style="color: var(--spa-primary); margin-bottom: 1rem;"><span class="bi bi-bar-chart-line"></span> Key Metrics</h5>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                                    <div style="font-size: 0.85rem; color: var(--spa-text-light);">Profit Margin</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: @(profitMargin >= 0 ? "#28a745" : "#dc3545");">
                                        @profitMargin.ToString("N1")%
                                    </div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                                    <div style="font-size: 0.85rem; color: var(--spa-text-light);">Expense Ratio</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--spa-warning);">
                                        @expenseRatio.ToString("N1")%
                                    </div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                                    <div style="font-size: 0.85rem; color: var(--spa-text-light);">Transactions</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--spa-info);">
                                        @transactionCount
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Trial Balance -->
            @if (activeTab == "trial")
            {
                <div id="trialBalanceContainer">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--spa-primary); margin: 0;">Kaye Spa</h2>
                        <h4 style="color: var(--spa-text-light); margin: 0.25rem 0;">Trial Balance</h4>
                        <p style="color: var(--spa-text-light); margin: 0;">As of @incomeEndDate.ToString("MMMM d, yyyy") (@GetPeriodDescription())</p>
                    </div>

                    <!-- Search and Filter Controls -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                        <div class="table-search" style="flex: 1; max-width: 400px;">
                            <input type="text" placeholder="Search by code or name..." 
                                   @bind="trialBalanceSearchTerm" @bind:event="oninput" @bind:after="ApplyTrialBalanceFilter" 
                                   style="width: 100%;" />
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <label style="font-size: 0.85rem; color: var(--spa-text-light);">Show:</label>
                            <select class="form-control" style="width: auto; min-width: 180px;" @bind="trialBalanceFilterMode" @bind:after="ApplyTrialBalanceFilter">
                                <option value="all">All Accounts</option>
                                <option value="withBalance">With Balance Only</option>
                                <option value="asset">Assets Only</option>
                                <option value="liability">Liabilities Only</option>
                                <option value="equity">Equity Only</option>
                                <option value="revenue">Revenue Only</option>
                                <option value="expense">Expenses Only</option>
                            </select>
                        </div>
                    </div>

                    <table class="data-table" id="trialBalanceTable">
                        <thead>
                            <tr>
                                <th style="cursor: pointer;" @onclick='() => SortTrialBalanceBy("code")'>Account Code @GetTrialBalanceSortIcon("code")</th>
                                <th style="cursor: pointer;" @onclick='() => SortTrialBalanceBy("name")'>Account Name @GetTrialBalanceSortIcon("name")</th>
                                <th style="cursor: pointer;" @onclick='() => SortTrialBalanceBy("type")'>Type @GetTrialBalanceSortIcon("type")</th>
                                <th style="text-align: right; cursor: pointer;" @onclick='() => SortTrialBalanceBy("debit")'>Debit @GetTrialBalanceSortIcon("debit")</th>
                                <th style="text-align: right; cursor: pointer;" @onclick='() => SortTrialBalanceBy("credit")'>Credit @GetTrialBalanceSortIcon("credit")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var account in GetPagedTrialBalanceAccounts())
                            {
                                var balance = GetAccountBalance(account);
                                var isDebitAccount = account.NormalBalance.Equals("debit", StringComparison.OrdinalIgnoreCase);
                                var hasBalance = balance != 0;
                                // Determine which column to show based on actual balance sign
                                // Positive balance for debit account = Debit column
                                // Negative balance for debit account = Credit column (contra)
                                // Positive balance for credit account = Credit column
                                // Negative balance for credit account = Debit column (contra)
                                var showInDebitColumn = (isDebitAccount && balance > 0) || (!isDebitAccount && balance < 0);
                                var showInCreditColumn = (!isDebitAccount && balance > 0) || (isDebitAccount && balance < 0);
                                <tr style="@(!hasBalance ? "opacity: 0.6;" : "")">
                                    <td><strong style="font-family: monospace;">@account.Code</strong></td>
                                    <td>@account.Name</td>
                                    <td>
                                        <span class="badge @GetAccountTypeBadge(account.AccountType)">@account.AccountType.ToUpper()</span>
                                    </td>
                                    <td style="text-align: right;">
                                        @if (showInDebitColumn)
                                        {
                                            <span>₱@Math.Abs(balance).ToString("N2")</span>
                                        }
                                        else if (!showInCreditColumn)
                                        {
                                            <span style="color: var(--spa-text-light);">₱0.00</span>
                                        }
                                    </td>
                                    <td style="text-align: right;">
                                        @if (showInCreditColumn)
                                        {
                                            <span>₱@Math.Abs(balance).ToString("N2")</span>
                                        }
                                        else if (!showInDebitColumn)
                                        {
                                            <span style="color: var(--spa-text-light);">₱0.00</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr style="font-weight: 700; background: var(--spa-primary); color: white;">
                                <td colspan="3">TOTALS</td>
                                <td style="text-align: right;">₱@totalDebits.ToString("N2")</td>
                                <td style="text-align: right;">₱@totalCredits.ToString("N2")</td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Pagination -->
                    <div class="table-pagination">
                        <div class="pagination-info">
                            Showing @(Math.Min((trialBalanceCurrentPage - 1) * trialBalancePageSize + 1, filteredTrialBalanceAccounts.Count)) to @(Math.Min(trialBalanceCurrentPage * trialBalancePageSize, filteredTrialBalanceAccounts.Count)) of @filteredTrialBalanceAccounts.Count entries
                            @if (!string.IsNullOrEmpty(trialBalanceSearchTerm) || trialBalanceFilterMode != "all")
                            {
                                <span style="color: var(--spa-text-light);"> (filtered from @allAccounts.Count total)</span>
                            }
                        </div>
                        <div class="pagination-controls">
                            <button class="page-btn" @onclick="TrialBalancePreviousPage" disabled="@(trialBalanceCurrentPage <= 1)">‹ Prev</button>
                            @foreach (var pageNum in GetTrialBalancePageNumbers())
                            {
                                @if (pageNum == -1)
                                {
                                    <span style="padding: 0.5rem;">...</span>
                                }
                                else
                                {
                                    <button class="page-btn @(trialBalanceCurrentPage == pageNum ? "active" : "")" @onclick="() => TrialBalanceGoToPage(pageNum)">@pageNum</button>
                                }
                            }
                            <button class="page-btn" @onclick="TrialBalanceNextPage" disabled="@(trialBalanceCurrentPage >= TrialBalanceTotalPages)">Next ›</button>
                        </div>
                    </div>

                    @if (Math.Abs(totalDebits - totalCredits) < 0.01m)
                    {
                        <div class="alert alert-success" style="margin-top: 1rem;">
                            <span class="bi bi-check-circle-fill"></span>
                            Trial balance is balanced! Debits = Credits
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-danger" style="margin-top: 1rem;">
                            <span class="bi bi-x-circle-fill"></span>
                            Trial balance is out of balance by ₱@Math.Abs(totalDebits - totalCredits).ToString("N2")
                        </div>
                    }
                </div>
            }
        }
    </div>
}

@code {
    private bool isLoading = true;
    private bool isExporting = false;
    private string activeTab = "balance";
    private DateTime asOfDate = DateTime.Today;

    // Income Statement period selection
    private string selectedPeriod = "month";
    private DateTime incomeStartDate = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
    private DateTime incomeEndDate = DateTime.Today;

    // All accounts
    private List<LedgerAccount> allAccounts = new();
    private List<LedgerAccount> assetAccounts = new();
    private List<LedgerAccount> liabilityAccounts = new();
    private List<LedgerAccount> equityAccounts = new();
    private List<LedgerAccount> revenueAccounts = new();
    private List<LedgerAccount> expenseAccounts = new();

    // Account balances dictionary (for Balance Sheet - cumulative)
    private Dictionary<long, decimal> accountBalances = new();
    
    // Income account balances dictionary (for Income Statement - period-specific)
    private Dictionary<long, decimal> incomeAccountBalances = new();

    // Balance Sheet totals
    private decimal totalCurrentAssets = 0;
    private decimal totalNonCurrentAssets = 0;
    private decimal totalAssets = 0;
    private decimal totalCurrentLiabilities = 0;
    private decimal totalLongTermLiabilities = 0;
    private decimal totalLiabilities = 0;
    private decimal totalEquityAccounts = 0;
    private decimal totalEquity = 0;
    private decimal totalLiabilitiesAndEquity = 0;

    // Income Statement totals
    private decimal totalRevenue = 0;
    private decimal totalExpenses = 0;
    private decimal netIncome = 0;
    private decimal cumulativeNetIncome = 0; // For Balance Sheet - cumulative retained earnings
    private decimal profitMargin = 0;
    private decimal expenseRatio = 0;
    private int transactionCount = 0;

    // Trial Balance totals
    private decimal totalDebits = 0;
    private decimal totalCredits = 0;

    // Trial Balance pagination and filtering
    private string trialBalanceSearchTerm = "";
    private string trialBalanceFilterMode = "all";
    private string trialBalanceSortColumn = "code";
    private bool trialBalanceSortAscending = true;
    private int trialBalanceCurrentPage = 1;
    private int trialBalancePageSize = 15;
    private List<LedgerAccount> filteredTrialBalanceAccounts = new();
    private int TrialBalanceTotalPages => (int)Math.Ceiling(filteredTrialBalanceAccounts.Count / (double)trialBalancePageSize);

    // Error handling
    private string? errorMessage = null;

    protected override async Task OnInitializedAsync()
    {
        SetPeriodDates(); // Initialize income statement dates
        await LoadStatements();
    }

    private async Task OnPeriodChanged()
    {
        SetPeriodDates();
        await LoadStatements();
    }

    private void SetPeriodDates()
    {
        var today = DateTime.Today;
        
        switch (selectedPeriod)
        {
            case "month":
                // Current month
                incomeStartDate = new DateTime(today.Year, today.Month, 1);
                incomeEndDate = today;
                break;
            case "quarter":
                // Current quarter
                int quarter = (today.Month - 1) / 3;
                incomeStartDate = new DateTime(today.Year, quarter * 3 + 1, 1);
                incomeEndDate = today;
                break;
            case "year":
                // Full current year (Jan 1 to Dec 31)
                incomeStartDate = new DateTime(today.Year, 1, 1);
                incomeEndDate = new DateTime(today.Year, 12, 31);
                break;
            case "ytd":
                // Year to date (Jan 1 to today)
                incomeStartDate = new DateTime(today.Year, 1, 1);
                incomeEndDate = today;
                break;
            case "custom":
                // Keep current custom dates
                break;
        }
    }

    private string GetPeriodDescription()
    {
        return selectedPeriod switch
        {
            "month" => $"{incomeStartDate:MMMM yyyy}",
            "quarter" => $"Q{((incomeStartDate.Month - 1) / 3) + 1} {incomeStartDate.Year}",
            "year" => $"Fiscal Year {incomeStartDate.Year}",
            "ytd" => $"Year to Date {incomeStartDate.Year}",
            "custom" => "Custom Period",
            _ => "Period"
        };
    }

    private async Task LoadStatements()
    {
        isLoading = true;
        errorMessage = null;
        await InvokeAsync(StateHasChanged);
        
        try
        {
            using var DbContext = await DbContextFactory.CreateDbContextAsync();
            
            // Load all accounts
            allAccounts = await DbContext.LedgerAccounts
                .AsNoTracking()
                .OrderBy(a => a.Code)
                .ToListAsync();

            // Categorize accounts (case-insensitive)
            assetAccounts = allAccounts.Where(a => a.AccountType.Equals("asset", StringComparison.OrdinalIgnoreCase)).ToList();
            liabilityAccounts = allAccounts.Where(a => a.AccountType.Equals("liability", StringComparison.OrdinalIgnoreCase)).ToList();
            equityAccounts = allAccounts.Where(a => a.AccountType.Equals("equity", StringComparison.OrdinalIgnoreCase)).ToList();
            revenueAccounts = allAccounts.Where(a => a.AccountType.Equals("revenue", StringComparison.OrdinalIgnoreCase)).ToList();
            expenseAccounts = allAccounts.Where(a => a.AccountType.Equals("expense", StringComparison.OrdinalIgnoreCase)).ToList();

            // Calculate CUMULATIVE account balances using database aggregation (much faster)
            var cumulativeBalances = await DbContext.JournalEntryLines
                .AsNoTracking()
                .Where(j => j.JournalEntry.Date <= incomeEndDate)
                .GroupBy(j => j.LedgerAccountId)
                .Select(g => new { AccountId = g.Key, TotalDebit = g.Sum(l => l.Debit), TotalCredit = g.Sum(l => l.Credit) })
                .ToListAsync();

            accountBalances.Clear();
            foreach (var account in allAccounts)
            {
                var bal = cumulativeBalances.FirstOrDefault(b => b.AccountId == account.LedgerAccountId);
                if (bal != null)
                {
                    decimal balance = account.NormalBalance.Equals("debit", StringComparison.OrdinalIgnoreCase)
                        ? bal.TotalDebit - bal.TotalCredit
                        : bal.TotalCredit - bal.TotalDebit;
                    accountBalances[account.LedgerAccountId] = balance;
                }
                else
                {
                    accountBalances[account.LedgerAccountId] = 0;
                }
            }

            // Calculate PERIOD-SPECIFIC account balances using database aggregation
            var periodBalances = await DbContext.JournalEntryLines
                .AsNoTracking()
                .Where(j => j.JournalEntry.Date >= incomeStartDate && j.JournalEntry.Date <= incomeEndDate)
                .GroupBy(j => j.LedgerAccountId)
                .Select(g => new { AccountId = g.Key, TotalDebit = g.Sum(l => l.Debit), TotalCredit = g.Sum(l => l.Credit) })
                .ToListAsync();

            incomeAccountBalances.Clear();
            foreach (var account in allAccounts.Where(a => a.AccountType.Equals("revenue", StringComparison.OrdinalIgnoreCase) || a.AccountType.Equals("expense", StringComparison.OrdinalIgnoreCase)))
            {
                var bal = periodBalances.FirstOrDefault(b => b.AccountId == account.LedgerAccountId);
                if (bal != null)
                {
                    decimal balance = account.NormalBalance.Equals("debit", StringComparison.OrdinalIgnoreCase)
                        ? bal.TotalDebit - bal.TotalCredit
                        : bal.TotalCredit - bal.TotalDebit;
                    incomeAccountBalances[account.LedgerAccountId] = balance;
                }
                else
                {
                    incomeAccountBalances[account.LedgerAccountId] = 0;
                }
            }

            // Calculate Balance Sheet totals (using cumulative balances)
            totalCurrentAssets = assetAccounts.Where(a => IsCurrentAsset(a.Code)).Sum(a => GetAccountBalance(a));
            totalNonCurrentAssets = assetAccounts.Where(a => !IsCurrentAsset(a.Code)).Sum(a => GetAccountBalance(a));
            totalAssets = totalCurrentAssets + totalNonCurrentAssets;

            totalCurrentLiabilities = liabilityAccounts.Where(a => IsCurrentLiability(a.Code)).Sum(a => GetAccountBalance(a));
            totalLongTermLiabilities = liabilityAccounts.Where(a => !IsCurrentLiability(a.Code)).Sum(a => GetAccountBalance(a));
            totalLiabilities = totalCurrentLiabilities + totalLongTermLiabilities;

            totalEquityAccounts = equityAccounts.Sum(a => GetAccountBalance(a));

            // Calculate CUMULATIVE net income for Balance Sheet (all revenue - expenses up to end date)
            // Contra-revenue accounts (debit normal balance) reduce revenue
            var cumulativeRevenue = revenueAccounts
                .Where(a => a.NormalBalance.Equals("credit", StringComparison.OrdinalIgnoreCase))
                .Sum(a => GetAccountBalance(a))
                - revenueAccounts
                .Where(a => a.NormalBalance.Equals("debit", StringComparison.OrdinalIgnoreCase))
                .Sum(a => GetAccountBalance(a));
            var cumulativeExpenses = expenseAccounts.Sum(a => GetAccountBalance(a));
            cumulativeNetIncome = cumulativeRevenue - cumulativeExpenses;

            // Calculate Income Statement totals (using period-specific balances)
            // Contra-revenue accounts (debit normal balance) reduce revenue
            totalRevenue = revenueAccounts
                .Where(a => a.NormalBalance.Equals("credit", StringComparison.OrdinalIgnoreCase))
                .Sum(a => GetIncomeAccountBalance(a))
                - revenueAccounts
                .Where(a => a.NormalBalance.Equals("debit", StringComparison.OrdinalIgnoreCase))
                .Sum(a => GetIncomeAccountBalance(a));
            totalExpenses = expenseAccounts.Sum(a => GetIncomeAccountBalance(a));
            netIncome = totalRevenue - totalExpenses;

            // Equity includes retained earnings (CUMULATIVE net income for Balance Sheet to balance)
            totalEquity = totalEquityAccounts + cumulativeNetIncome;
            totalLiabilitiesAndEquity = totalLiabilities + totalEquity;

            // Key ratios
            profitMargin = totalRevenue > 0 ? (netIncome / totalRevenue) * 100 : 0;
            expenseRatio = totalRevenue > 0 ? (totalExpenses / totalRevenue) * 100 : 0;

            transactionCount = await DbContext.JournalEntries
                .Where(j => j.Date >= incomeStartDate && j.Date <= incomeEndDate)
                .CountAsync();

            // Trial Balance totals (using cumulative balances)
            // Properly handle negative balances - they go to opposite column
            totalDebits = 0;
            totalCredits = 0;
            foreach (var account in allAccounts)
            {
                var balance = GetAccountBalance(account);
                var isDebitAccount = account.NormalBalance.Equals("debit", StringComparison.OrdinalIgnoreCase);
                
                // Positive balance goes to normal column, negative goes to opposite
                if ((isDebitAccount && balance > 0) || (!isDebitAccount && balance < 0))
                    totalDebits += Math.Abs(balance);
                else if ((!isDebitAccount && balance > 0) || (isDebitAccount && balance < 0))
                    totalCredits += Math.Abs(balance);
            }

            // Apply trial balance filter after balances are calculated
            ApplyTrialBalanceFilter();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading statements: {ex.Message}";
            Console.WriteLine(errorMessage);
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private decimal GetAccountBalance(LedgerAccount account)
    {
        return accountBalances.GetValueOrDefault(account.LedgerAccountId, 0);
    }

    private decimal GetIncomeAccountBalance(LedgerAccount account)
    {
        return incomeAccountBalances.GetValueOrDefault(account.LedgerAccountId, 0);
    }

    private bool IsCurrentAsset(string code)
    {
        // Current assets typically have codes starting with 1xxx-1199 or specific patterns
        if (int.TryParse(code, out int codeNum))
            return codeNum >= 1000 && codeNum < 1500;
        return true; // Default to current
    }

    private bool IsCurrentLiability(string code)
    {
        // Current liabilities typically have codes starting with 2xxx-2199
        if (int.TryParse(code, out int codeNum))
            return codeNum >= 2000 && codeNum < 2500;
        return true; // Default to current
    }

    private string GetAccountTypeBadge(string type) => type switch
    {
        "asset" => "badge-info",
        "liability" => "badge-warning",
        "equity" => "badge-success",
        "revenue" => "badge-primary",
        "expense" => "badge-danger",
        _ => "badge-secondary"
    };

    private async Task PrintStatement()
    {
        var containerId = activeTab switch
        {
            "balance" => "balanceSheetContainer",
            "income" => "incomeStatementContainer",
            "trial" => "trialBalanceContainer",
            _ => "balanceSheetContainer"
        };

        var title = activeTab switch
        {
            "balance" => "Balance Sheet",
            "income" => "Income Statement",
            "trial" => "Trial Balance",
            _ => "Financial Statement"
        };

        await JS.InvokeVoidAsync("exportUtils.printElement", containerId, $"Kaye Spa - {title}");
    }

    private async Task ExportToPdf()
    {
        isExporting = true;
        StateHasChanged();

        try
        {
            byte[] pdfBytes;
            string filename;

            switch (activeTab)
            {
                case "balance":
                    // Prepare Balance Sheet data
                    var bsAssets = assetAccounts.Select(a => new AccountBalance
                    {
                        Code = a.Code,
                        Name = a.Name,
                        Balance = GetAccountBalance(a)
                    }).Where(a => a.Balance != 0).ToList();

                    var bsLiabilities = liabilityAccounts.Select(a => new AccountBalance
                    {
                        Code = a.Code,
                        Name = a.Name,
                        Balance = GetAccountBalance(a)
                    }).Where(a => a.Balance != 0).ToList();

                    var bsEquity = equityAccounts.Select(a => new AccountBalance
                    {
                        Code = a.Code,
                        Name = a.Name,
                        Balance = GetAccountBalance(a)
                    }).ToList();
                    
                    // Add retained earnings (cumulative for Balance Sheet)
                    bsEquity.Add(new AccountBalance
                    {
                        Code = "RE",
                        Name = "Retained Earnings (Cumulative)",
                        Balance = cumulativeNetIncome
                    });

                    pdfBytes = PdfService.GenerateBalanceSheet(
                        incomeEndDate,
                        bsAssets,
                        bsLiabilities,
                        bsEquity,
                        totalAssets,
                        totalLiabilities,
                        totalEquity,
                        AuthState.CurrentUser?.Username ?? "");
                    filename = $"BalanceSheet_{incomeEndDate:yyyyMMdd}.pdf";
                    break;

                case "income":
                    // Prepare Income Statement data
                    var isRevenues = revenueAccounts.Select(a => new AccountBalance
                    {
                        Code = a.Code,
                        Name = a.Name,
                        Balance = GetIncomeAccountBalance(a)
                    }).Where(a => a.Balance != 0).ToList();

                    var isExpenses = expenseAccounts.Select(a => new AccountBalance
                    {
                        Code = a.Code,
                        Name = a.Name,
                        Balance = GetIncomeAccountBalance(a)
                    }).Where(a => a.Balance != 0).ToList();

                    pdfBytes = PdfService.GenerateIncomeStatement(
                        incomeStartDate,
                        incomeEndDate,
                        isRevenues,
                        isExpenses,
                        totalRevenue,
                        totalExpenses,
                        netIncome,
                        AuthState.CurrentUser?.Username ?? "");
                    filename = $"IncomeStatement_{incomeStartDate:yyyyMMdd}_{incomeEndDate:yyyyMMdd}.pdf";
                    break;

                case "trial":
                default:
                    // Prepare Trial Balance data
                    var tbEntries = allAccounts.Select(a =>
                    {
                        var balance = GetAccountBalance(a);
                        var isDebit = a.NormalBalance.Equals("debit", StringComparison.OrdinalIgnoreCase);
                        return new TrialBalanceEntry
                        {
                            Code = a.Code,
                            AccountName = a.Name,
                            Debit = isDebit ? Math.Abs(balance) : 0,
                            Credit = !isDebit ? Math.Abs(balance) : 0
                        };
                    }).Where(e => e.Debit != 0 || e.Credit != 0).ToList();

                    pdfBytes = PdfService.GenerateTrialBalance(
                        incomeEndDate,
                        tbEntries,
                        totalDebits,
                        totalCredits,
                        AuthState.CurrentUser?.Username ?? "");
                    filename = $"TrialBalance_{incomeEndDate:yyyyMMdd}.pdf";
                    break;
            }

            // Download the PDF file
            await DownloadPdfAsync(pdfBytes, filename);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"PDF Export Error: {ex.Message}");
            errorMessage = "Failed to export PDF. Please try again.";
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    private async Task DownloadPdfAsync(byte[] pdfBytes, string filename)
    {
        // Convert to base64 and trigger download via JavaScript
        var base64 = Convert.ToBase64String(pdfBytes);
        await JS.InvokeVoidAsync("downloadFile", filename, "application/pdf", base64);
    }

    // Trial Balance filtering and pagination methods
    private void ApplyTrialBalanceFilter()
    {
        var filtered = allAccounts.AsEnumerable();

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(trialBalanceSearchTerm))
        {
            var term = trialBalanceSearchTerm.ToLower();
            filtered = filtered.Where(a =>
                (a.Code?.ToLower().Contains(term) ?? false) ||
                (a.Name?.ToLower().Contains(term) ?? false));
        }

        // Apply type filter
        filtered = trialBalanceFilterMode switch
        {
            "withBalance" => filtered.Where(a => GetAccountBalance(a) != 0),
            "asset" => filtered.Where(a => a.AccountType.Equals("asset", StringComparison.OrdinalIgnoreCase)),
            "liability" => filtered.Where(a => a.AccountType.Equals("liability", StringComparison.OrdinalIgnoreCase)),
            "equity" => filtered.Where(a => a.AccountType.Equals("equity", StringComparison.OrdinalIgnoreCase)),
            "revenue" => filtered.Where(a => a.AccountType.Equals("revenue", StringComparison.OrdinalIgnoreCase)),
            "expense" => filtered.Where(a => a.AccountType.Equals("expense", StringComparison.OrdinalIgnoreCase)),
            _ => filtered
        };

        // Apply sorting
        filtered = trialBalanceSortColumn switch
        {
            "code" => trialBalanceSortAscending ? filtered.OrderBy(a => a.Code) : filtered.OrderByDescending(a => a.Code),
            "name" => trialBalanceSortAscending ? filtered.OrderBy(a => a.Name) : filtered.OrderByDescending(a => a.Name),
            "type" => trialBalanceSortAscending ? filtered.OrderBy(a => a.AccountType) : filtered.OrderByDescending(a => a.AccountType),
            "debit" => trialBalanceSortAscending 
                ? filtered.OrderBy(a => a.NormalBalance.Equals("debit", StringComparison.OrdinalIgnoreCase) ? GetAccountBalance(a) : 0)
                : filtered.OrderByDescending(a => a.NormalBalance.Equals("debit", StringComparison.OrdinalIgnoreCase) ? GetAccountBalance(a) : 0),
            "credit" => trialBalanceSortAscending 
                ? filtered.OrderBy(a => !a.NormalBalance.Equals("debit", StringComparison.OrdinalIgnoreCase) ? GetAccountBalance(a) : 0)
                : filtered.OrderByDescending(a => !a.NormalBalance.Equals("debit", StringComparison.OrdinalIgnoreCase) ? GetAccountBalance(a) : 0),
            _ => filtered.OrderBy(a => a.Code)
        };

        filteredTrialBalanceAccounts = filtered.ToList();
        trialBalanceCurrentPage = 1; // Reset to first page when filter changes
    }

    private void SortTrialBalanceBy(string column)
    {
        if (trialBalanceSortColumn == column)
        {
            trialBalanceSortAscending = !trialBalanceSortAscending;
        }
        else
        {
            trialBalanceSortColumn = column;
            trialBalanceSortAscending = true;
        }
        ApplyTrialBalanceFilter();
    }

    private string GetTrialBalanceSortIcon(string column)
    {
        if (trialBalanceSortColumn != column) return "";
        return trialBalanceSortAscending ? "↑" : "↓";
    }

    private List<LedgerAccount> GetPagedTrialBalanceAccounts()
    {
        return filteredTrialBalanceAccounts
            .Skip((trialBalanceCurrentPage - 1) * trialBalancePageSize)
            .Take(trialBalancePageSize)
            .ToList();
    }

    private void TrialBalanceGoToPage(int page) => trialBalanceCurrentPage = page;
    private void TrialBalancePreviousPage() { if (trialBalanceCurrentPage > 1) trialBalanceCurrentPage--; }
    private void TrialBalanceNextPage() { if (trialBalanceCurrentPage < TrialBalanceTotalPages) trialBalanceCurrentPage++; }

    private IEnumerable<int> GetTrialBalancePageNumbers()
    {
        var totalPages = TrialBalanceTotalPages;
        var current = trialBalanceCurrentPage;
        var pages = new List<int>();

        if (totalPages <= 7)
        {
            // Show all pages if 7 or fewer
            for (int i = 1; i <= totalPages; i++)
                pages.Add(i);
        }
        else
        {
            // Always show first page
            pages.Add(1);

            if (current > 3)
                pages.Add(-1); // Ellipsis

            // Show pages around current
            for (int i = Math.Max(2, current - 1); i <= Math.Min(totalPages - 1, current + 1); i++)
                pages.Add(i);

            if (current < totalPages - 2)
                pages.Add(-1); // Ellipsis

            // Always show last page
            pages.Add(totalPages);
        }

        return pages;
    }
}
