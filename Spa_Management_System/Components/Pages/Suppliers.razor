@page "/suppliers"
@using Microsoft.EntityFrameworkCore
@using Spa_Management_System.Data
@using Spa_Management_System.Services
@using Spa_Management_System.Models
@inject IAuthStateService AuthState
@inject NavigationManager Navigation
@inject AppDbContext DbContext

<PageTitle>Suppliers - Kaye Spa</PageTitle>

@if (!AuthState.IsAuthenticated)
{
    Navigation.NavigateTo("/login");
}
else
{
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
                <h3 class="card-title" style="margin: 0;"><span class="bi bi-truck"></span> Supplier Management</h3>
                <p style="color: var(--spa-text-light); margin: 0.5rem 0 0 0;">Manage your vendor relationships</p>
            </div>
            <button class="btn btn-primary" @onclick="OpenAddDialog">
                <span class="bi bi-plus-circle"></span> Add Supplier
            </button>
        </div>

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">
                <span class="bi bi-check-circle-fill"></span>
                <div>@successMessage</div>
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">
                <span class="bi bi-exclamation-triangle-fill"></span>
                <div>@errorMessage</div>
            </div>
        }

        <div style="margin-bottom: 1rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500;">
                <input type="checkbox" @bind="showArchived" @bind:after="LoadSuppliers" />
                <span class="bi bi-archive"></span> Show Archived Suppliers
            </label>
        </div>

        @if (isLoading)
        {
            <div style="display: flex; align-items: center; gap: 1rem; padding: 2rem;">
                <div class="loading"></div>
                <p style="margin: 0;">Loading suppliers...</p>
            </div>
        }
        else if (!suppliers.Any())
        {
            <div class="alert alert-info">
                <span class="bi bi-info-circle-fill"></span>
                <div>
                    <strong>No Suppliers Yet</strong><br />
                    Add suppliers to track your vendors and manage purchase orders.
                </div>
            </div>
        }
        else
        {
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.25rem;">
                @foreach (var supplier in suppliers)
                {
                    <div style="padding: 1.25rem; border: 2px solid @(supplier.IsArchived ? "var(--spa-text-light)" : "var(--spa-secondary)"); border-radius: 12px; @(supplier.IsArchived ? "opacity: 0.7; background: #f5f5f5;" : "") display: flex; flex-direction: column;">
                        <div style="margin-bottom: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h5 style="color: var(--spa-primary); margin: 0; font-size: 1.1rem;">@supplier.Name</h5>
                                @if (supplier.IsArchived)
                                {
                                    <span class="badge" style="background: var(--spa-text-light); font-size: 0.7rem;">Archived</span>
                                }
                            </div>
                        </div>
                        
                        <div style="display: grid; gap: 0.4rem; margin-bottom: 0.75rem; flex: 1;">
                            @if (!string.IsNullOrEmpty(supplier.ContactPerson))
                            {
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <span class="bi bi-person" style="color: var(--spa-accent); font-size: 0.85rem;"></span>
                                    <span style="font-size: 0.85rem;">@supplier.ContactPerson</span>
                                </div>
                            }
                            
                            @if (!string.IsNullOrEmpty(supplier.Phone))
                            {
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <span class="bi bi-telephone" style="color: var(--spa-accent); font-size: 0.85rem;"></span>
                                    <span style="font-size: 0.85rem;">@supplier.Phone</span>
                                </div>
                            }
                            
                            @if (!string.IsNullOrEmpty(supplier.Email))
                            {
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <span class="bi bi-envelope" style="color: var(--spa-accent); font-size: 0.85rem;"></span>
                                    <span style="font-size: 0.85rem; word-break: break-all;">@supplier.Email</span>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(supplier.Address))
                            {
                                <div style="display: flex; gap: 0.5rem; align-items: start;">
                                    <span class="bi bi-geo-alt" style="color: var(--spa-accent); font-size: 0.85rem;"></span>
                                    <span style="font-size: 0.85rem;">@supplier.Address</span>
                                </div>
                            }
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 0.5rem; padding-top: 0.75rem; border-top: 1px solid var(--spa-secondary);">
                            @if (!supplier.IsArchived)
                            {
                                <button class="btn btn-sm btn-info" @onclick="() => OpenManageProductsDialog(supplier)" style="padding: 0.5rem;">
                                    <span class="bi bi-box-seam"></span> Manage Products (@GetSupplierProductCount(supplier.SupplierId))
                                </button>
                            }
                            <div style="display: flex; gap: 0.5rem;">
                                @if (supplier.IsArchived)
                                {
                                    <button class="btn btn-sm btn-success" @onclick="() => RestoreSupplier(supplier.SupplierId)" style="flex: 1; padding: 0.5rem;">
                                        <span class="bi bi-arrow-counterclockwise"></span> Restore
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-light" @onclick="() => OpenEditDialog(supplier)" style="flex: 1; padding: 0.5rem;">
                                        <span class="bi bi-pencil"></span> Edit
                                    </button>
                                    <button class="btn btn-sm btn-warning" @onclick="() => ConfirmArchiveSupplier(supplier.SupplierId)" style="flex: 1; padding: 0.5rem;">
                                        <span class="bi bi-archive"></span> Archive
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    @if (showDialog)
    {
        <div class="modal-overlay" @onclick="CloseDialog">
            <div class="modal-content" @onclick:stopPropagation="true" style="max-width: 600px;">
                <div class="modal-header">
                    <h4 style="margin: 0; color: var(--spa-primary);">
                        @(isEditMode ? "Edit Supplier" : "Add New Supplier")
                    </h4>
                    <button class="btn-close" @onclick="CloseDialog">
                        <span class="bi bi-x-lg"></span>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="form-group">
                        <label>Supplier Name *</label>
                        <input type="text" class="form-control" @bind="currentSupplier.Name" 
                               placeholder="e.g., Beauty Products Inc." maxlength="200" />
                    </div>

                    <div class="form-group">
                        <label>Contact Person</label>
                        <input type="text" class="form-control" @bind="currentSupplier.ContactPerson" 
                               placeholder="Name of contact person" maxlength="200" />
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" class="form-control" @bind="currentSupplier.Phone" 
                                   placeholder="Contact number" maxlength="50" />
                        </div>

                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" @bind="currentSupplier.Email" 
                                   placeholder="email@example.com" maxlength="150" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Address</label>
                        <textarea class="form-control" @bind="currentSupplier.Address" 
                                  rows="2" placeholder="Full address"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseDialog">
                        <span class="bi bi-x-circle"></span> Cancel
                    </button>
                    <button class="btn btn-primary" @onclick="SaveSupplier" 
                            disabled="@(string.IsNullOrWhiteSpace(currentSupplier.Name))">
                        <span class="bi bi-check-circle"></span> @(isEditMode ? "Update" : "Create")
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Archive Confirmation Dialog -->
    @if (showArchiveConfirm)
    {
        <div class="modal-overlay" @onclick="CancelArchive">
            <div class="modal-content" @onclick:stopPropagation="true" style="max-width: 400px;">
                <div class="modal-header" style="background: var(--spa-warning); color: white;">
                    <h4 style="margin: 0;"><span class="bi bi-archive"></span> Confirm Archive</h4>
                </div>
                <div class="modal-body" style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;"><span class="bi bi-archive"></span></div>
                    <p style="font-size: 1.1rem;">Are you sure you want to archive this supplier?</p>
                    <p style="color: var(--spa-text-light);">Archived suppliers can be restored later if needed.</p>
                </div>
                <div class="modal-footer" style="justify-content: center; gap: 1rem;">
                    <button class="btn btn-secondary" @onclick="CancelArchive">
                        <span class="bi bi-x-circle"></span> Cancel
                    </button>
                    <button class="btn btn-warning" @onclick="ArchiveSupplier">
                        <span class="bi bi-archive"></span> Yes, Archive
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Manage Products Dialog -->
    @if (showManageProductsDialog && managingSupplier != null)
    {
        <div class="modal-overlay" @onclick="CloseManageProductsDialog">
            <div class="modal-content" @onclick:stopPropagation="true" style="max-width: 800px; max-height: 85vh; display: flex; flex-direction: column;">
                <div class="modal-header">
                    <h4 style="margin: 0; color: var(--spa-primary);">
                        <span class="bi bi-box-seam"></span> Products Supplied by @managingSupplier.Name
                    </h4>
                    <button class="btn-close" @onclick="CloseManageProductsDialog">
                        <span class="bi bi-x-lg"></span>
                    </button>
                </div>

                <div class="modal-body" style="flex: 1; overflow-y: auto;">
                    <!-- Add Product Section -->
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <h5 style="margin: 0 0 1rem 0; color: var(--spa-primary);"><span class="bi bi-plus-circle"></span> Add Product to Supplier</h5>
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 0.75rem; align-items: end;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.85rem;">Product</label>
                                <select class="form-control" @bind="selectedProductToAdd">
                                    <option value="0">-- Select Product --</option>
                                    @foreach (var product in availableProducts)
                                    {
                                        <option value="@product.ProductId">@product.Name (@product.Sku)</option>
                                    }
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.85rem;">Supplier Price (₱)</label>
                                <input type="number" class="form-control" @bind="newSupplierPrice" step="0.01" min="0" placeholder="0.00" />
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.85rem;">Supplier SKU</label>
                                <input type="text" class="form-control" @bind="newSupplierSku" placeholder="Optional" />
                            </div>
                            <button class="btn btn-primary" @onclick="AddProductToSupplier" disabled="@(selectedProductToAdd == 0)" style="height: 38px;">
                                <span class="bi bi-plus"></span> Add
                            </button>
                        </div>
                        @if (availableProducts.Count == 0)
                        {
                            <div class="alert alert-info" style="margin-top: 1rem; margin-bottom: 0;">
                                <span class="bi bi-info-circle"></span> All active products are already assigned to this supplier.
                            </div>
                        }
                    </div>

                    <!-- Current Products List -->
                    <h5 style="color: var(--spa-primary); margin-bottom: 1rem;"><span class="bi bi-list-check"></span> Assigned Products (@supplierProducts.Count)</h5>
                    
                    @if (!supplierProducts.Any())
                    {
                        <div class="alert alert-info">
                            <span class="bi bi-info-circle"></span> No products assigned to this supplier yet. Add products above.
                        </div>
                    }
                    else
                    {
                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Supplier SKU</th>
                                        <th style="text-align: right;">Supplier Price</th>
                                        <th style="text-align: center;">Preferred</th>
                                        <th style="text-align: center;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var sp in supplierProducts)
                                    {
                                        <tr>
                                            <td>
                                                <strong>@sp.Product?.Name</strong>
                                                <br /><small style="color: var(--spa-text-light);">@sp.Product?.Sku</small>
                                            </td>
                                            <td>@(sp.SupplierSku ?? "-")</td>
                                            <td style="text-align: right;">
                                                @if (editingSupplierProductId == sp.SupplierProductId)
                                                {
                                                    <input type="number" class="form-control form-control-sm" @bind="editSupplierPrice" step="0.01" style="width: 100px; display: inline-block;" />
                                                }
                                                else
                                                {
                                                    <strong>₱@sp.SupplierPrice.ToString("N2")</strong>
                                                }
                                            </td>
                                            <td style="text-align: center;">
                                                @if (sp.IsPreferred)
                                                {
                                                    <span class="badge badge-success"><span class="bi bi-star-fill"></span> Preferred</span>
                                                }
                                                else
                                                {
                                                    <button class="btn btn-sm btn-light" @onclick="() => SetPreferred(sp)">
                                                        <span class="bi bi-star"></span>
                                                    </button>
                                                }
                                            </td>
                                            <td style="text-align: center;">
                                                @if (editingSupplierProductId == sp.SupplierProductId)
                                                {
                                                    <button class="btn btn-sm btn-success" @onclick="SaveEditSupplierProduct">
                                                        <span class="bi bi-check"></span>
                                                    </button>
                                                    <button class="btn btn-sm btn-secondary" @onclick="CancelEditSupplierProduct">
                                                        <span class="bi bi-x"></span>
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button class="btn btn-sm btn-light" @onclick="() => StartEditSupplierProduct(sp)">
                                                        <span class="bi bi-pencil"></span>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" @onclick="() => RemoveProductFromSupplier(sp)">
                                                        <span class="bi bi-trash"></span>
                                                    </button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseManageProductsDialog">
                        <span class="bi bi-x-circle"></span> Close
                    </button>
                </div>
            </div>
        </div>
    }
}

@code {
    private List<Supplier> suppliers = new();
    private Supplier currentSupplier = new();
    private bool isLoading = true;
    private bool showDialog = false;
    private bool isEditMode = false;
    private bool showArchived = false;
    private string? successMessage;
    private string? errorMessage;
    private Dictionary<long, int> supplierProductCounts = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadSuppliers();
    }

    private async Task LoadSuppliers()
    {
        isLoading = true;

        try
        {
            if (showArchived)
            {
                suppliers = await DbContext.Suppliers
                    .OrderBy(s => s.IsArchived)
                    .ThenBy(s => s.Name)
                    .ToListAsync();
            }
            else
            {
                suppliers = await DbContext.Suppliers
                    .Where(s => !s.IsArchived)
                    .OrderBy(s => s.Name)
                    .ToListAsync();
            }

            // Pre-load product counts to avoid DbContext threading issues
            supplierProductCounts = await DbContext.SupplierProducts
                .Where(sp => sp.IsActive)
                .GroupBy(sp => sp.SupplierId)
                .Select(g => new { SupplierId = g.Key, Count = g.Count() })
                .ToDictionaryAsync(x => x.SupplierId, x => x.Count);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading suppliers: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenAddDialog()
    {
        currentSupplier = new Supplier();
        isEditMode = false;
        showDialog = true;
        ClearMessages();
    }

    private void OpenEditDialog(Supplier supplier)
    {
        currentSupplier = new Supplier
        {
            SupplierId = supplier.SupplierId,
            Name = supplier.Name,
            ContactPerson = supplier.ContactPerson,
            Phone = supplier.Phone,
            Email = supplier.Email,
            Address = supplier.Address
        };
        isEditMode = true;
        showDialog = true;
        ClearMessages();
    }

    private void CloseDialog()
    {
        showDialog = false;
        currentSupplier = new();
        isEditMode = false;
    }

    private async Task SaveSupplier()
    {
        try
        {
            ClearMessages();

            if (string.IsNullOrWhiteSpace(currentSupplier.Name))
            {
                errorMessage = "Supplier name is required.";
                return;
            }

            if (isEditMode)
            {
                var existing = await DbContext.Suppliers.FindAsync(currentSupplier.SupplierId);
                if (existing != null)
                {
                    existing.Name = currentSupplier.Name.Trim();
                    existing.ContactPerson = currentSupplier.ContactPerson?.Trim();
                    existing.Phone = currentSupplier.Phone?.Trim();
                    existing.Email = currentSupplier.Email?.Trim();
                    existing.Address = currentSupplier.Address?.Trim();
                    await DbContext.SaveChangesAsync();
                    successMessage = "Supplier updated successfully!";
                }
            }
            else
            {
                var newSupplier = new Supplier
                {
                    Name = currentSupplier.Name.Trim(),
                    ContactPerson = currentSupplier.ContactPerson?.Trim(),
                    Phone = currentSupplier.Phone?.Trim(),
                    Email = currentSupplier.Email?.Trim(),
                    Address = currentSupplier.Address?.Trim()
                };
                DbContext.Suppliers.Add(newSupplier);
                await DbContext.SaveChangesAsync();
                successMessage = "Supplier created successfully!";
            }

            CloseDialog();
            await LoadSuppliers();
            _ = AutoDismissSuccess();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving supplier: {ex.Message}";
        }
    }

    private long? archiveSupplierId = null;
    private bool showArchiveConfirm = false;

    private void ConfirmArchiveSupplier(long supplierId)
    {
        archiveSupplierId = supplierId;
        showArchiveConfirm = true;
    }

    private void CancelArchive()
    {
        archiveSupplierId = null;
        showArchiveConfirm = false;
    }

    private async Task ArchiveSupplier()
    {
        if (archiveSupplierId == null) return;
        
        try
        {
            ClearMessages();
            var supplier = await DbContext.Suppliers.FindAsync(archiveSupplierId.Value);
            if (supplier == null)
            {
                errorMessage = "Supplier not found.";
                return;
            }

            supplier.IsArchived = true;
            await DbContext.SaveChangesAsync();
            successMessage = "Supplier archived successfully!";
            showArchiveConfirm = false;
            archiveSupplierId = null;
            await LoadSuppliers();
            _ = AutoDismissSuccess();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error archiving supplier: {ex.Message}";
        }
    }

    private async Task RestoreSupplier(long supplierId)
    {
        try
        {
            ClearMessages();
            var supplier = await DbContext.Suppliers.FindAsync(supplierId);
            if (supplier == null)
            {
                errorMessage = "Supplier not found.";
                return;
            }

            supplier.IsArchived = false;
            await DbContext.SaveChangesAsync();
            successMessage = "Supplier restored successfully!";
            await LoadSuppliers();
            _ = AutoDismissSuccess();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error restoring supplier: {ex.Message}";
        }
    }

    private async Task AutoDismissSuccess()
    {
        await Task.Delay(3000);
        await InvokeAsync(() =>
        {
            successMessage = null;
            StateHasChanged();
        });
    }

    private void ClearMessages()
    {
        successMessage = null;
        errorMessage = null;
    }

    // Manage Products functionality
    private bool showManageProductsDialog = false;
    private Supplier? managingSupplier = null;
    private List<SupplierProduct> supplierProducts = new();
    private List<Product> allProducts = new();
    private List<Product> availableProducts = new();
    private long selectedProductToAdd = 0;
    private decimal newSupplierPrice = 0;
    private string newSupplierSku = "";
    private long? editingSupplierProductId = null;
    private decimal editSupplierPrice = 0;

    private int GetSupplierProductCount(long supplierId)
    {
        return supplierProductCounts.TryGetValue(supplierId, out var count) ? count : 0;
    }

    private async Task RefreshSupplierProductCounts()
    {
        supplierProductCounts = await DbContext.SupplierProducts
            .Where(sp => sp.IsActive)
            .GroupBy(sp => sp.SupplierId)
            .Select(g => new { SupplierId = g.Key, Count = g.Count() })
            .ToDictionaryAsync(x => x.SupplierId, x => x.Count);
    }

    private async Task OpenManageProductsDialog(Supplier supplier)
    {
        managingSupplier = supplier;
        await LoadSupplierProducts();
        showManageProductsDialog = true;
    }

    private void CloseManageProductsDialog()
    {
        showManageProductsDialog = false;
        managingSupplier = null;
        supplierProducts = new();
        availableProducts = new();
        selectedProductToAdd = 0;
        newSupplierPrice = 0;
        newSupplierSku = "";
        editingSupplierProductId = null;
    }

    private async Task LoadSupplierProducts()
    {
        if (managingSupplier == null) return;

        // Load products assigned to this supplier
        supplierProducts = await DbContext.SupplierProducts
            .Include(sp => sp.Product)
            .Where(sp => sp.SupplierId == managingSupplier.SupplierId && sp.IsActive)
            .OrderBy(sp => sp.Product!.Name)
            .ToListAsync();

        // Load all active products
        allProducts = await DbContext.Products
            .Where(p => p.Active)
            .OrderBy(p => p.Name)
            .ToListAsync();

        // Get products not yet assigned to this supplier
        var assignedProductIds = supplierProducts.Select(sp => sp.ProductId).ToHashSet();
        availableProducts = allProducts.Where(p => !assignedProductIds.Contains(p.ProductId)).ToList();
    }

    private async Task AddProductToSupplier()
    {
        if (managingSupplier == null || selectedProductToAdd == 0) return;

        try
        {
            var product = allProducts.FirstOrDefault(p => p.ProductId == selectedProductToAdd);
            if (product == null) return;

            // Check if relationship already exists (maybe inactive)
            var existing = await DbContext.SupplierProducts
                .FirstOrDefaultAsync(sp => sp.SupplierId == managingSupplier.SupplierId && sp.ProductId == selectedProductToAdd);

            if (existing != null)
            {
                // Reactivate and update
                existing.IsActive = true;
                existing.SupplierPrice = newSupplierPrice > 0 ? newSupplierPrice : product.CostPrice;
                existing.SupplierSku = string.IsNullOrWhiteSpace(newSupplierSku) ? null : newSupplierSku.Trim();
                existing.LastModifiedAt = DateTime.Now;
            }
            else
            {
                // Create new relationship
                var supplierProduct = new SupplierProduct
                {
                    SupplierId = managingSupplier.SupplierId,
                    ProductId = selectedProductToAdd,
                    SupplierPrice = newSupplierPrice > 0 ? newSupplierPrice : product.CostPrice,
                    SupplierSku = string.IsNullOrWhiteSpace(newSupplierSku) ? null : newSupplierSku.Trim(),
                    IsActive = true,
                    CreatedAt = DateTime.Now
                };
                DbContext.SupplierProducts.Add(supplierProduct);
            }

            await DbContext.SaveChangesAsync();
            
            // Reset form
            selectedProductToAdd = 0;
            newSupplierPrice = 0;
            newSupplierSku = "";
            
            await LoadSupplierProducts();
            await RefreshSupplierProductCounts();
            successMessage = $"Product added to {managingSupplier.Name}!";
            _ = AutoDismissSuccess();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error adding product: {ex.Message}";
        }
    }

    private async Task RemoveProductFromSupplier(SupplierProduct sp)
    {
        try
        {
            sp.IsActive = false;
            sp.LastModifiedAt = DateTime.Now;
            await DbContext.SaveChangesAsync();
            await LoadSupplierProducts();
            await RefreshSupplierProductCounts();
            successMessage = "Product removed from supplier.";
            _ = AutoDismissSuccess();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error removing product: {ex.Message}";
        }
    }

    private void StartEditSupplierProduct(SupplierProduct sp)
    {
        editingSupplierProductId = sp.SupplierProductId;
        editSupplierPrice = sp.SupplierPrice;
    }

    private void CancelEditSupplierProduct()
    {
        editingSupplierProductId = null;
        editSupplierPrice = 0;
    }

    private async Task SaveEditSupplierProduct()
    {
        if (editingSupplierProductId == null) return;

        try
        {
            var sp = await DbContext.SupplierProducts.FindAsync(editingSupplierProductId.Value);
            if (sp != null)
            {
                sp.SupplierPrice = editSupplierPrice;
                sp.LastModifiedAt = DateTime.Now;
                await DbContext.SaveChangesAsync();
                await LoadSupplierProducts();
                successMessage = "Price updated!";
                _ = AutoDismissSuccess();
            }
            editingSupplierProductId = null;
            editSupplierPrice = 0;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error updating price: {ex.Message}";
        }
    }

    private async Task SetPreferred(SupplierProduct sp)
    {
        try
        {
            // Remove preferred status from other suppliers for this product
            var otherPreferred = await DbContext.SupplierProducts
                .Where(x => x.ProductId == sp.ProductId && x.IsPreferred)
                .ToListAsync();
            
            foreach (var other in otherPreferred)
            {
                other.IsPreferred = false;
            }

            // Set this one as preferred
            sp.IsPreferred = true;
            sp.LastModifiedAt = DateTime.Now;
            await DbContext.SaveChangesAsync();
            await LoadSupplierProducts();
            successMessage = "Set as preferred supplier for this product!";
            _ = AutoDismissSuccess();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error setting preferred: {ex.Message}";
        }
    }
}
