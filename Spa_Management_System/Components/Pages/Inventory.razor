@page "/inventory"
@using Spa_Management_System.Services
@using Spa_Management_System.Data
@using Spa_Management_System.Models
@using Microsoft.EntityFrameworkCore
@inject IAuthStateService AuthState
@inject NavigationManager Navigation
@inject IDbContextFactory<AppDbContext> DbContextFactory
@inject IJSRuntime JSRuntime

<PageTitle>Inventory</PageTitle>

@if (!AuthState.IsAuthenticated)
{
    Navigation.NavigateTo("/login");
}
else
{
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
                <h3 class="card-title" style="margin: 0;"><span class="bi bi-box-seam"></span> Stock Management</h3>
                <p style="color: var(--spa-text-light); margin: 0.5rem 0 0 0;">Monitor and manage inventory stock levels</p>
            </div>
            <button class="btn btn-primary" @onclick="OpenAddDialog">
                <span class="bi bi-plus-circle"></span> Set Initial Stock
            </button>
        </div>

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">
                <span class="bi bi-check-circle-fill"></span>
                <div>@successMessage</div>
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">
                <span class="bi bi-exclamation-triangle-fill"></span>
                <div>@errorMessage</div>
            </div>
        }

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Filter by Stock Status:</label>
            <select class="form-control" @onchange="OnStockFilterChanged" style="max-width: 250px;">
                <option value="">All Items</option>
                <option value="low">Low Stock (≤ Reorder Level)</option>
                <option value="out">Out of Stock</option>
                <option value="ok">In Stock</option>
            </select>
        </div>

        @if (isLoading)
        {
            <div style="padding: 2rem; text-align: center;">
                <div class="loading"></div>
                <p style="margin-top: 1rem; color: var(--spa-text-light);">Loading inventory...</p>
            </div>
        }
        else if (!filteredInventory.Any())
        {
            <div class="alert alert-info">
                <span class="bi bi-info-circle-fill"></span>
                <div>
                    <strong>No Inventory Records</strong><br />
                    @if (!products.Any())
                    {
                        <span>Please create products first, then set their initial stock levels.</span>
                        <br />
                        <button class="btn btn-sm btn-primary" style="margin-top: 0.5rem;" @onclick='() => Navigation.NavigateTo("/products")'>
                            Go to Products
                        </button>
                    }
                    else
                    {
                        <span>Set initial stock levels for your products.</span>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="table-search">
                <input type="text" placeholder="Search products..." @bind="searchTerm" @bind:event="oninput" @bind:after="ApplyFilter" />
            </div>

            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" @onclick='() => SortBy("product")'>Product @GetSortIcon("product")</th>
                            <th style="cursor: pointer;" @onclick='() => SortBy("sku")'>SKU @GetSortIcon("sku")</th>
                            <th style="cursor: pointer;" @onclick='() => SortBy("stock")'>Current Stock @GetSortIcon("stock")</th>
                            <th style="cursor: pointer;" @onclick='() => SortBy("reorder")'>Reorder Level @GetSortIcon("reorder")</th>
                            <th style="cursor: pointer;" @onclick='() => SortBy("lastcounted")'>Last Counted @GetSortIcon("lastcounted")</th>
                            <th style="cursor: pointer;" @onclick='() => SortBy("status")'>Status @GetSortIcon("status")</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var inv in GetPagedInventory())
                        {
                            var stockStatus = GetStockStatus(inv);
                            <tr>
                                <td><strong>@inv.Product?.Name</strong></td>
                                <td><code>@inv.Product?.Sku</code></td>
                                <td>
                                    <strong style="font-size: 1.1rem;">@((int)inv.QuantityOnHand)</strong>
                                    @if (!string.IsNullOrEmpty(inv.Product?.Unit))
                                    {
                                        <span style="color: var(--spa-text-light); margin-left: 4px;">@inv.Product.Unit</span>
                                    }
                                </td>
                                <td>@((int)inv.ReorderLevel)</td>
                                <td>@(inv.LastCountedAt?.ToString("MMM dd, yyyy") ?? "Never")</td>
                                <td>
                                    @if (stockStatus == "out")
                                    {
                                        <span class="badge badge-danger">Out of Stock</span>
                                    }
                                    else if (stockStatus == "low")
                                    {
                                        <span class="badge" style="background: #ffc107; color: #000;">Low Stock</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-success">In Stock</span>
                                    }
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-light" @onclick="() => OpenEditDialog(inv)">
                                            Edit
                                        </button>
                                        <button class="btn btn-sm btn-info" @onclick="() => OpenAdjustDialog(inv)">
                                            Adjust
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="table-pagination">
                <span>Showing @(Math.Min((currentPage - 1) * pageSize + 1, filteredInventory.Count))-@(Math.Min(currentPage * pageSize, filteredInventory.Count)) of @filteredInventory.Count entries</span>
                <div class="pagination-buttons">
                    <button class="btn btn-sm btn-light" disabled="@(currentPage <= 1)" @onclick="PreviousPage">Previous</button>
                    @for (int i = 1; i <= TotalPages; i++)
                    {
                        var pageNum = i;
                        <button class="btn btn-sm @(pageNum == currentPage ? "btn-primary" : "btn-light")" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                    }
                    <button class="btn btn-sm btn-light" disabled="@(currentPage >= TotalPages)" @onclick="NextPage">Next</button>
                </div>
            </div>

            <div style="margin-top: 1rem;">
                <div style="display: flex; gap: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <div>
                        <strong>Total Items:</strong> @filteredInventory.Count
                    </div>
                    <div>
                        <strong style="color: #dc3545;">Out of Stock:</strong> @filteredInventory.Count(i => i.QuantityOnHand <= 0)
                    </div>
                    <div>
                        <strong style="color: #ffc107;">Low Stock:</strong> @filteredInventory.Count(i => i.QuantityOnHand > 0 && i.QuantityOnHand <= i.ReorderLevel)
                    </div>
                </div>
            </div>
        }
    </div>

    @if (showDialog)
    {
        <div class="modal-overlay" @onclick="CloseDialog">
            <div class="modal-content" @onclick:stopPropagation="true" style="max-width: 600px;">
                <div class="modal-header">
                    <h4 style="margin: 0; color: var(--spa-primary);">
                        @(isEditMode ? "Update Inventory Settings" : "Set Initial Stock")
                    </h4>
                    <button class="btn-close" @onclick="CloseDialog">
                        <span class="bi bi-x-lg"></span>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="form-group">
                        <label>Product *</label>
                        <select class="form-control" @bind="currentInventory.ProductId" disabled="@isEditMode">
                            <option value="0">-- Select Product --</option>
                            @foreach (var prod in availableProducts)
                            {
                                <option value="@prod.ProductId">@prod.Name (@prod.Sku)</option>
                            }
                        </select>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Current Stock *</label>
                            <input type="number" class="form-control" @bind="currentInventory.QuantityOnHand" 
                                   min="0" step="1" placeholder="0" />
                        </div>

                        <div class="form-group">
                            <label>Reorder Level *</label>
                            <input type="number" class="form-control" @bind="currentInventory.ReorderLevel" 
                                   min="0" step="1" placeholder="10" />
                            <small style="color: var(--spa-text-light);">Alert when stock reaches this</small>
                        </div>
                    </div>

                    <div class="alert alert-info" style="margin-top: 1rem;">
                        <span class="bi bi-info-circle-fill"></span>
                        <div>
                            <strong>Tip:</strong> Set a reorder level to get alerts when stock is low.
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseDialog">
                        <span class="bi bi-x-circle"></span> Cancel
                    </button>
                    <button class="btn btn-primary" @onclick="SaveInventory" 
                            disabled="@(currentInventory.ProductId == 0)">
                        <span class="bi bi-check-circle"></span> @(isEditMode ? "Update" : "Save")
                    </button>
                </div>
            </div>
        </div>
    }

    @if (showAdjustDialog)
    {
        <div class="modal-overlay" @onclick="CloseAdjustDialog">
            <div class="modal-content" @onclick:stopPropagation="true" style="max-width: 500px;">
                <div class="modal-header">
                    <h4 style="margin: 0; color: var(--spa-primary);">Adjust Stock</h4>
                    <button class="btn-close" @onclick="CloseAdjustDialog">
                        <span class="bi bi-x-lg"></span>
                    </button>
                </div>

                <div class="modal-body">
                    <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 1rem;">
                        <strong>@adjustingInventory?.Product?.Name</strong><br />
                        <span style="color: var(--spa-text-light);">Current Stock: </span>
                        <strong>@((int)(adjustingInventory?.QuantityOnHand ?? 0))</strong>
                    </div>

                    <div class="form-group">
                        <label>Adjustment Type *</label>
                        <select class="form-control" @bind="adjustmentType">
                            <option value="add">Add Stock (Receive)</option>
                            <option value="remove">Remove Stock (Use/Damage)</option>
                            <option value="set">Set Stock (Manual Count)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>
                            @if (adjustmentType == "set")
                            {
                                <span>New Stock Quantity *</span>
                            }
                            else
                            {
                                <span>Quantity to @(adjustmentType == "add" ? "Add" : "Remove") *</span>
                            }
                        </label>
                        <input type="number" class="form-control" @bind="adjustmentQuantity" 
                               min="0" step="1" placeholder="0" />
                    </div>

                    <div class="form-group">
                        <label>Reason/Notes</label>
                        <textarea class="form-control" @bind="adjustmentNotes" 
                                  rows="2" placeholder="Optional notes about this adjustment"></textarea>
                    </div>

                    @if (adjustmentType != "set")
                    {
                        <div class="alert alert-info">
                            <span class="bi bi-info-circle-fill"></span>
                            <div>
                                New stock will be: 
                                <strong>
                                    @if (adjustmentType == "add")
                                    {
                                        @((int)((adjustingInventory?.QuantityOnHand ?? 0) + adjustmentQuantity))
                                    }
                                    else
                                    {
                                        @((int)Math.Max(0, (adjustingInventory?.QuantityOnHand ?? 0) - adjustmentQuantity))
                                    }
                                </strong>
                            </div>
                        </div>
                    }
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseAdjustDialog">
                        <span class="bi bi-x-circle"></span> Cancel
                    </button>
                    <button class="btn btn-primary" @onclick="SaveAdjustment">
                        <span class="bi bi-check-circle"></span> Apply Adjustment
                    </button>
                </div>
            </div>
        </div>
    }
}

@code {
    private List<Models.Inventory> inventory = new();
    private List<Models.Inventory> filteredInventory = new();
    private List<Product> products = new();
    private List<Product> availableProducts = new();
    private Models.Inventory currentInventory = new();
    private Models.Inventory? adjustingInventory;
    private bool isLoading = true;
    private bool showDialog = false;
    private bool showAdjustDialog = false;
    private bool isEditMode = false;
    private string? successMessage;
    private string? errorMessage;
    private string stockFilter = "";
    private string adjustmentType = "add";
    private decimal adjustmentQuantity = 0;
    private string adjustmentNotes = "";

    // Pagination and sorting
    private string searchTerm = "";
    private string sortColumn = "product";
    private bool sortAscending = true;
    private int currentPage = 1;
    private int pageSize = 10;
    private int TotalPages => (int)Math.Ceiling((double)filteredInventory.Count / pageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        
        try
        {
            using var DbContext = await DbContextFactory.CreateDbContextAsync();
            
            products = await DbContext.Products
                .Where(p => p.Active)
                .OrderBy(p => p.Name)
                .ToListAsync();

            inventory = await DbContext.Inventories
                .Include(i => i.Product)
                .OrderBy(i => i.Product!.Name)
                .ToListAsync();

            // Get products that don't have inventory yet
            var inventoryProductIds = inventory.Select(i => i.ProductId).ToList();
            availableProducts = products.Where(p => !inventoryProductIds.Contains(p.ProductId)).ToList();

            ApplyFilter();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilter()
    {
        filteredInventory = inventory;

        // Search filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var search = searchTerm.ToLower();
            filteredInventory = filteredInventory.Where(i => 
                (i.Product?.Name?.ToLower().Contains(search) ?? false) ||
                (i.Product?.Sku?.ToLower().Contains(search) ?? false)
            ).ToList();
        }

        // Stock status filter
        if (stockFilter == "low")
        {
            filteredInventory = filteredInventory.Where(i => i.QuantityOnHand > 0 && i.QuantityOnHand <= i.ReorderLevel).ToList();
        }
        else if (stockFilter == "out")
        {
            filteredInventory = filteredInventory.Where(i => i.QuantityOnHand <= 0).ToList();
        }
        else if (stockFilter == "ok")
        {
            filteredInventory = filteredInventory.Where(i => i.QuantityOnHand > i.ReorderLevel).ToList();
        }

        // Apply sorting
        filteredInventory = sortColumn switch
        {
            "product" => sortAscending 
                ? filteredInventory.OrderBy(i => i.Product?.Name).ToList()
                : filteredInventory.OrderByDescending(i => i.Product?.Name).ToList(),
            "sku" => sortAscending 
                ? filteredInventory.OrderBy(i => i.Product?.Sku).ToList()
                : filteredInventory.OrderByDescending(i => i.Product?.Sku).ToList(),
            "stock" => sortAscending 
                ? filteredInventory.OrderBy(i => i.QuantityOnHand).ToList()
                : filteredInventory.OrderByDescending(i => i.QuantityOnHand).ToList(),
            "reorder" => sortAscending 
                ? filteredInventory.OrderBy(i => i.ReorderLevel).ToList()
                : filteredInventory.OrderByDescending(i => i.ReorderLevel).ToList(),
            "lastcounted" => sortAscending 
                ? filteredInventory.OrderBy(i => i.LastCountedAt).ToList()
                : filteredInventory.OrderByDescending(i => i.LastCountedAt).ToList(),
            "status" => sortAscending 
                ? filteredInventory.OrderBy(i => GetStockStatus(i)).ToList()
                : filteredInventory.OrderByDescending(i => GetStockStatus(i)).ToList(),
            _ => filteredInventory
        };

        currentPage = 1;
    }

    private void SortBy(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
        ApplyFilter();
    }

    private string GetSortIcon(string column)
    {
        if (sortColumn != column) return "";
        return sortAscending ? "▲" : "▼";
    }

    private List<Models.Inventory> GetPagedInventory()
    {
        return filteredInventory
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private void PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
        }
    }

    private void NextPage()
    {
        if (currentPage < TotalPages)
        {
            currentPage++;
        }
    }

    private void GoToPage(int page)
    {
        currentPage = page;
    }

    private string GetStockStatus(Models.Inventory inv)
    {
        if (inv.QuantityOnHand <= 0) return "out";
        if (inv.QuantityOnHand <= inv.ReorderLevel) return "low";
        return "ok";
    }

    private void OnStockFilterChanged(ChangeEventArgs e)
    {
        stockFilter = e.Value?.ToString() ?? "";
        ApplyFilter();
    }

    private void OpenAddDialog()
    {
        currentInventory = new Models.Inventory { QuantityOnHand = 0, ReorderLevel = 10 };
        isEditMode = false;
        showDialog = true;
        ClearMessages();
    }

    private void OpenEditDialog(Models.Inventory inv)
    {
        currentInventory = new Models.Inventory
        {
            InventoryId = inv.InventoryId,
            ProductId = inv.ProductId,
            QuantityOnHand = inv.QuantityOnHand,
            ReorderLevel = inv.ReorderLevel
        };
        isEditMode = true;
        showDialog = true;
        ClearMessages();
    }

    private void OpenAdjustDialog(Models.Inventory inv)
    {
        adjustingInventory = inv;
        adjustmentType = "add";
        adjustmentQuantity = 0;
        adjustmentNotes = "";
        showAdjustDialog = true;
        ClearMessages();
    }

    private void CloseDialog()
    {
        showDialog = false;
        currentInventory = new();
        isEditMode = false;
    }

    private void CloseAdjustDialog()
    {
        showAdjustDialog = false;
        adjustingInventory = null;
        adjustmentQuantity = 0;
        adjustmentNotes = "";
    }

    private async Task SaveInventory()
    {
        try
        {
            ClearMessages();

            if (currentInventory.ProductId == 0)
            {
                errorMessage = "Please select a product.";
                return;
            }

            using var DbContext = await DbContextFactory.CreateDbContextAsync();

            if (isEditMode)
            {
                var existing = await DbContext.Inventories.FindAsync(currentInventory.InventoryId);
                if (existing != null)
                {
                    existing.QuantityOnHand = currentInventory.QuantityOnHand;
                    existing.ReorderLevel = currentInventory.ReorderLevel;
                    existing.LastCountedAt = DateTime.Now;
                    await DbContext.SaveChangesAsync();
                    successMessage = "Inventory settings updated successfully!";
                }
            }
            else
            {
                var newInventory = new Models.Inventory
                {
                    ProductId = currentInventory.ProductId,
                    QuantityOnHand = currentInventory.QuantityOnHand,
                    ReorderLevel = currentInventory.ReorderLevel,
                    LastCountedAt = DateTime.Now
                };
                DbContext.Inventories.Add(newInventory);
                await DbContext.SaveChangesAsync();
                successMessage = "Initial stock set successfully!";
            }

            CloseDialog();
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving inventory: {ex.Message}";
        }
    }

    private async Task SaveAdjustment()
    {
        try
        {
            ClearMessages();

            if (adjustingInventory == null)
            {
                errorMessage = "No inventory selected.";
                return;
            }

            using var DbContext = await DbContextFactory.CreateDbContextAsync();

            var existing = await DbContext.Inventories.FindAsync(adjustingInventory.InventoryId);
            if (existing == null)
            {
                errorMessage = "Inventory record not found.";
                return;
            }

            decimal newStock = existing.QuantityOnHand;
            if (adjustmentType == "add")
            {
                newStock += adjustmentQuantity;
            }
            else if (adjustmentType == "remove")
            {
                newStock -= adjustmentQuantity;
                if (newStock < 0) newStock = 0;
            }
            else if (adjustmentType == "set")
            {
                newStock = adjustmentQuantity;
            }

            existing.QuantityOnHand = newStock;
            existing.LastCountedAt = DateTime.Now;
            await DbContext.SaveChangesAsync();

            successMessage = $"Stock adjusted successfully! New stock: {newStock}";
            CloseAdjustDialog();
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error adjusting stock: {ex.Message}";
        }
    }

    private void ClearMessages()
    {
        successMessage = null;
        errorMessage = null;
    }
}
