@page "/appointments"
@page "/appointments/new"
@using Microsoft.EntityFrameworkCore
@using Spa_Management_System.Services
@using Spa_Management_System.Models
@using Spa_Management_System.Data
@inject IAuthStateService AuthState
@inject IAuditLogService AuditLog
@inject NavigationManager Navigation
@inject AppDbContext DbContext
@inject IJSRuntime JSRuntime

<PageTitle>Appointments - Serenity Spa</PageTitle>

@if (!AuthState.IsAuthenticated)
{
    Navigation.NavigateTo("/login");
}
else
{
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
                <h3 class="card-title" style="margin: 0;"><span class="bi bi-calendar-check"></span> Appointment Management</h3>
                <p style="color: var(--spa-text-light); margin: 0.5rem 0 0 0;">Schedule and manage customer appointments</p>
            </div>
            <button class="btn btn-primary" @onclick="OpenBookingDialog">
                <span class="bi bi-plus-circle"></span> Book Appointment
            </button>
        </div>

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">
                <span class="bi bi-check-circle-fill"></span>
                <div>@successMessage</div>
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">
                <span class="bi bi-exclamation-triangle-fill"></span>
                <div>@errorMessage</div>
            </div>
        }

        <!-- Date Filter -->
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: end;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">View Date:</label>
                <input type="date" class="form-control" value="@selectedDate.ToString("yyyy-MM-dd")" 
                       @onchange="OnDateChanged" style="width: 200px;" />
            </div>
            <button class="btn btn-outline" @onclick="GoToToday">Today</button>
            <button class="btn btn-outline" @onclick="GoToPreviousDay">← Previous</button>
            <button class="btn btn-outline" @onclick="GoToNextDay">Next →</button>
        </div>

        @if (isLoading)
        {
            <div style="padding: 2rem; text-align: center;">
                <div class="loading"></div>
                <p style="margin-top: 1rem; color: var(--spa-text-light);">Loading appointments...</p>
            </div>
        }
        else if (!appointments.Any())
        {
            <div class="alert alert-info">
                <span class="bi bi-info-circle-fill"></span>
                <div>
                    <strong>No Appointments for @selectedDate.ToString("MMMM dd, yyyy")</strong><br />
                    Click "Book Appointment" to schedule a new appointment.
                </div>
            </div>
        }
        else
        {
            <!-- Kanban Board View -->
            <div class="kanban-board">
                <!-- Scheduled Column -->
                <div class="kanban-column">
                    <div class="column-header scheduled-header">
                        <span class="bi bi-calendar-check"></span>
                        <span class="column-title">Scheduled</span>
                        <span class="column-count">@appointments.Count(a => a.Status == "scheduled" || a.Status == "confirmed")</span>
                    </div>
                    <div class="column-cards">
                        @foreach (var appt in appointments.Where(a => a.Status == "scheduled" || a.Status == "confirmed").OrderBy(a => a.ScheduledStart))
                        {
                            <div class="appt-card">
                                <div class="card-time">@appt.ScheduledStart.ToString("h:mm tt")</div>
                                <div class="card-customer">@appt.Customer?.Person?.FirstName @appt.Customer?.Person?.LastName</div>
                                <div class="card-services">
                                    @foreach (var svc in appt.AppointmentServices?.Take(2) ?? new List<AppointmentService>())
                                    {
                                        <span class="service-badge">@svc.Service?.Name</span>
                                    }
                                    @if ((appt.AppointmentServices?.Count ?? 0) > 2)
                                    {
                                        <span class="more-badge">+@((appt.AppointmentServices?.Count ?? 0) - 2)</span>
                                    }
                                </div>
                                <div class="card-total">₱@((appt.AppointmentServices?.Sum(s => s.Price) ?? 0).ToString("N0"))</div>
                                <div class="card-actions">
                                    @if (appt.Status == "scheduled")
                                    {
                                        <button class="action-btn confirm" @onclick="() => UpdateStatus(appt.AppointmentId, STATUS_CONFIRMED)" title="Confirm"><span class="bi bi-check"></span></button>
                                    }
                                    <button class="action-btn start" @onclick="() => UpdateStatus(appt.AppointmentId, STATUS_IN_PROGRESS)" title="Start Service"><span class="bi bi-play-fill"></span></button>
                                    <button class="action-btn edit" @onclick="() => OpenEditDialog(appt)" title="Edit"><span class="bi bi-pencil"></span></button>
                                    <button class="action-btn cancel" @onclick="() => UpdateStatus(appt.AppointmentId, STATUS_CANCELLED)" title="Cancel"><span class="bi bi-x"></span></button>
                                </div>
                            </div>
                        }
                        @if (!appointments.Any(a => a.Status == "scheduled" || a.Status == "confirmed"))
                        {
                            <div class="empty-column">No scheduled appointments</div>
                        }
                    </div>
                </div>

                <!-- In Progress Column -->
                <div class="kanban-column">
                    <div class="column-header inprogress-header">
                        <span class="bi bi-hourglass-split"></span>
                        <span class="column-title">In Progress</span>
                        <span class="column-count">@appointments.Count(a => a.Status == "in-progress")</span>
                    </div>
                    <div class="column-cards">
                        @foreach (var appt in appointments.Where(a => a.Status == "in-progress").OrderBy(a => a.ScheduledStart))
                        {
                            var startedAgo = (DateTime.Now - appt.ScheduledStart).TotalMinutes;
                            var expectedDuration = appt.AppointmentServices?.Sum(s => s.Service?.DurationMinutes ?? 0) ?? 60;
                            var progress = Math.Min(100, (startedAgo / expectedDuration) * 100);
                            
                            <div class="appt-card">
                                <div class="card-time">Started @appt.ScheduledStart.ToString("h:mm tt")</div>
                                <div class="card-customer">@appt.Customer?.Person?.FirstName @appt.Customer?.Person?.LastName</div>
                                <div class="card-services">
                                    @foreach (var svc in appt.AppointmentServices ?? new List<AppointmentService>())
                                    {
                                        <span class="service-badge">
                                            @svc.Service?.Name
                                            @if (svc.TherapistEmployee?.Person != null)
                                            {
                                                <small>(@svc.TherapistEmployee.Person.FirstName)</small>
                                            }
                                        </span>
                                    }
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: @progress%"></div>
                                </div>
                                <div class="card-timer">~@((expectedDuration - startedAgo).ToString("N0")) min left</div>
                                <div class="card-actions">
                                    <button class="action-btn complete" @onclick="() => UpdateStatus(appt.AppointmentId, STATUS_COMPLETED)" title="Mark Complete"><span class="bi bi-check-lg"></span> Done</button>
                                </div>
                            </div>
                        }
                        @if (!appointments.Any(a => a.Status == "in-progress"))
                        {
                            <div class="empty-column">No services in progress</div>
                        }
                    </div>
                </div>

                <!-- Ready for Checkout Column -->
                <div class="kanban-column">
                    <div class="column-header ready-header">
                        <span class="bi bi-credit-card"></span>
                        <span class="column-title">Ready to Pay</span>
                        <span class="column-count">@appointments.Count(a => a.Status == "completed")</span>
                    </div>
                    <div class="column-cards">
                        @foreach (var appt in appointments.Where(a => a.Status == "completed").OrderBy(a => a.ScheduledStart))
                        {
                            <div class="appt-card">
                                <div class="card-time">Done @appt.ScheduledEnd?.ToString("h:mm tt")</div>
                                <div class="card-customer">@appt.Customer?.Person?.FirstName @appt.Customer?.Person?.LastName</div>
                                <div class="card-services">
                                    @foreach (var svc in appt.AppointmentServices?.Take(2) ?? new List<AppointmentService>())
                                    {
                                        <span class="service-badge">@svc.Service?.Name</span>
                                    }
                                </div>
                                <div class="card-total">₱@((appt.AppointmentServices?.Sum(s => s.Price) ?? 0).ToString("N0"))</div>
                                <div class="card-actions">
                                    <button class="action-btn checkout" @onclick="() => GoToCheckout(appt.AppointmentId)">
                                        <span class="bi bi-credit-card"></span> Checkout
                                    </button>
                                </div>
                            </div>
                        }
                        @if (!appointments.Any(a => a.Status == "completed"))
                        {
                            <div class="empty-column">No appointments ready</div>
                        }
                    </div>
                </div>

                <!-- Paid Column -->
                <!-- Paid Column -->
                <div class="kanban-column">
                    <div class="column-header paid-header">
                        <span class="bi bi-check-circle"></span>
                        <span class="column-title">Paid</span>
                        <span class="column-count">@appointments.Count(a => a.Status == "paid")</span>
                    </div>
                    <div class="column-cards">
                        @foreach (var appt in appointments.Where(a => a.Status == "paid").OrderByDescending(a => a.ScheduledStart))
                        {
                            <div class="appt-card paid">
                                <div class="card-customer">@appt.Customer?.Person?.FirstName @appt.Customer?.Person?.LastName</div>
                                <div class="card-services">
                                    @foreach (var svc in appt.AppointmentServices?.Take(2) ?? new List<AppointmentService>())
                                    {
                                        <span class="service-badge">@svc.Service?.Name</span>
                                    }
                                </div>
                                <div class="card-total">₱@((appt.AppointmentServices?.Sum(s => s.Price) ?? 0).ToString("N0")) <span class="bi bi-check"></span></div>
                            </div>
                        }
                        @if (!appointments.Any(a => a.Status == "paid"))
                        {
                            <div class="empty-column">No payments yet</div>
                        }
                    </div>
                </div>
            </div>

            <!-- Cancelled (collapsed) -->
            @if (appointments.Any(a => a.Status == "cancelled"))
            {
                <details class="cancelled-section">
                    <summary><span class="bi bi-x-circle"></span> Cancelled (@appointments.Count(a => a.Status == "cancelled"))</summary>
                    <div class="cancelled-list">
                        @foreach (var appt in appointments.Where(a => a.Status == "cancelled"))
                        {
                            <div class="cancelled-item">
                                <span>@appt.ScheduledStart.ToString("h:mm tt")</span>
                                <span>@appt.Customer?.Person?.FirstName @appt.Customer?.Person?.LastName</span>
                            </div>
                        }
                    </div>
                </details>
            }
        }
    </div>

    <!-- Kanban Styles -->
    <style>
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 1rem;
            height: calc(100vh - 280px);
            min-height: 400px;
        }

        .kanban-column {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .column-header {
            padding: 0.85rem 1rem;
            border-radius: 10px;
            margin: 0.75rem 0.75rem 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            flex-shrink: 0;
            background: #454F4A;
            color: #ffffff !important;
        }

        .column-header * {
            color: #ffffff !important;
        }

        /* All headers share one base style; subtle per-column tweaks if needed */
        .scheduled-header { }
        .inprogress-header { }
        .ready-header { }
        .paid-header { }

        .column-header .bi { font-size: 1.1rem; }
        .column-title { flex: 1; }
        .column-count {
            background: rgba(255,255,255,0.3);
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.85rem;
        }

        .column-cards {
            flex: 1;
            padding: 0.75rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .appt-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            border-left: 4px solid #e0e0e0;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .appt-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .appt-card.scheduled { border-left-color: var(--spa-info); }
        .appt-card.confirmed { border-left-color: var(--spa-accent); }
        .appt-card.in-progress { border-left-color: var(--spa-warning); }
        .appt-card.completed { border-left-color: var(--spa-success); }
        .appt-card.paid { border-left-color: var(--spa-primary); opacity: 0.7; }

        .card-time {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 0.25rem;
        }

        .card-customer {
            font-weight: 600;
            font-size: 1rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .card-services {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .service-badge {
            background: #e8f4ec;
            color: #4a7c59;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .service-badge.active {
            background: #fef3c7;
            color: #92400e;
        }

        .service-badge.done {
            background: #dcfce7;
            color: #166534;
        }

        .service-badge.paid {
            background: #f3e8ff;
            color: #6b21a8;
        }

        .more-badge {
            background: #e0e0e0;
            color: #666;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .card-total {
            font-weight: 600;
            color: #4a7c59;
            margin-bottom: 0.5rem;
        }

        .card-total.highlight {
            font-size: 1.1rem;
            color: #22c55e;
        }

        .card-total.paid {
            color: #8b5cf6;
        }

        .card-timer {
            font-size: 0.8rem;
            color: #f59e0b;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--spa-accent);
            border-radius: 2px;
            transition: width 0.3s;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .action-btn {
            padding: 0.35rem 0.6rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .action-btn.confirm { background: #dbeafe; color: #1e40af; }
        .action-btn.start { background: #fef3c7; color: #92400e; }
        .action-btn.edit { background: #f3f4f6; color: #374151; }
        .action-btn.cancel { background: #fee2e2; color: #dc2626; }
        .action-btn.complete { background: #dcfce7; color: #166534; flex: 1; }
        .action-btn.checkout { background: #22c55e; color: white; flex: 1; font-weight: 600; }

        .action-btn:hover {
            transform: scale(1.05);
            filter: brightness(0.95);
        }

        .empty-column {
            text-align: center;
            padding: 2rem 1rem;
            color: #888;
            font-style: italic;
        }

        .cancelled-section {
            margin-top: 1rem;
            background: #fef2f2;
            border-radius: 8px;
            padding: 0.75rem 1rem;
        }

        .cancelled-section summary {
            cursor: pointer;
            color: #dc2626;
            font-weight: 500;
        }

        .cancelled-list {
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .cancelled-item {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: #666;
            padding: 0.25rem 0;
        }

        @@media (max-width: 1200px) {
            .kanban-board {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @@media (max-width: 768px) {
            .kanban-board {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- Booking Dialog -->
    @if (showBookingDialog)
    {
        <div class="modal-overlay" @onclick="CloseBookingDialog">
            <div class="modal-content" @onclick:stopPropagation="true" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h4 style="margin: 0; color: var(--spa-primary);">
                        @(isEditMode ? "Edit Appointment" : "Book New Appointment")
                    </h4>
                    <button class="btn-close" @onclick="CloseBookingDialog">
                        <span class="bi bi-x-lg"></span>
                    </button>
                </div>

                <div class="modal-body">
                    <!-- Step 1: Customer Selection -->
                    <div class="form-group">
                        <label>Customer <span style="color: var(--spa-danger);">*</span></label>
                        <select class="form-control" @bind="selectedCustomerId">
                            <option value="0">-- Select Customer --</option>
                            @foreach (var customer in customers)
                            {
                                <option value="@customer.CustomerId">
                                    @customer.Person?.FirstName @customer.Person?.LastName 
                                    @(!string.IsNullOrEmpty(customer.CustomerCode) ? $"({customer.CustomerCode})" : "")
                                </option>
                            }
                        </select>
                        <small style="color: var(--spa-text-light);">
                            Don't see the customer? <a href="/customers" style="color: var(--spa-accent);">Add new customer</a>
                        </small>
                    </div>

                    <!-- Step 2: Date & Time -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Date <span style="color: var(--spa-danger);">*</span></label>
                            <input type="date" class="form-control" @bind="appointmentDate" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="form-group">
                            <label>Start Time <span style="color: var(--spa-danger);">*</span></label>
                            <select class="form-control" @bind="appointmentTime">
                                <option value="">-- Select Time --</option>
                                @foreach (var time in GetAvailableTimeSlots())
                                {
                                    <option value="@time">@DateTime.Parse(time).ToString("h:mm tt")</option>
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Step 3: Services Selection -->
                    <div class="form-group">
                        <label>Services <span style="color: var(--spa-danger);">*</span></label>
                        <div style="border: 1px solid var(--spa-secondary); border-radius: 8px; padding: 1rem; max-height: 250px; overflow-y: auto;">
                            @foreach (var category in serviceCategories)
                            {
                                <div style="margin-bottom: 1rem;">
                                    <strong style="color: var(--spa-primary);">@category.Name</strong>
                                    <div style="margin-top: 0.5rem; display: grid; gap: 0.5rem;">
                                        @foreach (var service in services.Where(s => s.ServiceCategoryId == category.ServiceCategoryId && s.Active))
                                        {
                                            var isSelected = selectedServices.Contains(service.ServiceId);
                                            <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; background: @(isSelected ? "rgba(170, 148, 120, 0.1)" : "transparent"); border-radius: 6px; cursor: pointer;">
                                                <input type="checkbox" checked="@isSelected" 
                                                       @onchange="() => ToggleService(service.ServiceId)" />
                                                <span style="flex: 1;">@service.Name (@service.DurationMinutes min)</span>
                                                <strong>₱@service.Price.ToString("N2")</strong>
                                            </label>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                        @if (selectedServices.Any())
                        {
                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--spa-light); border-radius: 6px;">
                                <strong>Selected: @selectedServices.Count service(s)</strong> | 
                                <strong>Duration: @GetTotalDuration() min</strong> | 
                                <strong style="color: var(--spa-success);">Total: ₱@GetTotalPrice().ToString("N2")</strong>
                            </div>
                        }
                    </div>

                    <!-- Step 4: Per-Service Therapist Assignment (REQUIRED) -->
                    @if (selectedServices.Any() && !string.IsNullOrEmpty(appointmentTime))
                    {
                        <div class="form-group" id="therapist-assignment-section">
                            <label><strong>Assign Therapists</strong> <span style="color: var(--spa-danger);">*</span></label>
                            <div style="font-size: 0.85rem; color: var(--spa-text-light); margin-bottom: 0.75rem;">
                                Each service must have an assigned therapist. Only available therapists are shown.
                            </div>
                            <div style="border: 1px solid var(--spa-secondary); border-radius: 8px; overflow: hidden;">
                                @foreach (var serviceId in selectedServices)
                                {
                                    var service = services.FirstOrDefault(s => s.ServiceId == serviceId);
                                    if (service != null)
                                    {
                                        var availableTherapists = GetAvailableTherapistsForService(serviceId);
                                        var currentAssignment = serviceTherapistAssignments.GetValueOrDefault(serviceId, 0);
                                        var hasAssignment = currentAssignment > 0;
                                        var noTherapistsAvailable = !availableTherapists.Any();
                                        
                                        <div style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--spa-light); display: flex; align-items: center; gap: 1rem; @(noTherapistsAvailable ? "background: #fff3cd;" : !hasAssignment ? "background: #fee2e2;" : "")">
                                            <div style="flex: 1;">
                                                <strong>@service.Name</strong>
                                                <span style="color: var(--spa-text-light); font-size: 0.85rem;"> (@service.DurationMinutes min)</span>
                                                @if (!hasAssignment && !noTherapistsAvailable)
                                                {
                                                    <div style="color: #dc3545; font-size: 0.75rem;"><span class="bi bi-exclamation-circle"></span> Therapist required</div>
                                                }
                                                @if (noTherapistsAvailable)
                                                {
                                                    <div style="color: #856404; font-size: 0.75rem;"><span class="bi bi-exclamation-triangle"></span> No therapists available at this time</div>
                                                }
                                            </div>
                                            <select class="form-control" style="width: 220px; @(!hasAssignment ? "border-color: #dc3545;" : "")" 
                                                    value="@currentAssignment"
                                                    @onchange="e => OnTherapistAssignmentChanged(serviceId, e)"
                                                    disabled="@noTherapistsAvailable">
                                                <option value="0">-- Select Therapist --</option>
                                                @foreach (var therapist in availableTherapists)
                                                {
                                                    var isQualified = IsTherapistQualifiedForService(therapist.EmployeeId, serviceId);
                                                    <option value="@therapist.EmployeeId">
                                                        @therapist.Person?.FirstName @therapist.Person?.LastName
                                                        @(isQualified ? " (Qualified)" : "")
                                                    </option>
                                                }
                                            </select>
                                        </div>
                                    }
                                }
                            </div>
                            @if (!AllServicesHaveTherapist())
                            {
                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fee2e2; border-radius: 6px; font-size: 0.85rem; color: #dc3545;">
                                    <span class="bi bi-exclamation-circle"></span> Please assign a therapist to each service before booking.
                                </div>
                            }
                            @if (!selectedServices.All(sid => GetAvailableTherapistsForService(sid).Any()))
                            {
                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fff3cd; border-radius: 6px; font-size: 0.85rem; color: #856404;">
                                    <span class="bi bi-clock"></span> Some services have no available therapists. Try a different time slot.
                                </div>
                            }
                        </div>
                    }
                    else if (selectedServices.Any())
                    {
                        <div style="padding: 0.75rem; background: var(--spa-light); border-radius: 6px; color: var(--spa-text-light); font-size: 0.9rem;">
                            <span class="bi bi-info-circle"></span> Select a time slot to see available therapists
                        </div>
                    }

                    <!-- Step 5: Notes -->
                    <div class="form-group">
                        <label>Notes / Special Requests</label>
                        <textarea class="form-control" @bind="appointmentNotes" rows="2" 
                                  placeholder="Any special requests or notes..."></textarea>
                    </div>

                    @if (!string.IsNullOrEmpty(dialogError))
                    {
                        <div class="alert alert-danger">
                            <span class="bi bi-exclamation-triangle-fill"></span>
                            <div>@dialogError</div>
                        </div>
                    }
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseBookingDialog">
                        <span class="bi bi-x-circle"></span> Cancel
                    </button>
                    <button class="btn btn-primary" @onclick="SaveAppointment" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <div class="loading" style="width: 1rem; height: 1rem; display: inline-block;"></div>
                        }
                        else
                        {
                            <span class="bi bi-check-circle"></span>
                        }
                        @(isEditMode ? "Update Appointment" : "Book Appointment")
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- View Details Dialog -->
    @if (showDetailsDialog && viewingAppointment != null)
    {
        <div class="modal-overlay" @onclick="CloseDetailsDialog">
            <div class="modal-content" @onclick:stopPropagation="true" style="max-width: 600px;">
                <div class="modal-header">
                    <h4 style="margin: 0; color: var(--spa-primary);"><span class="bi bi-clipboard-check"></span> Appointment Details</h4>
                    <button class="btn-close" @onclick="CloseDetailsDialog">
                        <span class="bi bi-x-lg"></span>
                    </button>
                </div>

                <div class="modal-body">
                    <div style="display: grid; gap: 1rem;">
                        <div style="padding: 1rem; background: var(--spa-light); border-radius: 8px;">
                            <h5 style="margin: 0 0 0.5rem 0; color: var(--spa-primary);">Customer</h5>
                            <p style="margin: 0; font-size: 1.1rem;">
                                <strong>@viewingAppointment.Customer?.Person?.FirstName @viewingAppointment.Customer?.Person?.LastName</strong>
                            </p>
                            @if (!string.IsNullOrEmpty(viewingAppointment.Customer?.Person?.Phone))
                            {
                                <p style="margin: 0.25rem 0 0 0;"><span class="bi bi-telephone"></span> @viewingAppointment.Customer.Person.Phone</p>
                            }
                            @if (!string.IsNullOrEmpty(viewingAppointment.Customer?.Person?.Email))
                            {
                                <p style="margin: 0.25rem 0 0 0;"><span class="bi bi-envelope"></span> @viewingAppointment.Customer.Person.Email</p>
                            }
                        </div>

                        <div style="padding: 1rem; background: var(--spa-light); border-radius: 8px;">
                            <h5 style="margin: 0 0 0.5rem 0; color: var(--spa-primary);">Schedule</h5>
                            <p style="margin: 0;"><span class="bi bi-calendar"></span> @viewingAppointment.ScheduledStart.ToString("dddd, MMMM dd, yyyy")</p>
                            <p style="margin: 0.25rem 0 0 0;"><span class="bi bi-clock"></span> @viewingAppointment.ScheduledStart.ToString("h:mm tt") - @viewingAppointment.ScheduledEnd?.ToString("h:mm tt")</p>
                        </div>

                        <div style="padding: 1rem; background: var(--spa-light); border-radius: 8px;">
                            <h5 style="margin: 0 0 0.5rem 0; color: var(--spa-primary);">Services</h5>
                            @if (viewingAppointment.AppointmentServices?.Any() == true)
                            {
                                @foreach (var svc in viewingAppointment.AppointmentServices)
                                {
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--spa-secondary);">
                                        <span>@svc.Service?.Name</span>
                                        <strong>₱@svc.Price.ToString("N2")</strong>
                                    </div>
                                }
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem 0 0 0; font-size: 1.1rem;">
                                    <strong>Total:</strong>
                                    <strong style="color: var(--spa-success);">₱@viewingAppointment.AppointmentServices.Sum(s => s.Price).ToString("N2")</strong>
                                </div>
                            }
                        </div>

                        @if (!string.IsNullOrEmpty(viewingAppointment.Notes))
                        {
                            <div style="padding: 1rem; background: #fff3cd; border-radius: 8px;">
                                <h5 style="margin: 0 0 0.5rem 0; color: var(--spa-primary);">Notes</h5>
                                <p style="margin: 0;">@viewingAppointment.Notes</p>
                            </div>
                        }
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseDetailsDialog">Close</button>
                </div>
            </div>
        </div>
    }
}

@code {
    // Status constants to avoid quoting issues in Razor markup
    private const string STATUS_SCHEDULED = "scheduled";
    private const string STATUS_CONFIRMED = "confirmed";
    private const string STATUS_IN_PROGRESS = "in-progress";
    private const string STATUS_COMPLETED = "completed";
    private const string STATUS_CANCELLED = "cancelled";

    private List<Appointment> appointments = new();
    private List<Customer> customers = new();
    private List<Service> services = new();
    private List<ServiceCategory> serviceCategories = new();
    private List<Employee> therapists = new();
    private List<EmployeeServiceCommission> therapistQualifications = new(); // Tracks which therapists can do which services
    
    private DateTime selectedDate = DateTime.Today;
    private bool isLoading = true;
    private string? successMessage;
    private string? errorMessage;

    // Booking Dialog
    private bool showBookingDialog = false;
    private bool isEditMode = false;
    private bool isSaving = false;
    private string? dialogError;
    private long editingAppointmentId = 0;

    // Booking Form Fields
    private long selectedCustomerId = 0;
    private DateTime appointmentDate = DateTime.Today;
    private string appointmentTime = "";
    private List<long> selectedServices = new();
    private Dictionary<long, long> serviceTherapistAssignments = new(); // ServiceId -> TherapistId (per-service assignment)
    private string appointmentNotes = "";

    // View Details Dialog
    private bool showDetailsDialog = false;
    private Appointment? viewingAppointment;

    // Query parameter for pre-selecting customer
    [SupplyParameterFromQuery]
    public long? customerId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        
        // If customerId is provided via query string, open booking dialog with customer pre-selected
        if (customerId.HasValue && customerId.Value > 0)
        {
            OpenBookingDialogWithCustomer(customerId.Value);
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            // Load appointments for selected date
            var startOfDay = selectedDate.Date;
            var endOfDay = selectedDate.Date.AddDays(1).AddTicks(-1);
            
            appointments = await DbContext.Appointments
                .Include(a => a.Customer)
                    .ThenInclude(c => c.Person)
                .Include(a => a.AppointmentServices)
                    .ThenInclude(s => s.Service)
                .Include(a => a.AppointmentServices)
                    .ThenInclude(s => s.TherapistEmployee)
                        .ThenInclude(e => e!.Person)
                .Where(a => a.ScheduledStart >= startOfDay && a.ScheduledStart <= endOfDay)
                .OrderBy(a => a.ScheduledStart)
                .ToListAsync();

            // Load reference data
            customers = await DbContext.Customers
                .Include(c => c.Person)
                .OrderBy(c => c.Person.LastName)
                .ToListAsync();

            services = await DbContext.Services
                .Where(s => s.Active)
                .OrderBy(s => s.Name)
                .ToListAsync();

            serviceCategories = await DbContext.ServiceCategories
                .OrderBy(sc => sc.Name)
                .ToListAsync();

            // Load therapists (employees with Therapist role)
            therapists = await DbContext.Employees
                .Include(e => e.Person)
                .Include(e => e.Role)
                .Where(e => e.Role.Name == "Therapist" && e.Status == "active")
                .OrderBy(e => e.Person.LastName)
                .ToListAsync();

            // Load therapist qualifications (which services each therapist can perform)
            therapistQualifications = await DbContext.EmployeeServiceCommissions
                .Where(esc => !esc.IsArchived 
                    && (esc.EffectiveFrom == null || esc.EffectiveFrom <= DateTime.Now)
                    && (esc.EffectiveTo == null || esc.EffectiveTo >= DateTime.Now))
                .ToListAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            selectedDate = date;
            await LoadData();
        }
    }

    private async Task GoToToday()
    {
        selectedDate = DateTime.Today;
        await LoadData();
    }

    private async Task GoToPreviousDay()
    {
        selectedDate = selectedDate.AddDays(-1);
        await LoadData();
    }

    private async Task GoToNextDay()
    {
        selectedDate = selectedDate.AddDays(1);
        await LoadData();
    }

    private void OpenBookingDialog()
    {
        OpenBookingDialogWithCustomer(0);
    }

    private void OpenBookingDialogWithCustomer(long preselectedCustomerId)
    {
        isEditMode = false;
        editingAppointmentId = 0;
        selectedCustomerId = preselectedCustomerId;
        appointmentDate = selectedDate;
        appointmentTime = "";
        selectedServices.Clear();
        serviceTherapistAssignments.Clear();
        appointmentNotes = "";
        dialogError = null;
        showBookingDialog = true;
    }

    private void OpenEditDialog(Appointment appt)
    {
        isEditMode = true;
        editingAppointmentId = appt.AppointmentId;
        selectedCustomerId = appt.CustomerId;
        appointmentDate = appt.ScheduledStart.Date;
        appointmentTime = appt.ScheduledStart.ToString("HH:mm");
        selectedServices = appt.AppointmentServices?.Select(s => s.ServiceId).ToList() ?? new();
        
        // Load per-service therapist assignments
        serviceTherapistAssignments.Clear();
        if (appt.AppointmentServices != null)
        {
            foreach (var svc in appt.AppointmentServices)
            {
                if (svc.TherapistEmployeeId.HasValue)
                {
                    serviceTherapistAssignments[svc.ServiceId] = svc.TherapistEmployeeId.Value;
                }
            }
        }
        
        appointmentNotes = appt.Notes ?? "";
        dialogError = null;
        showBookingDialog = true;
    }

    private void CloseBookingDialog()
    {
        showBookingDialog = false;
    }

    private List<string> GetAvailableTimeSlots()
    {
        var slots = new List<string>();
        var startTime = new TimeSpan(8, 0, 0); // 8:00 AM
        var endTime = new TimeSpan(20, 0, 0);  // 8:00 PM
        
        for (var time = startTime; time < endTime; time = time.Add(TimeSpan.FromMinutes(30)))
        {
            slots.Add(time.ToString(@"hh\:mm"));
        }
        return slots;
    }

    private void ToggleService(long serviceId)
    {
        if (selectedServices.Contains(serviceId))
        {
            selectedServices.Remove(serviceId);
            serviceTherapistAssignments.Remove(serviceId); // Also remove therapist assignment
        }
        else
        {
            selectedServices.Add(serviceId);
        }
    }

    private void OnTherapistAssignmentChanged(long serviceId, ChangeEventArgs e)
    {
        if (long.TryParse(e.Value?.ToString(), out var therapistId))
        {
            if (therapistId > 0)
            {
                serviceTherapistAssignments[serviceId] = therapistId;
            }
            else
            {
                serviceTherapistAssignments.Remove(serviceId);
            }
        }
    }

    private bool IsTherapistQualifiedForService(long therapistId, long serviceId)
    {
        // A therapist is qualified if they have a commission record for the service
        return therapistQualifications.Any(q => q.EmployeeId == therapistId && q.ServiceId == serviceId);
    }

    private List<Employee> GetAvailableTherapistsForService(long serviceId)
    {
        if (string.IsNullOrEmpty(appointmentTime))
            return new List<Employee>();

        var startDateTime = appointmentDate.Date.Add(TimeSpan.Parse(appointmentTime));
        var service = services.FirstOrDefault(s => s.ServiceId == serviceId);
        var serviceDuration = service?.DurationMinutes ?? 60;
        
        // Calculate the time window for this specific service
        // Services run sequentially, so we need to calculate the start time for each service
        var runningTime = startDateTime;
        foreach (var sid in selectedServices)
        {
            if (sid == serviceId) break;
            var svc = services.FirstOrDefault(s => s.ServiceId == sid);
            runningTime = runningTime.AddMinutes(svc?.DurationMinutes ?? 0);
        }
        var serviceEndTime = runningTime.AddMinutes(serviceDuration);

        // Only show qualified therapists who are NOT busy during this time
        var qualifiedTherapists = therapists
            .Where(t => IsTherapistQualifiedForService(t.EmployeeId, serviceId))
            .Where(t => !IsTherapistBusyDuring(t.EmployeeId, runningTime, serviceEndTime))
            .OrderBy(t => t.Person?.FirstName)
            .ToList();

        return qualifiedTherapists;
    }

    private bool IsTherapistBusyDuring(long therapistId, DateTime startTime, DateTime endTime)
    {
        // Note: For real-time availability, we query the database in CheckTherapistConflictAsync
        // This method is just for UI display of availability based on loaded appointments
        // The actual conflict check happens in SaveAppointment via CheckTherapistConflictAsync
        
        // Check loaded appointments (for current view date)
        var busyAppointments = appointments
            .Where(a => a.Status != "cancelled" && a.Status != "paid")
            .Where(a => a.AppointmentId != editingAppointmentId) // Exclude current appointment when editing
            .SelectMany(a => a.AppointmentServices ?? new List<AppointmentService>())
            .Where(appts => appts.TherapistEmployeeId == therapistId);

        foreach (var appts in busyAppointments)
        {
            var apptStart = appts.Appointment?.ScheduledStart ?? DateTime.MinValue;
            var apptEnd = appts.Appointment?.ScheduledEnd ?? apptStart.AddHours(1);
            
            // Check for overlap
            if (apptStart < endTime && apptEnd > startTime)
            {
                return true;
            }
        }

        return false;
    }

    private int GetTotalDuration()
    {
        return services.Where(s => selectedServices.Contains(s.ServiceId)).Sum(s => s.DurationMinutes);
    }

    private decimal GetTotalPrice()
    {
        return services.Where(s => selectedServices.Contains(s.ServiceId)).Sum(s => s.Price);
    }

    private bool AllServicesHaveTherapist()
    {
        // Check that every selected service has an assigned therapist
        return selectedServices.All(sid => 
            serviceTherapistAssignments.TryGetValue(sid, out var therapistId) && therapistId > 0);
    }

    private async Task<bool> CheckTherapistConflictAsync(long therapistId, DateTime startTime, DateTime endTime, long? excludeAppointmentId = null)
    {
        // Check if therapist has any overlapping appointments (not cancelled or paid)
        var conflictingAppointments = await DbContext.AppointmentServices
            .Include(appts => appts.Appointment)
            .Where(appts => appts.TherapistEmployeeId == therapistId
                && appts.Appointment.Status != "cancelled"
                && appts.Appointment.Status != "paid"
                && (excludeAppointmentId == null || appts.AppointmentId != excludeAppointmentId)
                && appts.Appointment.ScheduledStart < endTime
                && (appts.Appointment.ScheduledEnd ?? appts.Appointment.ScheduledStart.AddHours(1)) > startTime)
            .ToListAsync();

        return conflictingAppointments.Any();
    }

    private bool IsValidStatusTransition(string currentStatus, string newStatus)
    {
        // Define valid status transitions
        var validTransitions = new Dictionary<string, List<string>>
        {
            { "scheduled", new List<string> { "confirmed", "cancelled" } },
            { "confirmed", new List<string> { "in-progress", "cancelled" } },
            { "in-progress", new List<string> { "completed", "cancelled" } },
            { "completed", new List<string> { "paid" } },
            { "paid", new List<string>() }, // No transitions from paid
            { "cancelled", new List<string>() } // No transitions from cancelled
        };

        if (validTransitions.TryGetValue(currentStatus, out var allowedStatuses))
        {
            return allowedStatuses.Contains(newStatus);
        }
        return false;
    }

    private async Task SaveAppointment()
    {
        dialogError = null;

        // Validation
        if (selectedCustomerId == 0)
        {
            dialogError = "Please select a customer.";
            return;
        }
        if (string.IsNullOrEmpty(appointmentTime))
        {
            dialogError = "Please select an appointment time.";
            return;
        }
        if (!selectedServices.Any())
        {
            dialogError = "Please select at least one service.";
            return;
        }
        
        // NEW: Require therapist for each service
        if (!AllServicesHaveTherapist())
        {
            dialogError = "Please assign a therapist to each service. All services must have an assigned therapist.";
            await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('therapist-assignment-section')?.scrollIntoView({ behavior: 'smooth', block: 'center' })");
            return;
        }

        isSaving = true;

        try
        {
            var startDateTime = appointmentDate.Date.Add(TimeSpan.Parse(appointmentTime));
            var endDateTime = startDateTime.AddMinutes(GetTotalDuration());

            // Check for therapist conflicts for all assigned therapists
            var runningTime = startDateTime;
            foreach (var serviceId in selectedServices)
            {
                var service = services.First(s => s.ServiceId == serviceId);
                var serviceEnd = runningTime.AddMinutes(service.DurationMinutes);
                
                if (serviceTherapistAssignments.TryGetValue(serviceId, out var therapistId) && therapistId > 0)
                {
                    var hasConflict = await CheckTherapistConflictAsync(therapistId, runningTime, serviceEnd, 
                        isEditMode ? editingAppointmentId : null);
                    if (hasConflict)
                    {
                        var therapist = therapists.FirstOrDefault(t => t.EmployeeId == therapistId);
                        var therapistName = therapist?.Person?.FirstName ?? "Selected therapist";
                        dialogError = $"{therapistName} has a conflict for {service.Name} at {runningTime:h:mm tt}. Please select a different therapist.";
                        isSaving = false;
                        return;
                    }
                }
                runningTime = serviceEnd;
            }

            if (isEditMode)
            {
                // Update existing appointment
                var appointment = await DbContext.Appointments
                    .Include(a => a.AppointmentServices)
                    .FirstOrDefaultAsync(a => a.AppointmentId == editingAppointmentId);

                if (appointment != null)
                {
                    appointment.CustomerId = selectedCustomerId;
                    appointment.ScheduledStart = startDateTime;
                    appointment.ScheduledEnd = endDateTime;
                    appointment.Notes = appointmentNotes;

                    // Remove old services
                    DbContext.AppointmentServices.RemoveRange(appointment.AppointmentServices);

                    // Add new services with per-service therapist assignment
                    foreach (var serviceId in selectedServices)
                    {
                        var service = services.First(s => s.ServiceId == serviceId);
                        var assignedTherapistId = serviceTherapistAssignments.GetValueOrDefault(serviceId, 0);
                        
                        appointment.AppointmentServices.Add(new AppointmentService
                        {
                            ServiceId = serviceId,
                            TherapistEmployeeId = assignedTherapistId > 0 ? assignedTherapistId : null,
                            Price = service.Price,
                            CommissionAmount = 0
                        });
                    }

                    await DbContext.SaveChangesAsync();
                    
                    // Audit log
                    var customer = customers.FirstOrDefault(c => c.CustomerId == selectedCustomerId);
                    await AuditLog.LogUpdateAsync("Appointment", editingAppointmentId.ToString(), 
                        $"Updated appointment for {customer?.Person?.FirstName} {customer?.Person?.LastName} on {startDateTime:MMM dd, yyyy h:mm tt}", 
                        AuthState.CurrentUser?.UserId);
                    
                    successMessage = "Appointment updated successfully!";
                }
            }
            else
            {
                // Create new appointment
                var appointment = new Appointment
                {
                    CustomerId = selectedCustomerId,
                    ScheduledStart = startDateTime,
                    ScheduledEnd = endDateTime,
                    Status = "scheduled",
                    CreatedByUserId = AuthState.CurrentUser?.UserId,
                    Notes = appointmentNotes,
                    CreatedAt = DateTime.Now
                };

                DbContext.Appointments.Add(appointment);
                await DbContext.SaveChangesAsync();

                // Add services with per-service therapist assignment
                foreach (var serviceId in selectedServices)
                {
                    var service = services.First(s => s.ServiceId == serviceId);
                    var assignedTherapistId = serviceTherapistAssignments.GetValueOrDefault(serviceId, 0);
                    
                    var apptService = new AppointmentService
                    {
                        AppointmentId = appointment.AppointmentId,
                        ServiceId = serviceId,
                        TherapistEmployeeId = assignedTherapistId > 0 ? assignedTherapistId : null,
                        Price = service.Price,
                        CommissionAmount = 0
                    };
                    DbContext.AppointmentServices.Add(apptService);
                }
                await DbContext.SaveChangesAsync();
                
                // Audit log
                var customer = customers.FirstOrDefault(c => c.CustomerId == selectedCustomerId);
                await AuditLog.LogCreateAsync("Appointment", appointment.AppointmentId.ToString(), 
                    $"Booked appointment for {customer?.Person?.FirstName} {customer?.Person?.LastName} on {startDateTime:MMM dd, yyyy h:mm tt}", 
                    AuthState.CurrentUser?.UserId);

                successMessage = "Appointment booked successfully!";
            }

            showBookingDialog = false;
            await LoadData();

            // Clear success message after delay
            _ = Task.Run(async () =>
            {
                await Task.Delay(3000);
                await InvokeAsync(() =>
                {
                    successMessage = null;
                    StateHasChanged();
                });
            });
        }
        catch (Exception ex)
        {
            dialogError = $"Error saving appointment: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task UpdateStatus(long appointmentId, string newStatus)
    {
        try
        {
            var appointment = await DbContext.Appointments
                .Include(a => a.AppointmentServices)
                .FirstOrDefaultAsync(a => a.AppointmentId == appointmentId);
            if (appointment != null)
            {
                // Validate status transition
                if (!IsValidStatusTransition(appointment.Status, newStatus))
                {
                    errorMessage = $"Cannot change status from '{appointment.Status}' to '{newStatus}'. Invalid transition.";
                    return;
                }

                appointment.Status = newStatus;
                
                // Calculate commissions when status changes to completed - use SERVICE commission rates
                if (newStatus == STATUS_COMPLETED)
                {
                    foreach (var apptService in appointment.AppointmentServices)
                    {
                        if (apptService.TherapistEmployeeId.HasValue && apptService.Service != null)
                        {
                            // Use commission from the Service itself (not employee-specific)
                            var commValue = apptService.Service.CommissionValue;
                            var commType = apptService.Service.CommissionType ?? "percentage";
                            
                            if (commValue > 0)
                            {
                                apptService.CommissionAmount = commType == "percentage"
                                    ? (apptService.Price * commValue / 100)
                                    : commValue;
                            }
                        }
                    }
                }
                
                await DbContext.SaveChangesAsync();
                
                // Audit log status change
                await AuditLog.LogUpdateAsync("Appointment", appointmentId.ToString(), 
                    $"Status changed to '{newStatus}'", 
                    AuthState.CurrentUser?.UserId);
                
                successMessage = $"Appointment {newStatus}!";
                await LoadData();

                _ = Task.Run(async () =>
                {
                    await Task.Delay(3000);
                    await InvokeAsync(() =>
                    {
                        successMessage = null;
                        StateHasChanged();
                    });
                });
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error updating status: {ex.Message}";
        }
    }

    private void ViewDetails(Appointment appt)
    {
        viewingAppointment = appt;
        showDetailsDialog = true;
    }

    private void CloseDetailsDialog()
    {
        showDetailsDialog = false;
        viewingAppointment = null;
    }

    private void GoToCheckout(long appointmentId)
    {
        Navigation.NavigateTo($"/checkout/{appointmentId}");
    }

    private string GetStatusBorderColor(string status) => status switch
    {
        "scheduled" => "var(--spa-info)",
        "confirmed" => "var(--spa-accent)",
        "in-progress" => "var(--spa-warning)",
        "completed" => "var(--spa-success)",
        "paid" => "#6f42c1",
        "cancelled" => "var(--spa-danger)",
        _ => "var(--spa-secondary)"
    };

    private (string badgeClass, string text) GetStatusBadge(string status) => status switch
    {
        "scheduled" => ("badge-info", "Scheduled"),
        "confirmed" => ("badge-secondary", "Confirmed"),
        "in-progress" => ("badge-warning", "In Progress"),
        "completed" => ("badge-success", "Completed"),
        "paid" => ("badge-primary", "Paid"),
        "cancelled" => ("badge-danger", "Cancelled"),
        _ => ("badge-secondary", status)
    };
}

<style>
    /* Kanban Board Layout */
    .kanban-board {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        min-height: 500px;
    }

    .kanban-column {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 0.75rem;
        display: flex;
        flex-direction: column;
        border-top: 4px solid var(--spa-primary, #5a7a6b);
    }

    .column-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        margin-bottom: 0.75rem;
        font-weight: 600;
        color: var(--spa-primary, #5a7a6b);
    }

    .column-icon { font-size: 1.25rem; }
    .column-title { flex: 1; }
    
    .column-count {
        background: var(--spa-primary, #5a7a6b);
        color: white;
        padding: 0.25rem 0.6rem;
        border-radius: 12px;
        font-size: 0.85rem;
    }

    .column-cards {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    /* Appointment Cards - Unified neutral style */
    .appt-card {
        background: white;
        border-radius: 10px;
        padding: 0.85rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.06);
        border-left: 4px solid var(--spa-primary, #5a7a6b);
        transition: transform 0.15s, box-shadow 0.15s;
    }

    .appt-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .appt-card.paid { 
        opacity: 0.7;
        background: #f9f9f9;
    }

    .card-time {
        font-size: 0.75rem;
        color: #888;
        margin-bottom: 0.25rem;
    }

    .card-customer {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
        color: #2c3e50;
    }

    .card-services {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
        margin-bottom: 0.5rem;
    }

    .service-badge {
        background: #f0f0f0;
        color: #555;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        border: 1px solid #e0e0e0;
    }

    .more-badge {
        background: #e8e8e8;
        color: #666;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
    }

    .card-total {
        font-weight: 600;
        color: var(--spa-primary, #5a7a6b);
        margin-bottom: 0.5rem;
    }

    /* Progress Bar */
    .progress-bar {
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
        margin: 0.5rem 0;
    }

    .progress-fill {
        height: 100%;
        background: var(--spa-primary, #5a7a6b);
        border-radius: 3px;
        transition: width 0.3s;
    }

    .card-timer {
        font-size: 0.75rem;
        color: #888;
        margin-bottom: 0.5rem;
    }

    /* Action Buttons - Neutral colors */
    .card-actions {
        display: flex;
        gap: 0.35rem;
        flex-wrap: wrap;
    }

    .action-btn {
        padding: 0.3rem 0.6rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.15s;
        background: white;
        color: #555;
    }

    .action-btn:hover {
        background: var(--spa-primary, #5a7a6b);
        color: white;
        border-color: var(--spa-primary, #5a7a6b);
    }

    .action-btn.complete, .action-btn.checkout { 
        background: var(--spa-primary, #5a7a6b); 
        color: white; 
        flex: 1;
        border-color: var(--spa-primary, #5a7a6b);
    }

    .action-btn.cancel:hover { 
        background: #dc3545;
        border-color: #dc3545;
    }

    /* Empty State */
    .empty-column {
        text-align: center;
        padding: 2rem 1rem;
        color: #999;
        font-size: 0.85rem;
        font-style: italic;
    }

    /* Cancelled Section */
    .cancelled-section {
        margin-top: 1.5rem;
        background: #fee;
        border-radius: 8px;
        padding: 0.75rem;
    }

    .cancelled-section summary {
        cursor: pointer;
        font-weight: 500;
        color: #c0392b;
    }

    .cancelled-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-top: 0.75rem;
    }

    .cancelled-list .appt-card {
        opacity: 0.7;
        border-left-color: #e74c3c;
        max-width: 280px;
    }

    /* Responsive */
    @@media (max-width: 1200px) {
        .kanban-board {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 768px) {
        .kanban-board {
            grid-template-columns: 1fr;
        }
    }
</style>
