@page "/capital-investments"
@using Microsoft.EntityFrameworkCore
@using Spa_Management_System.Data
@using Spa_Management_System.Models
@using Spa_Management_System.Services
@inject AppDbContext DbContext
@inject IAuthStateService AuthState
@inject IJSRuntime JSRuntime

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><span class="bi bi-bank"></span> Capital & Investments</h2>
            <p class="text-muted mb-0">Manage owner's capital and equipment investments</p>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert @(isError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
            @message
            <button type="button" class="btn-close" @onclick="() => message = string.Empty"></button>
        </div>
    }

    <!-- Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100" style="background: #DCD8CE; color: #454F4A;">
                <div class="card-body">
                    <p style="margin: 0; font-size: 0.85rem;">Total Owner's Capital</p>
                    <h3 style="margin: 0.25rem 0 0 0; font-weight: 700;">₱@totalCapital.ToString("N2")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100" style="background: #DCD8CE; color: #454F4A;">
                <div class="card-body">
                    <p style="margin: 0; font-size: 0.85rem;">Total Equipment Value</p>
                    <h3 style="margin: 0.25rem 0 0 0; font-weight: 700;">₱@totalEquipment.ToString("N2")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100" style="background: #DCD8CE; color: #454F4A;">
                <div class="card-body">
                    <p style="margin: 0; font-size: 0.85rem;">Total Investments</p>
                    <h3 style="margin: 0.25rem 0 0 0; font-weight: 700;">₱@((totalCapital + totalEquipment).ToString("N2"))</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Owner's Capital Section -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><span class="bi bi-cash-stack me-2"></span>Owner's Capital</h5>
                    <button class="btn btn-primary btn-sm" @onclick="ShowAddCapitalModal">
                        <span class="bi bi-plus-lg"></span> Add Capital
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead style="background-color: #454F4A; color: white;">
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th class="text-end">Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (capitalEntries.Any())
                                {
                                    @foreach (var entry in capitalEntries)
                                    {
                                        <tr>
                                            <td>@entry.Date.ToString("MMM dd, yyyy")</td>
                                            <td>@entry.Description</td>
                                            <td class="text-end fw-bold text-success">₱@entry.Amount.ToString("N2")</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteCapital(entry)">
                                                    <span class="bi bi-trash"></span>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            <span class="bi bi-inbox fs-1 d-block mb-2"></span>
                                            No capital investments recorded
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Equipment Section -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><span class="bi bi-tools me-2"></span>Equipment & Assets</h5>
                    <button class="btn btn-primary btn-sm" @onclick="ShowAddEquipmentModal">
                        <span class="bi bi-plus-lg"></span> Add Equipment
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead style="background-color: #454F4A; color: white;">
                                <tr>
                                    <th>Date</th>
                                    <th>Equipment</th>
                                    <th class="text-end">Cost</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (equipmentEntries.Any())
                                {
                                    @foreach (var entry in equipmentEntries)
                                    {
                                        <tr>
                                            <td>@entry.Date.ToString("MMM dd, yyyy")</td>
                                            <td>
                                                <strong>@entry.Name</strong>
                                                @if (!string.IsNullOrEmpty(entry.Description))
                                                {
                                                    <br /><small class="text-muted">@entry.Description</small>
                                                }
                                            </td>
                                            <td class="text-end fw-bold">₱@entry.Cost.ToString("N2")</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteEquipment(entry)">
                                                    <span class="bi bi-trash"></span>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            <span class="bi bi-inbox fs-1 d-block mb-2"></span>
                                            No equipment recorded
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Capital Modal -->
@if (showCapitalModal)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #454F4A; color: white;">
                    <h5 class="modal-title"><span class="bi bi-cash-stack me-2"></span>Add Owner's Capital</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" @bind="capitalDate" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">₱</span>
                            <input type="number" class="form-control" @bind="capitalAmount" step="0.01" min="0" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" @bind="capitalDescription" placeholder="e.g., Initial capital investment" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveCapital" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        Save Capital
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Add Equipment Modal -->
@if (showEquipmentModal)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #454F4A; color: white;">
                    <h5 class="modal-title"><span class="bi bi-tools me-2"></span>Add Equipment</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Purchase Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" @bind="equipmentDate" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Equipment Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" @bind="equipmentName" placeholder="e.g., Massage Table" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Cost <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">₱</span>
                            <input type="number" class="form-control" @bind="equipmentCost" step="0.01" min="0" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description / Notes</label>
                        <textarea class="form-control" @bind="equipmentDescription" rows="2" placeholder="e.g., Brand, model, supplier..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveEquipment" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        Save Equipment
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<CapitalEntry> capitalEntries = new();
    private List<EquipmentEntry> equipmentEntries = new();
    
    private decimal totalCapital = 0;
    private decimal totalEquipment = 0;
    
    private bool showCapitalModal = false;
    private bool showEquipmentModal = false;
    private bool isSaving = false;
    private string message = string.Empty;
    private bool isError = false;
    
    // Capital form fields
    private DateTime capitalDate = DateTime.Today;
    private decimal capitalAmount = 0;
    private string capitalDescription = string.Empty;
    
    // Equipment form fields
    private DateTime equipmentDate = DateTime.Today;
    private string equipmentName = string.Empty;
    private decimal equipmentCost = 0;
    private string equipmentDescription = string.Empty;
    
    // Ledger Account IDs
    private const int CASH_ACCOUNT = 10032;        // 1000 - Cash on Hand
    private const int EQUIPMENT_ACCOUNT = 10036;   // 1500 - Equipment
    private const int OWNERS_CAPITAL_ACCOUNT = 10040;  // 3000 - Owner's Capital

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        // Load capital entries from journal entries
        capitalEntries = await DbContext.JournalEntries
            .Include(j => j.JournalEntryLines)
            .Where(j => j.Description.Contains("Owner's Capital") || j.Description.Contains("Capital Investment"))
            .OrderByDescending(j => j.Date)
            .Select(j => new CapitalEntry
            {
                JournalId = j.JournalId,
                Date = j.Date,
                Description = j.Description,
                Amount = j.JournalEntryLines.Where(l => l.LedgerAccountId == OWNERS_CAPITAL_ACCOUNT).Sum(l => l.Credit)
            })
            .ToListAsync();

        // Load equipment entries from journal entries
        equipmentEntries = await DbContext.JournalEntries
            .Include(j => j.JournalEntryLines)
            .Where(j => j.Description.Contains("Equipment Purchase") || j.Description.Contains("Equipment:"))
            .OrderByDescending(j => j.Date)
            .Select(j => new EquipmentEntry
            {
                JournalId = j.JournalId,
                Date = j.Date,
                Name = j.Description.Replace("Equipment Purchase: ", "").Replace("Equipment: ", ""),
                Description = j.JournalEntryLines.FirstOrDefault() != null ? j.JournalEntryLines.First().LineMemo : "",
                Cost = j.JournalEntryLines.Where(l => l.LedgerAccountId == EQUIPMENT_ACCOUNT).Sum(l => l.Debit)
            })
            .ToListAsync();

        // Calculate totals from ledger
        var capitalBalance = await DbContext.JournalEntryLines
            .Where(l => l.LedgerAccountId == OWNERS_CAPITAL_ACCOUNT)
            .SumAsync(l => l.Credit - l.Debit);
        totalCapital = capitalBalance;

        var equipmentBalance = await DbContext.JournalEntryLines
            .Where(l => l.LedgerAccountId == EQUIPMENT_ACCOUNT)
            .SumAsync(l => l.Debit - l.Credit);
        totalEquipment = equipmentBalance;
    }

    private void ShowAddCapitalModal()
    {
        capitalDate = DateTime.Today;
        capitalAmount = 0;
        capitalDescription = "Capital Investment";
        showCapitalModal = true;
    }

    private void ShowAddEquipmentModal()
    {
        equipmentDate = DateTime.Today;
        equipmentName = string.Empty;
        equipmentCost = 0;
        equipmentDescription = string.Empty;
        showEquipmentModal = true;
    }

    private void CloseModals()
    {
        showCapitalModal = false;
        showEquipmentModal = false;
    }

    private async Task SaveCapital()
    {
        if (capitalAmount <= 0)
        {
            message = "Please enter a valid amount.";
            isError = true;
            return;
        }

        isSaving = true;
        try
        {
            var currentUser = AuthState.CurrentUser;
            var journalNo = $"JE-CAP-{DateTime.Now:yyyyMMddHHmmss}";

            // Create journal entry
            var journalEntry = new JournalEntry
            {
                JournalNo = journalNo,
                Date = capitalDate,
                Description = string.IsNullOrEmpty(capitalDescription) ? "Owner's Capital Investment" : $"Owner's Capital - {capitalDescription}",
                CreatedByUserId = currentUser?.UserId ?? 10,
                CreatedAt = DateTime.Now,
                SyncStatus = "pending"
            };

            DbContext.JournalEntries.Add(journalEntry);
            await DbContext.SaveChangesAsync();

            // Create journal lines
            // Debit: Cash (increase asset)
            var debitLine = new JournalEntryLine
            {
                JournalId = journalEntry.JournalId,
                LedgerAccountId = CASH_ACCOUNT,
                Debit = capitalAmount,
                Credit = 0,
                LineMemo = "Cash received from owner",
                SyncStatus = "pending"
            };

            // Credit: Owner's Capital (increase equity)
            var creditLine = new JournalEntryLine
            {
                JournalId = journalEntry.JournalId,
                LedgerAccountId = OWNERS_CAPITAL_ACCOUNT,
                Debit = 0,
                Credit = capitalAmount,
                LineMemo = capitalDescription,
                SyncStatus = "pending"
            };

            DbContext.JournalEntryLines.Add(debitLine);
            DbContext.JournalEntryLines.Add(creditLine);
            await DbContext.SaveChangesAsync();

            message = $"Capital investment of ₱{capitalAmount:N2} recorded successfully!";
            isError = false;
            CloseModals();
            await LoadData();
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
            isError = true;
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task SaveEquipment()
    {
        if (string.IsNullOrWhiteSpace(equipmentName))
        {
            message = "Please enter equipment name.";
            isError = true;
            return;
        }

        if (equipmentCost <= 0)
        {
            message = "Please enter a valid cost.";
            isError = true;
            return;
        }

        isSaving = true;
        try
        {
            var currentUser = AuthState.CurrentUser;
            var journalNo = $"JE-EQP-{DateTime.Now:yyyyMMddHHmmss}";

            // Create journal entry
            var journalEntry = new JournalEntry
            {
                JournalNo = journalNo,
                Date = equipmentDate,
                Description = $"Equipment Purchase: {equipmentName}",
                CreatedByUserId = currentUser?.UserId ?? 10,
                CreatedAt = DateTime.Now,
                SyncStatus = "pending"
            };

            DbContext.JournalEntries.Add(journalEntry);
            await DbContext.SaveChangesAsync();

            // Create journal lines
            // Debit: Equipment (increase asset)
            var debitLine = new JournalEntryLine
            {
                JournalId = journalEntry.JournalId,
                LedgerAccountId = EQUIPMENT_ACCOUNT,
                Debit = equipmentCost,
                Credit = 0,
                LineMemo = equipmentDescription,
                SyncStatus = "pending"
            };

            // Credit: Cash (decrease asset - paid for equipment)
            var creditLine = new JournalEntryLine
            {
                JournalId = journalEntry.JournalId,
                LedgerAccountId = CASH_ACCOUNT,
                Debit = 0,
                Credit = equipmentCost,
                LineMemo = $"Payment for {equipmentName}",
                SyncStatus = "pending"
            };

            DbContext.JournalEntryLines.Add(debitLine);
            DbContext.JournalEntryLines.Add(creditLine);
            await DbContext.SaveChangesAsync();

            message = $"Equipment '{equipmentName}' (₱{equipmentCost:N2}) recorded successfully!";
            isError = false;
            CloseModals();
            await LoadData();
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
            isError = true;
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteCapital(CapitalEntry entry)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete this capital entry of ₱{entry.Amount:N2}?");
        if (!confirmed) return;

        try
        {
            var journal = await DbContext.JournalEntries
                .Include(j => j.JournalEntryLines)
                .FirstOrDefaultAsync(j => j.JournalId == entry.JournalId);

            if (journal != null)
            {
                DbContext.JournalEntryLines.RemoveRange(journal.JournalEntryLines);
                DbContext.JournalEntries.Remove(journal);
                await DbContext.SaveChangesAsync();

                message = "Capital entry deleted successfully.";
                isError = false;
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            message = $"Error deleting: {ex.Message}";
            isError = true;
        }
    }

    private async Task DeleteEquipment(EquipmentEntry entry)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{entry.Name}'?");
        if (!confirmed) return;

        try
        {
            var journal = await DbContext.JournalEntries
                .Include(j => j.JournalEntryLines)
                .FirstOrDefaultAsync(j => j.JournalId == entry.JournalId);

            if (journal != null)
            {
                DbContext.JournalEntryLines.RemoveRange(journal.JournalEntryLines);
                DbContext.JournalEntries.Remove(journal);
                await DbContext.SaveChangesAsync();

                message = "Equipment entry deleted successfully.";
                isError = false;
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            message = $"Error deleting: {ex.Message}";
            isError = true;
        }
    }

    // Helper classes
    private class CapitalEntry
    {
        public long JournalId { get; set; }
        public DateTime Date { get; set; }
        public string Description { get; set; } = string.Empty;
        public decimal Amount { get; set; }
    }

    private class EquipmentEntry
    {
        public long JournalId { get; set; }
        public DateTime Date { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public decimal Cost { get; set; }
    }
}
