@page "/sync"
@using Spa_Management_System.Services
@using Spa_Management_System.Models
@inject ISyncService SyncService
@inject IAutoSyncService AutoSyncService
@inject IAuthStateService AuthState
@inject NavigationManager Navigation
@implements IDisposable

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><span class="bi bi-cloud-arrow-up-fill me-2"></span>Cloud Sync</h2>
            <p class="text-muted mb-0">Sync your local data with the cloud backup</p>
        </div>
        <div>
            <span class="badge @GetStatusBadgeClass() fs-6 p-2">
                @GetSyncStatusText()
            </span>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Success:</strong> @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
        </div>
    }

    <!-- Sync Status Card -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title mb-3"><span class="bi bi-bar-chart-fill me-2"></span>Sync Status</h5>
                    <div class="mb-3">
                        <strong>Last Sync:</strong>
                        <span class="ms-2">
                            @if (syncStatus?.LastSyncTime.HasValue == true)
                            {
                                <span class="text-success">@syncStatus.LastSyncTime.Value.ToString("MMM dd, yyyy hh:mm tt")</span>
                            }
                            else
                            {
                                <span class="text-muted">Never synced</span>
                            }
                        </span>
                    </div>
                    <div class="mb-3">
                        <strong>Pending Changes:</strong>
                        <span class="ms-2 badge @((syncStatus?.TotalPending ?? 0) > 0 ? "bg-warning" : "bg-success")">
                            @(syncStatus?.TotalPending ?? 0) records
                        </span>
                    </div>
                    <div>
                        <strong>Connection Status:</strong>
                        <span class="ms-2">
                            @if (syncStatus?.IsConfigured == true)
                            {
                                <span class="text-success"><span class="bi bi-check-circle-fill me-1"></span>Cloud API Configured</span>
                            }
                            else
                            {
                                <span class="text-warning"><span class="bi bi-exclamation-triangle-fill me-1"></span>Cloud API Not Configured</span>
                            }
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title mb-3"><span class="bi bi-gear-fill me-2"></span>Sync Settings</h5>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoSync" 
                                   @bind="autoSyncEnabled" @bind:after="SaveSettings">
                            <label class="form-check-label" for="autoSync">
                                Enable Auto-Sync
                            </label>
                        </div>
                        @if (autoSyncEnabled && AutoSyncService.IsRunning)
                        {
                            <small class="text-success">
                                <span class="bi bi-check-circle-fill me-1"></span>Auto-sync is active
                                @if (AutoSyncService.LastAutoSyncTime.HasValue)
                                {
                                    <span class="ms-2">(Last: @AutoSyncService.LastAutoSyncTime.Value.ToString("hh:mm tt"))</span>
                                }
                            </small>
                            @if (countdownSeconds > 0)
                            {
                                <div class="mt-2">
                                    <small class="text-info">
                                        <span class="bi bi-clock me-1"></span>
                                        Next sync in: <strong>@FormatCountdown()</strong>
                                    </small>
                                    <div class="progress mt-1" style="height: 4px;">
                                        <div class="progress-bar bg-info" role="progressbar" 
                                             style="width: @GetCountdownProgress()%"></div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sync Interval (minutes)</label>
                        <select class="form-select" @bind="syncIntervalMinutes" @bind:after="SaveSettings" 
                                disabled="@(!autoSyncEnabled)">
                            <option value="5">Every 5 minutes</option>
                            <option value="15">Every 15 minutes</option>
                            <option value="30">Every 30 minutes</option>
                            <option value="60">Every hour</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Sync Actions -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-4"><span class="bi bi-arrow-repeat me-2"></span>Manual Sync</h5>
            
            @if (isSyncing)
            {
                <div class="mb-3">
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: @syncProgress.PercentComplete%">
                            @syncProgress.PercentComplete% - @syncProgress.CurrentOperation @syncProgress.CurrentEntity
                        </div>
                    </div>
                </div>
            }
            
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="d-grid">
                        <button class="btn btn-primary btn-lg" @onclick="FullSync" disabled="@isSyncing">
                            @if (isSyncing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <span class="bi bi-arrow-repeat me-1"></span> Full Sync
                        </button>
                        <small class="text-muted mt-1 text-center">Upload & Download all changes</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-grid">
                        <button class="btn btn-outline-success btn-lg" @onclick="SyncPending" disabled="@isSyncing">
                            @if (isSyncing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <span class="bi bi-cloud-upload me-1"></span> Sync Pending Only
                        </button>
                        <small class="text-muted mt-1 text-center">Push pending local changes to cloud</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-grid">
                        <button class="btn btn-warning btn-lg" @onclick="PushAllData" disabled="@isSyncing">
                            @if (isSyncing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <span class="bi bi-cloud-arrow-up-fill me-1"></span> Push ALL Data
                        </button>
                        <small class="text-muted mt-1 text-center">Force upload ALL local data to cloud</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-grid">
                        <button class="btn btn-info btn-lg text-white" @onclick="PullAllData" disabled="@isSyncing">
                            @if (isSyncing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <span class="bi bi-cloud-arrow-down-fill me-1"></span> Pull from Cloud
                        </button>
                        <small class="text-muted mt-1 text-center">Download ALL data from cloud (new device)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Changes Details -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><span class="bi bi-list-check me-2"></span>Pending Changes by Entity</h5>
        </div>
        <div class="card-body">
            @if (syncStatus?.PendingCounts?.Any(x => x.Value > 0) == true)
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Entity Type</th>
                                <th>Pending Records</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var entity in syncStatus.PendingCounts.Where(x => x.Value > 0))
                            {
                                <tr>
                                    <td>
                                        <strong>@entity.Key</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning">@entity.Value</span>
                                    </td>
                                    <td>
                                        <span class="text-warning"><span class="bi bi-hourglass-split me-1"></span>Waiting to sync</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4 text-muted">
                    <p class="mb-0"><span class="bi bi-check-circle-fill text-success me-1"></span>All data is synced!</p>
                </div>
            }
        </div>
    </div>

    <!-- Last Sync Result -->
    @if (lastSyncResult != null)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><span class="bi bi-clipboard-check me-2"></span>Last Sync Result</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="@(lastSyncResult.Success ? "text-success" : "text-danger")">
                                <span class="bi @(lastSyncResult.Success ? "bi-check-circle-fill" : "bi-x-circle-fill")"></span>
                            </h3>
                            <small>@(lastSyncResult.Success ? "Success" : "Failed")</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-primary">@lastSyncResult.RecordsUploaded</h3>
                            <small>Uploaded</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-info">@lastSyncResult.RecordsDownloaded</h3>
                            <small>Downloaded</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3>@lastSyncResult.Duration.TotalSeconds.ToString("F1")s</h3>
                            <small>Duration</small>
                        </div>
                    </div>
                </div>
                
                @if (lastSyncResult.Errors.Any())
                {
                    <div class="mt-3">
                        <strong class="text-danger">Errors:</strong>
                        <ul class="mb-0 text-danger">
                            @foreach (var error in lastSyncResult.Errors)
                            {
                                <li>@error</li>
                            }
                        </ul>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Cloud API Configuration -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><span class="bi bi-wrench me-2"></span>Cloud API Configuration</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">API Base URL</label>
                    <input type="url" class="form-control" @bind="apiBaseUrl" 
                           placeholder="http://localhost:5295">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">API Key</label>
                    <input type="text" class="form-control" @bind="apiKey" 
                           placeholder="Your API key">
                </div>
            </div>
            <button class="btn btn-primary" @onclick="TestConnection" disabled="@isTesting">
                @if (isTesting)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                }
                <span class="bi bi-plug me-1"></span> Test Connection
            </button>
            <button class="btn btn-success ms-2" @onclick="SaveApiConfig">
                <span class="bi bi-save me-1"></span> Save Configuration
            </button>
        </div>
    </div>
</div>

@code {
    private bool isSyncing = false;
    private bool isTesting = false;
    private string errorMessage = "";
    private string successMessage = "";
    
    private SyncStatusSummary? syncStatus;
    private SyncProgress syncProgress = new();
    private SyncResult? lastSyncResult;
    
    private bool autoSyncEnabled = false;
    private int syncIntervalMinutes = 60;
    
    private string apiBaseUrl = "";
    private string apiKey = "";
    
    // Countdown timer
    private CancellationTokenSource? countdownCts;
    private int countdownSeconds = 0;
    private int totalIntervalSeconds = 0;

    protected override async Task OnInitializedAsync()
    {
        // Check auth - only SuperAdmin can access sync
        if (!AuthState.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        var role = AuthState.GetUserRole();
        if (!role.Equals("SuperAdmin", StringComparison.OrdinalIgnoreCase) && 
            !role.Equals("Admin", StringComparison.OrdinalIgnoreCase))
        {
            Navigation.NavigateTo("/");
            return;
        }

        // Subscribe to auto-sync completion events
        AutoSyncService.OnAutoSyncCompleted += OnAutoSyncCompleted;

        await LoadSyncStatus();
        LoadSettings();
        
        // Start countdown timer if auto-sync is enabled
        StartCountdownTimer();
    }
    
    private void StartCountdownTimer()
    {
        // Cancel any existing countdown
        countdownCts?.Cancel();
        countdownCts?.Dispose();
        
        if (autoSyncEnabled && AutoSyncService.IsRunning)
        {
            totalIntervalSeconds = syncIntervalMinutes * 60;
            UpdateCountdown();
            
            // Start new countdown loop
            countdownCts = new CancellationTokenSource();
            _ = RunCountdownLoop(countdownCts.Token);
        }
        else
        {
            countdownSeconds = 0;
        }
    }
    
    private async Task RunCountdownLoop(CancellationToken cancellationToken)
    {
        try
        {
            while (!cancellationToken.IsCancellationRequested)
            {
                await Task.Delay(1000, cancellationToken);
                
                if (countdownSeconds > 0)
                {
                    countdownSeconds--;
                }
                else
                {
                    UpdateCountdown();
                }
                
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (TaskCanceledException)
        {
            // Timer was cancelled, this is expected
        }
    }
    
    private void UpdateCountdown()
    {
        // Use NextSyncTime from the service - this persists across page navigations
        if (AutoSyncService.NextSyncTime.HasValue)
        {
            var remaining = AutoSyncService.NextSyncTime.Value - DateTime.Now;
            
            if (remaining.TotalSeconds > 0)
            {
                countdownSeconds = (int)remaining.TotalSeconds;
            }
            else
            {
                countdownSeconds = 0;
            }
        }
        else
        {
            // Fallback if NextSyncTime not set yet
            countdownSeconds = totalIntervalSeconds;
        }
    }
    
    private string FormatCountdown()
    {
        var minutes = countdownSeconds / 60;
        var seconds = countdownSeconds % 60;
        
        if (minutes > 0)
        {
            return $"{minutes}m {seconds:D2}s";
        }
        return $"{seconds}s";
    }
    
    private int GetCountdownProgress()
    {
        if (totalIntervalSeconds <= 0) return 100;
        return (int)((double)(totalIntervalSeconds - countdownSeconds) / totalIntervalSeconds * 100);
    }

    private async void OnAutoSyncCompleted(object? sender, AutoSyncEventArgs e)
    {
        await InvokeAsync(async () =>
        {
            if (e.Success)
            {
                if (e.RecordsUploaded > 0)
                {
                    successMessage = $"Auto-sync completed at {e.SyncTime:hh:mm tt}! Uploaded: {e.RecordsUploaded} records";
                }
            }
            else
            {
                errorMessage = $"Auto-sync failed: {e.ErrorMessage}";
            }
            
            await LoadSyncStatus();
            
            // Reset countdown after sync completes
            UpdateCountdown();
            
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        AutoSyncService.OnAutoSyncCompleted -= OnAutoSyncCompleted;
        countdownCts?.Cancel();
        countdownCts?.Dispose();
    }

    private async Task LoadSyncStatus()
    {
        try
        {
            syncStatus = await SyncService.GetSyncStatusAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load sync status: {ex.Message}";
        }
    }

    private void LoadSettings()
    {
        var settings = SyncService.GetSettings();
        autoSyncEnabled = settings.AutoSyncEnabled;
        syncIntervalMinutes = settings.SyncIntervalMinutes;
        apiBaseUrl = settings.ApiUrl;
        apiKey = settings.ApiKey;
    }

    private async Task SaveSettings()
    {
        var settings = SyncService.GetSettings();
        settings.AutoSyncEnabled = autoSyncEnabled;
        settings.SyncIntervalMinutes = syncIntervalMinutes;
        await SyncService.SaveSettingsAsync(settings);

        // Start or stop auto-sync based on toggle
        if (autoSyncEnabled)
        {
            AutoSyncService.UpdateInterval(syncIntervalMinutes);
            AutoSyncService.Start();
        }
        else
        {
            AutoSyncService.Stop();
        }
        
        // Restart countdown timer with new settings
        StartCountdownTimer();
    }

    private async Task FullSync()
    {
        isSyncing = true;
        errorMessage = "";
        successMessage = "";
        syncProgress = new SyncProgress();
        StateHasChanged();
        
        try
        {
            var progress = new Progress<SyncProgress>(p =>
            {
                syncProgress = p;
                InvokeAsync(StateHasChanged);
            });
            
            lastSyncResult = await SyncService.SyncAllAsync(progress);
            
            if (lastSyncResult.Success)
            {
                successMessage = $"Full sync completed! Uploaded: {lastSyncResult.RecordsUploaded}, Downloaded: {lastSyncResult.RecordsDownloaded}";
            }
            else
            {
                errorMessage = lastSyncResult.ErrorMessage ?? "Sync failed";
                if (lastSyncResult.Errors?.Any() == true)
                {
                    errorMessage += "\n\nErrors:\n" + string.Join("\n", lastSyncResult.Errors);
                }
            }
            
            await LoadSyncStatus();
        }
        catch (Exception ex)
        {
            errorMessage = $"Sync error: {ex.Message}";
        }
        finally
        {
            isSyncing = false;
        }
    }

    private async Task SyncPending()
    {
        isSyncing = true;
        errorMessage = "";
        successMessage = "";
        syncProgress = new SyncProgress();
        StateHasChanged();
        
        try
        {
            // Check if there's any pending data to sync
            if (syncStatus == null || syncStatus.TotalPending == 0)
            {
                errorMessage = "No data to sync yet. All records are already synchronized.";
                return;
            }
            
            var progress = new Progress<SyncProgress>(p =>
            {
                syncProgress = p;
                InvokeAsync(StateHasChanged);
            });
            
            lastSyncResult = await SyncService.SyncPendingAsync(progress);
            
            if (lastSyncResult.Success)
            {
                successMessage = $"Pending sync completed! Uploaded: {lastSyncResult.RecordsUploaded}";
            }
            else
            {
                errorMessage = lastSyncResult.ErrorMessage ?? "Sync failed";
            }
            
            await LoadSyncStatus();
        }
        catch (Exception ex)
        {
            errorMessage = $"Sync error: {ex.Message}";
        }
        finally
        {
            isSyncing = false;
        }
    }

    private async Task PushAllData()
    {
        isSyncing = true;
        errorMessage = "";
        successMessage = "";
        syncProgress = new SyncProgress();
        StateHasChanged();
        
        try
        {
            var progress = new Progress<SyncProgress>(p =>
            {
                syncProgress = p;
                InvokeAsync(StateHasChanged);
            });
            
            lastSyncResult = await SyncService.PushAllDataAsync(progress);
            
            if (lastSyncResult.Success)
            {
                successMessage = $"Push completed! {lastSyncResult.RecordsUploaded} records backed up to cloud.";
            }
            else
            {
                errorMessage = lastSyncResult.ErrorMessage ?? "Push failed";
                if (lastSyncResult.Errors.Any())
                {
                    errorMessage += " - " + string.Join(", ", lastSyncResult.Errors);
                }
            }
            
            await LoadSyncStatus();
        }
        catch (Exception ex)
        {
            errorMessage = $"Push error: {ex.Message}";
        }
        finally
        {
            isSyncing = false;
        }
    }

    private async Task PullAllData()
    {
        isSyncing = true;
        errorMessage = "";
        successMessage = "";
        syncProgress = new SyncProgress();
        StateHasChanged();
        
        try
        {
            var progress = new Progress<SyncProgress>(p =>
            {
                syncProgress = p;
                InvokeAsync(StateHasChanged);
            });
            
            lastSyncResult = await SyncService.PullAllDataAsync(progress);
            
            if (lastSyncResult.Success)
            {
                successMessage = $"Pull completed! {lastSyncResult.RecordsDownloaded} records restored from cloud.";
            }
            else
            {
                errorMessage = lastSyncResult.ErrorMessage ?? "Pull failed";
                if (lastSyncResult.Errors.Any())
                {
                    errorMessage += " - " + string.Join(", ", lastSyncResult.Errors);
                }
            }
            
            await LoadSyncStatus();
        }
        catch (Exception ex)
        {
            errorMessage = $"Pull error: {ex.Message}";
        }
        finally
        {
            isSyncing = false;
        }
    }

    private async Task TestConnection()
    {
        if (string.IsNullOrEmpty(apiBaseUrl))
        {
            errorMessage = "Please enter an API URL";
            return;
        }
        
        isTesting = true;
        errorMessage = "";
        successMessage = "";
        
        try
        {
            // Save settings first so test uses new URL
            var settings = SyncService.GetSettings();
            settings.ApiUrl = apiBaseUrl;
            settings.ApiKey = apiKey;
            await SyncService.SaveSettingsAsync(settings);
            
            var connected = await SyncService.TestConnectionAsync();
            
            if (connected)
            {
                successMessage = "Connection successful! Cloud API is reachable.";
                await LoadSyncStatus();
            }
            else
            {
                errorMessage = "Connection failed. Please check the URL and try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Connection failed: {ex.Message}";
        }
        finally
        {
            isTesting = false;
        }
    }

    private async Task SaveApiConfig()
    {
        try
        {
            var settings = SyncService.GetSettings();
            settings.ApiUrl = apiBaseUrl;
            settings.ApiKey = apiKey;
            await SyncService.SaveSettingsAsync(settings);
            
            successMessage = "API configuration saved successfully!";
            await LoadSyncStatus();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save configuration: {ex.Message}";
        }
    }

    private string GetStatusBadgeClass()
    {
        if (isSyncing) return "bg-warning";
        if ((syncStatus?.TotalPending ?? 0) > 0) return "bg-info";
        return "bg-success";
    }

    private string GetSyncStatusText()
    {
        if (isSyncing) return "Syncing...";
        var pending = syncStatus?.TotalPending ?? 0;
        if (pending > 0) return $"{pending} Pending";
        return "Up to Date";
    }
}
