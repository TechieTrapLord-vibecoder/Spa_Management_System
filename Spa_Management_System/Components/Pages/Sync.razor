@page "/sync"
@using Spa_Management_System.Services
@using Spa_Management_System.Models
@inject ISyncService SyncService
@inject IAutoSyncService AutoSyncService
@inject IAuthStateService AuthState
@inject NavigationManager Navigation
@inject IToastService Toast
@implements IDisposable

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><span class="bi bi-cloud-arrow-up-fill me-2"></span>Cloud Sync</h2>
            <p class="text-muted mb-0">Sync your local data with the cloud backup</p>
        </div>
        <div>
            <span class="badge @GetStatusBadgeClass() fs-6 p-2">
                @GetSyncStatusText()
            </span>
        </div>
    </div>

    <!-- Sync Status Card -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title mb-3"><span class="bi bi-bar-chart-fill me-2"></span>Sync Status</h5>
                    <div class="mb-3">
                        <strong>Last Sync:</strong>
                        <span class="ms-2">
                            @if (syncStatus?.LastSyncTime.HasValue == true)
                            {
                                <span class="text-success">@syncStatus.LastSyncTime.Value.ToString("MMM dd, yyyy hh:mm tt")</span>
                            }
                            else
                            {
                                <span class="text-muted">Never synced</span>
                            }
                        </span>
                    </div>
                    <div class="mb-3">
                        <strong>Pending Changes:</strong>
                        <span class="ms-2 badge @((syncStatus?.TotalPending ?? 0) > 0 ? "bg-warning" : "bg-success")">
                            @(syncStatus?.TotalPending ?? 0) records
                        </span>
                    </div>
                    <div>
                        <strong>Connection Status:</strong>
                        <span class="ms-2">
                            @if (syncStatus?.IsConfigured == true)
                            {
                                <span class="text-success"><span class="bi bi-check-circle-fill me-1"></span>Cloud API Configured</span>
                            }
                            else
                            {
                                <span class="text-warning"><span class="bi bi-exclamation-triangle-fill me-1"></span>Cloud API Not Configured</span>
                            }
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title mb-3"><span class="bi bi-gear-fill me-2"></span>Sync Settings</h5>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoSync" 
                                   @bind="autoSyncEnabled" @bind:after="SaveSettings">
                            <label class="form-check-label" for="autoSync">
                                Enable Auto-Sync
                            </label>
                        </div>
                        @if (autoSyncEnabled && AutoSyncService.IsRunning)
                        {
                            <small class="text-success">
                                <span class="bi bi-check-circle-fill me-1"></span>Auto-sync is active
                                @if (AutoSyncService.LastAutoSyncTime.HasValue)
                                {
                                    <span class="ms-2">(Last: @AutoSyncService.LastAutoSyncTime.Value.ToString("hh:mm tt"))</span>
                                }
                            </small>
                            @if (countdownSeconds > 0)
                            {
                                <div class="mt-2">
                                    <small class="text-info">
                                        <span class="bi bi-clock me-1"></span>
                                        Next sync in: <strong>@FormatCountdown()</strong>
                                    </small>
                                    <div class="progress mt-1" style="height: 4px;">
                                        <div class="progress-bar bg-info" role="progressbar" 
                                             style="width: @GetCountdownProgress()%"></div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sync Interval (minutes)</label>
                        <select class="form-select" @bind="syncIntervalMinutes" @bind:after="SaveSettings" 
                                disabled="@(!autoSyncEnabled)">
                            <option value="5">Every 5 minutes</option>
                            <option value="15">Every 15 minutes</option>
                            <option value="30">Every 30 minutes</option>
                            <option value="60">Every hour</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Sync Actions -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-4"><span class="bi bi-arrow-repeat me-2"></span>Manual Sync</h5>
            
            @if (isSyncing)
            {
                <div class="mb-3">
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: @syncProgress.PercentComplete%">
                            @syncProgress.PercentComplete% - @syncProgress.CurrentOperation @syncProgress.CurrentEntity
                        </div>
                    </div>
                </div>
            }
            
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="d-grid">
                        <button class="btn btn-primary btn-lg" @onclick="FullSync" disabled="@isSyncing">
                            @if (isSyncing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <span class="bi bi-arrow-repeat me-1"></span> Full Sync
                        </button>
                        <small class="text-muted mt-1 text-center">Upload & Download all changes</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-grid">
                        <button class="btn btn-outline-success btn-lg" @onclick="SyncPending" disabled="@isSyncing">
                            @if (isSyncing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <span class="bi bi-cloud-upload me-1"></span> Sync Pending Only
                        </button>
                        <small class="text-muted mt-1 text-center">Push pending local changes to cloud</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-grid">
                        <button class="btn btn-warning btn-lg" @onclick="PushAllData" disabled="@isSyncing">
                            @if (isSyncing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <span class="bi bi-cloud-arrow-up-fill me-1"></span> Push ALL Data
                        </button>
                        <small class="text-muted mt-1 text-center">Force upload ALL local data to cloud</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-grid">
                        <button class="btn btn-info btn-lg text-white" @onclick="PullAllData" disabled="@isSyncing">
                            @if (isSyncing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <span class="bi bi-cloud-arrow-down-fill me-1"></span> Pull from Cloud
                        </button>
                        <small class="text-muted mt-1 text-center">Download ALL data from cloud (new device)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Changes Details -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><span class="bi bi-list-check me-2"></span>Pending Changes by Entity</h5>
        </div>
        <div class="card-body">
            @if (syncStatus?.PendingCounts?.Any(x => x.Value > 0) == true)
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Entity Type</th>
                                <th>Pending Records</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var entity in syncStatus.PendingCounts.Where(x => x.Value > 0))
                            {
                                <tr>
                                    <td>
                                        <strong>@entity.Key</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning">@entity.Value</span>
                                    </td>
                                    <td>
                                        <span class="text-warning"><span class="bi bi-hourglass-split me-1"></span>Waiting to sync</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4 text-muted">
                    <p class="mb-0"><span class="bi bi-check-circle-fill text-success me-1"></span>All data is synced!</p>
                </div>
            }
        </div>
    </div>

    <!-- Last Sync Result -->
    @if (lastSyncResult != null)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><span class="bi bi-clipboard-check me-2"></span>Last Sync Result</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="@(lastSyncResult.Success ? "text-success" : "text-danger")">
                                <span class="bi @(lastSyncResult.Success ? "bi-check-circle-fill" : "bi-x-circle-fill")"></span>
                            </h3>
                            <small>@(lastSyncResult.Success ? "Success" : "Failed")</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-primary">@lastSyncResult.RecordsUploaded</h3>
                            <small>Uploaded</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-info">@lastSyncResult.RecordsDownloaded</h3>
                            <small>Downloaded</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3>@lastSyncResult.Duration.TotalSeconds.ToString("F1")s</h3>
                            <small>Duration</small>
                        </div>
                    </div>
                </div>
                
                @if (lastSyncResult.Errors.Any())
                {
                    @if (IsOfflineError(lastSyncResult.Errors))
                    {
                        <!-- User-friendly offline message -->
                        <div class="mt-3 p-3 bg-warning bg-opacity-10 border border-warning rounded">
                            <div class="d-flex align-items-start">
                                <span class="bi bi-wifi-off text-warning fs-3 me-3"></span>
                                <div>
                                    <h6 class="text-warning mb-1">No Internet Connection</h6>
                                    <p class="mb-2 text-muted">
                                        Unable to connect to the cloud server. Your data is saved locally and will sync automatically when internet is available.
                                    </p>
                                    <small class="text-muted">
                                        <span class="bi bi-info-circle me-1"></span>
                                        Don't worry! Your @(syncStatus?.TotalPending ?? 0) pending changes are safe and will be uploaded once connected.
                                    </small>
                                </div>
                            </div>
                        </div>
                    }
                    else if (IsServerError(lastSyncResult.Errors))
                    {
                        <!-- Server error message -->
                        <div class="mt-3 p-3 bg-danger bg-opacity-10 border border-danger rounded">
                            <div class="d-flex align-items-start">
                                <span class="bi bi-server text-danger fs-3 me-3"></span>
                                <div>
                                    <h6 class="text-danger mb-1">Cloud Server Issue</h6>
                                    <p class="mb-2 text-muted">
                                        The cloud server is temporarily unavailable. Please try again in a few minutes.
                                    </p>
                                    <small class="text-muted">
                                        <span class="bi bi-info-circle me-1"></span>
                                        Your data is safe locally. Contact support if this persists.
                                    </small>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <!-- Other errors with details -->
                        <div class="mt-3 p-3 bg-danger bg-opacity-10 border border-danger rounded">
                            <div class="d-flex align-items-start">
                                <span class="bi bi-exclamation-triangle text-danger fs-3 me-3"></span>
                                <div class="flex-grow-1">
                                    <h6 class="text-danger mb-1">Sync Issues</h6>
                                    <p class="mb-2 text-muted">
                                        Some records could not be synced. Your data is safe locally.
                                    </p>
                                    <details class="mt-2">
                                        <summary class="text-muted" style="cursor: pointer;">
                                            <small>Show technical details (@lastSyncResult.Errors.Count errors)</small>
                                        </summary>
                                        <ul class="mb-0 mt-2 text-danger small">
                                            @foreach (var error in lastSyncResult.Errors.Take(5))
                                            {
                                                <li>@GetFriendlyError(error)</li>
                                            }
                                            @if (lastSyncResult.Errors.Count > 5)
                                            {
                                                <li class="text-muted">... and @(lastSyncResult.Errors.Count - 5) more</li>
                                            }
                                        </ul>
                                    </details>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    }

    <!-- Cloud API Configuration -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><span class="bi bi-wrench me-2"></span>Cloud API Configuration</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">API Base URL</label>
                    <input type="url" class="form-control" @bind="apiBaseUrl" 
                           placeholder="http://localhost:5295">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">API Key</label>
                    <input type="text" class="form-control" @bind="apiKey" 
                           placeholder="Your API key">
                </div>
            </div>
            <button class="btn btn-primary" @onclick="TestConnection" disabled="@isTesting">
                @if (isTesting)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                }
                <span class="bi bi-plug me-1"></span> Test Connection
            </button>
            <button class="btn btn-success ms-2" @onclick="SaveApiConfig">
                <span class="bi bi-save me-1"></span> Save Configuration
            </button>
        </div>
    </div>
</div>

@code {
    private bool isSyncing = false;
    private bool isTesting = false;
    
    private SyncStatusSummary? syncStatus;
    private SyncProgress syncProgress = new();
    private SyncResult? lastSyncResult;
    
    private bool autoSyncEnabled = false;
    private int syncIntervalMinutes = 60;
    
    private string apiBaseUrl = "";
    private string apiKey = "";
    
    // Countdown timer
    private CancellationTokenSource? countdownCts;
    private int countdownSeconds = 0;
    private int totalIntervalSeconds = 0;

    protected override async Task OnInitializedAsync()
    {
        // Check auth - only SuperAdmin can access sync
        if (!AuthState.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        var role = AuthState.GetUserRole();
        if (!role.Equals("SuperAdmin", StringComparison.OrdinalIgnoreCase) && 
            !role.Equals("Admin", StringComparison.OrdinalIgnoreCase))
        {
            Navigation.NavigateTo("/");
            return;
        }

        // Subscribe to auto-sync completion events
        AutoSyncService.OnAutoSyncCompleted += OnAutoSyncCompleted;

        await LoadSyncStatus();
        LoadSettings();
        
        // Start countdown timer if auto-sync is enabled
        StartCountdownTimer();
    }
    
    private void StartCountdownTimer()
    {
        // Cancel any existing countdown
        try
        {
            countdownCts?.Cancel();
            countdownCts?.Dispose();
        }
        catch (ObjectDisposedException)
        {
            // Already disposed, ignore
        }
        countdownCts = null;
        
        if (autoSyncEnabled && AutoSyncService.IsRunning)
        {
            totalIntervalSeconds = syncIntervalMinutes * 60;
            UpdateCountdown();
            
            // Start new countdown loop
            countdownCts = new CancellationTokenSource();
            _ = RunCountdownLoop(countdownCts.Token);
        }
        else
        {
            countdownSeconds = 0;
        }
    }
    
    private async Task RunCountdownLoop(CancellationToken cancellationToken)
    {
        try
        {
            while (!cancellationToken.IsCancellationRequested)
            {
                await Task.Delay(1000, cancellationToken);
                
                if (countdownSeconds > 0)
                {
                    countdownSeconds--;
                }
                else
                {
                    UpdateCountdown();
                }
                
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (TaskCanceledException)
        {
            // Timer was cancelled, this is expected
        }
    }
    
    private void UpdateCountdown()
    {
        // Use NextSyncTime from the service - this persists across page navigations
        if (AutoSyncService.NextSyncTime.HasValue)
        {
            var remaining = AutoSyncService.NextSyncTime.Value - DateTime.Now;
            
            if (remaining.TotalSeconds > 0)
            {
                countdownSeconds = (int)remaining.TotalSeconds;
            }
            else
            {
                countdownSeconds = 0;
            }
        }
        else
        {
            // Fallback if NextSyncTime not set yet
            countdownSeconds = totalIntervalSeconds;
        }
    }
    
    private string FormatCountdown()
    {
        var minutes = countdownSeconds / 60;
        var seconds = countdownSeconds % 60;
        
        if (minutes > 0)
        {
            return $"{minutes}m {seconds:D2}s";
        }
        return $"{seconds}s";
    }
    
    private int GetCountdownProgress()
    {
        if (totalIntervalSeconds <= 0) return 100;
        return (int)((double)(totalIntervalSeconds - countdownSeconds) / totalIntervalSeconds * 100);
    }

    private async void OnAutoSyncCompleted(object? sender, AutoSyncEventArgs e)
    {
        await InvokeAsync(async () =>
        {
            if (e.Success)
            {
                if (e.RecordsUploaded > 0)
                {
                    Toast.ShowSuccess($"Auto-sync completed at {e.SyncTime:hh:mm tt}! Uploaded: {e.RecordsUploaded} records");
                }
            }
            else
            {
                Toast.ShowError($"Auto-sync failed: {e.ErrorMessage}");
            }
            
            await LoadSyncStatus();
            
            // Reset countdown after sync completes
            UpdateCountdown();
            
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        AutoSyncService.OnAutoSyncCompleted -= OnAutoSyncCompleted;
        try
        {
            countdownCts?.Cancel();
            countdownCts?.Dispose();
        }
        catch (ObjectDisposedException)
        {
            // Already disposed, ignore
        }
        countdownCts = null;
    }

    private async Task LoadSyncStatus()
    {
        try
        {
            syncStatus = await SyncService.GetSyncStatusAsync();
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Failed to load sync status: {ex.Message}");
        }
    }

    private void LoadSettings()
    {
        var settings = SyncService.GetSettings();
        autoSyncEnabled = settings.AutoSyncEnabled;
        syncIntervalMinutes = settings.SyncIntervalMinutes;
        apiBaseUrl = settings.ApiUrl;
        apiKey = settings.ApiKey;
    }

    private async Task SaveSettings()
    {
        var settings = SyncService.GetSettings();
        settings.AutoSyncEnabled = autoSyncEnabled;
        settings.SyncIntervalMinutes = syncIntervalMinutes;
        await SyncService.SaveSettingsAsync(settings);

        // Start or stop auto-sync based on toggle
        if (autoSyncEnabled)
        {
            AutoSyncService.UpdateInterval(syncIntervalMinutes);
            AutoSyncService.Start();
        }
        else
        {
            AutoSyncService.Stop();
        }
        
        // Restart countdown timer with new settings
        StartCountdownTimer();
    }

    private async Task FullSync()
    {
        isSyncing = true;
        syncProgress = new SyncProgress();
        StateHasChanged();
        
        try
        {
            var progress = new Progress<SyncProgress>(p =>
            {
                syncProgress = p;
                InvokeAsync(StateHasChanged);
            });
            
            lastSyncResult = await SyncService.SyncAllAsync(progress);
            
            if (lastSyncResult.Success)
            {
                Toast.ShowSuccess($"Full sync completed! Uploaded: {lastSyncResult.RecordsUploaded}, Downloaded: {lastSyncResult.RecordsDownloaded}");
            }
            else
            {
                var errorMsg = lastSyncResult.ErrorMessage ?? "Sync failed";
                if (lastSyncResult.Errors?.Any() == true)
                {
                    errorMsg += " | Errors: " + string.Join("; ", lastSyncResult.Errors.Take(3));
                }
                Toast.ShowError(errorMsg);
            }
            
            await LoadSyncStatus();
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Sync error: {ex.Message}");
            Console.WriteLine($"[Sync] Full sync exception: {ex}");
        }
        finally
        {
            isSyncing = false;
        }
    }

    private async Task SyncPending()
    {
        isSyncing = true;
        syncProgress = new SyncProgress();
        StateHasChanged();
        
        try
        {
            // Check if there's any pending data to sync
            if (syncStatus == null || syncStatus.TotalPending == 0)
            {
                Toast.ShowWarning("No data to sync yet. All records are already synchronized.");
                return;
            }
            
            var progress = new Progress<SyncProgress>(p =>
            {
                syncProgress = p;
                InvokeAsync(StateHasChanged);
            });
            
            lastSyncResult = await SyncService.SyncPendingAsync(progress);
            
            if (lastSyncResult.Success)
            {
                Toast.ShowSuccess($"Pending sync completed! Uploaded: {lastSyncResult.RecordsUploaded}");
            }
            else
            {
                var errorMsg = lastSyncResult.ErrorMessage ?? "Sync failed";
                if (lastSyncResult.Errors?.Any() == true)
                {
                    errorMsg += " | Errors: " + string.Join("; ", lastSyncResult.Errors.Take(3));
                }
                Toast.ShowError(errorMsg);
            }
            
            await LoadSyncStatus();
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Sync error: {ex.Message}");
            Console.WriteLine($"[Sync] Pending sync exception: {ex}");
        }
        finally
        {
            isSyncing = false;
        }
    }

    private async Task PushAllData()
    {
        isSyncing = true;
        syncProgress = new SyncProgress();
        StateHasChanged();
        
        try
        {
            var progress = new Progress<SyncProgress>(p =>
            {
                syncProgress = p;
                InvokeAsync(StateHasChanged);
            });
            
            lastSyncResult = await SyncService.PushAllDataAsync(progress);
            
            if (lastSyncResult.Success)
            {
                Toast.ShowSuccess($"Push completed! {lastSyncResult.RecordsUploaded} records backed up to cloud.");
            }
            else
            {
                var errorMsg = lastSyncResult.ErrorMessage ?? "Push failed";
                if (lastSyncResult.Errors.Any())
                {
                    errorMsg += " - " + string.Join(", ", lastSyncResult.Errors);
                }
                Toast.ShowError(errorMsg);
            }
            
            await LoadSyncStatus();
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Push error: {ex.Message}");
        }
        finally
        {
            isSyncing = false;
        }
    }

    private async Task PullAllData()
    {
        isSyncing = true;
        syncProgress = new SyncProgress();
        StateHasChanged();
        
        try
        {
            var progress = new Progress<SyncProgress>(p =>
            {
                syncProgress = p;
                InvokeAsync(StateHasChanged);
            });
            
            lastSyncResult = await SyncService.PullAllDataAsync(progress);
            
            if (lastSyncResult.Success)
            {
                Toast.ShowSuccess($"Pull completed! {lastSyncResult.RecordsDownloaded} records restored from cloud.");
            }
            else
            {
                var errorMsg = lastSyncResult.ErrorMessage ?? "Pull failed";
                if (lastSyncResult.Errors.Any())
                {
                    errorMsg += " - " + string.Join(", ", lastSyncResult.Errors);
                }
                Toast.ShowError(errorMsg);
            }
            
            await LoadSyncStatus();
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Pull error: {ex.Message}");
        }
        finally
        {
            isSyncing = false;
        }
    }

    private async Task TestConnection()
    {
        if (string.IsNullOrEmpty(apiBaseUrl))
        {
            Toast.ShowError("Please enter an API URL");
            return;
        }
        
        isTesting = true;
        
        try
        {
            // Save settings first so test uses new URL
            var settings = SyncService.GetSettings();
            settings.ApiUrl = apiBaseUrl;
            settings.ApiKey = apiKey;
            await SyncService.SaveSettingsAsync(settings);
            
            var connected = await SyncService.TestConnectionAsync();
            
            if (connected)
            {
                Toast.ShowSuccess("Connection successful! Cloud API is reachable.");
                await LoadSyncStatus();
            }
            else
            {
                Toast.ShowError("Connection failed. Please check the URL and try again.");
            }
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Connection failed: {ex.Message}");
        }
        finally
        {
            isTesting = false;
        }
    }

    private async Task SaveApiConfig()
    {
        try
        {
            var settings = SyncService.GetSettings();
            settings.ApiUrl = apiBaseUrl;
            settings.ApiKey = apiKey;
            await SyncService.SaveSettingsAsync(settings);
            
            Toast.ShowSuccess("API configuration saved successfully!");
            await LoadSyncStatus();
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Failed to save configuration: {ex.Message}");
        }
    }

    private string GetStatusBadgeClass()
    {
        if (isSyncing) return "bg-warning";
        if ((syncStatus?.TotalPending ?? 0) > 0) return "bg-info";
        return "bg-success";
    }

    private string GetSyncStatusText()
    {
        if (isSyncing) return "Syncing...";
        var pending = syncStatus?.TotalPending ?? 0;
        if (pending > 0) return $"{pending} Pending";
        return "Up to Date";
    }

    // Helper methods for user-friendly error messages
    private bool IsOfflineError(List<string> errors)
    {
        var offlineKeywords = new[] { 
            "No such host is known", 
            "Unable to connect", 
            "Connection refused",
            "Network is unreachable",
            "host is unreachable",
            "timed out",
            "SocketException",
            "No connection could be made"
        };
        
        return errors.Any(e => offlineKeywords.Any(k => 
            e.Contains(k, StringComparison.OrdinalIgnoreCase)));
    }

    private bool IsServerError(List<string> errors)
    {
        var serverKeywords = new[] { 
            "500", "502", "503", "504",
            "Internal Server Error",
            "Bad Gateway",
            "Service Unavailable",
            "Gateway Timeout"
        };
        
        return errors.Any(e => serverKeywords.Any(k => 
            e.Contains(k, StringComparison.OrdinalIgnoreCase)));
    }

    private string GetFriendlyError(string technicalError)
    {
        // Extract the entity name if present
        if (technicalError.Contains("Connection error for "))
        {
            var parts = technicalError.Split("Connection error for ");
            if (parts.Length > 1)
            {
                var entityName = parts[1].Split(':')[0].Trim();
                return $"{entityName}: Could not connect to server";
            }
        }
        
        if (technicalError.Contains("No such host is known"))
            return "Server address not found - check internet connection";
        
        if (technicalError.Contains("timed out"))
            return "Connection timed out - server may be busy";
            
        if (technicalError.Contains("Failed to upload"))
        {
            var parts = technicalError.Split("Failed to upload ");
            if (parts.Length > 1)
            {
                var entityName = parts[1].Split(':')[0].Trim();
                return $"Could not upload {entityName} data";
            }
        }

        if (technicalError.Contains("foreign key") || technicalError.Contains("FK_"))
            return "Related data missing - try syncing all data first";

        if (technicalError.Contains("duplicate") || technicalError.Contains("unique"))
            return "Data already exists in cloud";

        // Return shortened version of unknown errors
        if (technicalError.Length > 80)
            return technicalError.Substring(0, 77) + "...";
            
        return technicalError;
    }

    private string GetFriendlyErrorTitle(string error)
    {
        if (error.Contains("No such host") || error.Contains("Unable to connect") || 
            error.Contains("Connection refused") || error.Contains("timed out"))
            return "No Internet Connection";
        
        if (error.Contains("500") || error.Contains("502") || error.Contains("503"))
            return "Server Temporarily Unavailable";
            
        if (error.Contains("Sync failed"))
            return "Sync Could Not Complete";
            
        if (error.Contains("Connection failed"))
            return "Connection Failed";
            
        return "Something Went Wrong";
    }

    private string GetFriendlyErrorMessage(string error)
    {
        if (error.Contains("No such host") || error.Contains("Unable to connect") || 
            error.Contains("Connection refused"))
            return "Please check your internet connection and try again. Your data is safe locally.";
        
        if (error.Contains("timed out"))
            return "The server took too long to respond. Please try again in a moment.";
            
        if (error.Contains("500") || error.Contains("502") || error.Contains("503"))
            return "The cloud server is having issues. Please try again later.";
            
        if (error.Contains("Sync failed"))
            return "Could not sync with the cloud. Your data is saved locally and will sync when connection is restored.";
            
        if (error.Contains("Connection failed"))
            return "Could not reach the cloud server. Please verify the API URL is correct.";
            
        // For other errors, just return a generic message
        return "Please try again. If the problem persists, contact support.";
    }
}
