@page "/login"
@layout Spa_Management_System.Components.Layout.AuthLayout
@using Spa_Management_System.Services
@using Spa_Management_System.Models
@inject IAuthService AuthService
@inject IAuthStateService AuthState
@inject NavigationManager Navigation

<PageTitle>Spa</PageTitle>

<!-- Left Panel - Branding -->
<div class="auth-left-panel">
    <div class="logo-container">
        <img src="images/logo.png" alt="Spa Management System" class="logo-image" />
    </div>
</div>

<!-- Right Panel - Login Form -->
<div class="auth-right-panel">
    <div class="auth-card">
        <h2>Welcome</h2>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="auth-alert error">
                <span class="bi bi-x-circle-fill"></span>
                <span>@errorMessage</span>
            </div>
        }

        @if (loginSuccess)
        {
            <div class="auth-alert success">
                <span class="bi bi-check-circle-fill"></span>
                <span>Login successful! Redirecting...</span>
            </div>
        }

        <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />

            <div class="form-group">
                <label class="form-label">Username</label>
                <InputText @bind-Value="loginModel.Username" 
                           class="form-control" 
                           placeholder="Enter your Username"
                           disabled="@isLoggingIn"
                           autocomplete="username" />
                <ValidationMessage For="@(() => loginModel.Username)" />
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <div class="password-wrapper">
                    <InputText @bind-Value="loginModel.Password" 
                               type="@(showPassword ? "text" : "password")" 
                               class="form-control" 
                               placeholder="Enter your password"
                               disabled="@isLoggingIn"
                               autocomplete="current-password" />
                    <button type="button" class="password-toggle" @onclick="TogglePassword" tabindex="-1">
                        <span class="bi @(showPassword ? "bi-eye-slash" : "bi-eye")"></span>
                    </button>
                </div>
                <ValidationMessage For="@(() => loginModel.Password)" />
            </div>

            <button type="submit" class="btn-signin" disabled="@isLoggingIn">
                @if (isLoggingIn)
                {
                    <div class="loading" style="width: 1.25rem; height: 1.25rem; border-width: 2px;"></div>
                    <span>Signing in...</span>
                }
                else
                {
                    <span>Sign in</span>
                }
            </button>
        </EditForm>
    </div>
</div>

@code {
    private LoginModel loginModel = new();
    private bool isLoggingIn = false;
    private bool loginSuccess = false;
    private bool showPassword = false;
    private string? errorMessage;

    private void TogglePassword()
    {
        showPassword = !showPassword;
    }

    protected override void OnInitialized()
    {
        // If already logged in, redirect based on role
        if (AuthState.IsAuthenticated)
        {
            RedirectBasedOnRole();
        }
    }

    private async Task HandleLogin()
    {
        isLoggingIn = true;
        errorMessage = null;
        loginSuccess = false;

        try
        {
            var user = await AuthService.AuthenticateAsync(loginModel.Username, loginModel.Password);

            if (user == null)
            {
                errorMessage = "Invalid username or password. Please try again.";
                isLoggingIn = false;
                return;
            }

            // Check if user is active
            if (!user.IsActive)
            {
                errorMessage = "Your account has been deactivated. Please contact your administrator.";
                isLoggingIn = false;
                return;
            }

            // Set the authenticated user in state
            AuthState.SetUser(user);
            
            loginSuccess = true;
            
            // Brief delay to show success message
            await Task.Delay(1000);
            
            // Redirect based on role
            RedirectBasedOnRole();
        }
        catch (Exception ex)
        {
            errorMessage = $"Login error: {ex.Message}";
            isLoggingIn = false;
        }
    }

    private void RedirectBasedOnRole()
    {
        var role = AuthState.GetUserRole();
        
        // Redirect based on role to their main work page
        var destination = role.ToLower() switch
        {
            "superadmin" => "/admin",
            "manager" => "/manager-dashboard",
            "therapist" => "/my-schedule",
            "receptionist" => "/appointments",
            "inventoryclerk" => "/inventory",
            "accountant" => "/financial-statements",
            _ => "/employee-dashboard"
        };
        
        Navigation.NavigateTo(destination, forceLoad: true);
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "Username is required")]
        public string Username { get; set; } = "";

        [Required(ErrorMessage = "Password is required")]
        public string Password { get; set; } = "";
    }
}
