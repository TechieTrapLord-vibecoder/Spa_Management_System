@page "/service-commissions"
@using Spa_Management_System.Services
@using Spa_Management_System.Data
@using Spa_Management_System.Models
@using Microsoft.EntityFrameworkCore
@inject IAuthStateService AuthState
@inject NavigationManager Navigation
@inject AppDbContext DbContext

<PageTitle>Service Commissions - Kaye Spa</PageTitle>

@if (!AuthState.IsAuthenticated)
{
    <div class="card">
        <div class="alert alert-danger">
            <span class="bi bi-shield-x"></span>
            <div>
                <h4 style="margin: 0 0 0.5rem 0;">Access Denied</h4>
                <p style="margin: 0;">Please log in to view service commissions.</p>
            </div>
        </div>
        <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/login")'>
            <span class="bi bi-box-arrow-in-right"></span> Go to Login
        </button>
    </div>
}
else
{
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
                <h3 class="card-title" style="margin: 0;"><span class="bi bi-cash-stack"></span> Service Commission Rates</h3>
                <p style="color: var(--spa-text-light); margin: 0.5rem 0 0 0;">Commission rates are set per service - all therapists earn the same rate</p>
            </div>
            @if (AuthState.GetUserRole().Equals("SuperAdmin", StringComparison.OrdinalIgnoreCase))
            {
                <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/services")'>
                    <span class="bi bi-gear"></span> Manage in Services
                </button>
            }
        </div>

        @if (isLoading)
        {
            <div style="padding: 2rem; text-align: center;">
                <div class="loading"></div>
                <p style="margin-top: 1rem; color: var(--spa-text-light);">Loading commission rates...</p>
            </div>
        }
        else
        {
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div class="card" style="padding: 1.25rem; background: #DCD8CE; color: #454F4A; margin-bottom: 0;">
                    <div style="font-size: 0.85rem;">Total Services</div>
                    <div style="font-size: 2rem; font-weight: 700;">@services.Count</div>
                </div>
                <div class="card" style="padding: 1.25rem; background: #DCD8CE; color: #454F4A; margin-bottom: 0;">
                    <div style="font-size: 0.85rem;">With Commission</div>
                    <div style="font-size: 2rem; font-weight: 700;">@services.Count(s => s.CommissionValue > 0)</div>
                </div>
                <div class="card" style="padding: 1.25rem; background: #DCD8CE; color: #454F4A; margin-bottom: 0;">
                    <div style="font-size: 0.85rem;">Percentage Based</div>
                    <div style="font-size: 2rem; font-weight: 700;">@services.Count(s => s.CommissionType == "percentage")</div>
                </div>
                <div class="card" style="padding: 1.25rem; background: #DCD8CE; color: #454F4A; margin-bottom: 0;">
                    <div style="font-size: 0.85rem;">Fixed Amount</div>
                    <div style="font-size: 2rem; font-weight: 700;">@services.Count(s => s.CommissionType == "fixed")</div>
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Filter by Category:</label>
                <select class="form-control" style="max-width: 300px;" @bind="selectedCategoryId" @bind:after="ApplyFilter">
                    <option value="0">All Categories</option>
                    @foreach (var cat in categories)
                    {
                        <option value="@cat.ServiceCategoryId">@cat.Name</option>
                    }
                </select>
            </div>

            @if (!filteredServices.Any())
            {
                <div class="alert alert-info">
                    <span class="bi bi-info-circle-fill"></span>
                    <div>No services found matching your filters.</div>
                </div>
            }
            else
            {
                <div class="table-search">
                    <input type="text" placeholder="Search services..." @bind="searchTerm" @bind:event="oninput" @bind:after="ApplyFilter" />
                </div>

                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="cursor: pointer;" @onclick='() => SortBy("category")'>Category @GetSortIcon("category")</th>
                                <th style="cursor: pointer;" @onclick='() => SortBy("service")'>Service @GetSortIcon("service")</th>
                                <th style="cursor: pointer; text-align: right;" @onclick='() => SortBy("price")'>Price @GetSortIcon("price")</th>
                                <th style="cursor: pointer;" @onclick='() => SortBy("type")'>Commission Type @GetSortIcon("type")</th>
                                <th style="cursor: pointer; text-align: right;" @onclick='() => SortBy("rate")'>Rate @GetSortIcon("rate")</th>
                                <th style="text-align: right;">Therapist Earns</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var service in GetPagedServices())
                            {
                                var earnings = CalculateEarnings(service);
                                <tr>
                                    <td>
                                        <span class="badge" style="background: var(--spa-secondary); color: var(--spa-dark);">
                                            @(service.ServiceCategory?.Name ?? "Uncategorized")
                                        </span>
                                    </td>
                                    <td><strong>@service.Name</strong></td>
                                    <td style="text-align: right; font-weight: 600;">₱@service.Price.ToString("N2")</td>
                                    <td>
                                        @if (service.CommissionType == "percentage")
                                        {
                                            <span class="badge badge-info"><span class="bi bi-percent"></span> Percentage</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-secondary"><span class="bi bi-cash"></span> Fixed</span>
                                        }
                                    </td>
                                    <td style="text-align: right;">
                                        @if (service.CommissionValue > 0)
                                        {
                                            <strong style="color: var(--spa-primary);">
                                                @(service.CommissionType == "percentage" ? $"{service.CommissionValue:N0}%" : $"₱{service.CommissionValue:N2}")
                                            </strong>
                                        }
                                        else
                                        {
                                            <span style="color: var(--spa-text-light);">Not set</span>
                                        }
                                    </td>
                                    <td style="text-align: right;">
                                        @if (earnings > 0)
                                        {
                                            <strong style="color: var(--spa-success);">₱@earnings.ToString("N2")</strong>
                                        }
                                        else
                                        {
                                            <span style="color: var(--spa-text-light);">₱0.00</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr style="background: var(--spa-light); font-weight: 600;">
                                <td colspan="4" style="text-align: right;">Average Commission per Service:</td>
                                <td colspan="2" style="text-align: right; color: var(--spa-success);">
                                    ₱@(filteredServices.Any() ? filteredServices.Average(s => CalculateEarnings(s)).ToString("N2") : "0.00")
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="table-pagination">
                    <span>Showing @(Math.Min((currentPage - 1) * pageSize + 1, filteredServices.Count))-@(Math.Min(currentPage * pageSize, filteredServices.Count)) of @filteredServices.Count entries</span>
                    <div class="pagination-buttons">
                        <button class="btn btn-sm btn-light" disabled="@(currentPage <= 1)" @onclick="PreviousPage">Previous</button>
                        @foreach (var pageNum in GetVisiblePages())
                        {
                            @if (pageNum == -1)
                            {
                                <span style="padding: 0.25rem 0.5rem;">…</span>
                            }
                            else
                            {
                                <button class="btn btn-sm @(pageNum == currentPage ? "btn-primary" : "btn-light")" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                            }
                        }
                        <button class="btn btn-sm btn-light" disabled="@(currentPage >= TotalPages)" @onclick="NextPage">Next</button>
                    </div>
                </div>
            }

            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(170, 148, 120, 0.1); border-radius: 8px; border: 1px solid var(--spa-secondary);">
                <h5 style="margin: 0 0 0.5rem 0; color: var(--spa-primary);"><span class="bi bi-info-circle"></span> How Commissions Work</h5>
                <ul style="margin: 0; padding-left: 1.5rem; color: var(--spa-text);">
                    <li><strong>Percentage:</strong> Therapist earns a percentage of the service price</li>
                    <li><strong>Fixed Amount:</strong> Therapist earns a fixed peso amount</li>
                    <li>All therapists earn the same commission for a given service</li>
                </ul>
                @if (AuthState.GetUserRole().Equals("SuperAdmin", StringComparison.OrdinalIgnoreCase))
                {
                    <p style="margin: 1rem 0 0 0; color: var(--spa-text-light);">
                        <span class="bi bi-lightbulb"></span> To change rates, go to <a href="/services" style="color: var(--spa-primary);">Services</a> and edit the service.
                    </p>
                }
            </div>
        }
    </div>
}

@code {
    private List<Service> services = new();
    private List<Service> filteredServices = new();
    private List<ServiceCategory> categories = new();
    private bool isLoading = true;
    private int selectedCategoryId = 0;
    private string searchTerm = "";

    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;
    private int TotalPages => (int)Math.Ceiling((double)filteredServices.Count / pageSize);

    // Sorting
    private string sortColumn = "service";
    private bool sortAscending = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            services = await DbContext.Services
                .Include(s => s.ServiceCategory)
                .Where(s => s.Active)
                .OrderBy(s => s.Name)
                .ToListAsync();

            categories = await DbContext.ServiceCategories
                .OrderBy(c => c.Name)
                .ToListAsync();

            ApplyFilter();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilter()
    {
        IEnumerable<Service> filtered = services;

        if (selectedCategoryId > 0)
            filtered = filtered.Where(s => s.ServiceCategoryId == selectedCategoryId);

        if (!string.IsNullOrEmpty(searchTerm))
        {
            var term = searchTerm.ToLower();
            filtered = filtered.Where(s => 
                s.Name.ToLower().Contains(term) ||
                (s.Code ?? "").ToLower().Contains(term) ||
                (s.ServiceCategory?.Name ?? "").ToLower().Contains(term));
        }

        // Apply sorting
        filtered = sortColumn switch
        {
            "category" => sortAscending 
                ? filtered.OrderBy(s => s.ServiceCategory?.Name) 
                : filtered.OrderByDescending(s => s.ServiceCategory?.Name),
            "service" => sortAscending 
                ? filtered.OrderBy(s => s.Name) 
                : filtered.OrderByDescending(s => s.Name),
            "price" => sortAscending 
                ? filtered.OrderBy(s => s.Price) 
                : filtered.OrderByDescending(s => s.Price),
            "type" => sortAscending 
                ? filtered.OrderBy(s => s.CommissionType) 
                : filtered.OrderByDescending(s => s.CommissionType),
            "rate" => sortAscending 
                ? filtered.OrderBy(s => s.CommissionValue) 
                : filtered.OrderByDescending(s => s.CommissionValue),
            _ => filtered
        };

        filteredServices = filtered.ToList();
        currentPage = 1;
    }

    private void SortBy(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
        ApplyFilter();
    }

    private string GetSortIcon(string column)
    {
        if (sortColumn != column) return "";
        return sortAscending ? "↑" : "↓";
    }

    private List<Service> GetPagedServices()
    {
        return filteredServices
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private void PreviousPage()
    {
        if (currentPage > 1) currentPage--;
    }

    private void NextPage()
    {
        if (currentPage < TotalPages) currentPage++;
    }

    private void GoToPage(int page)
    {
        currentPage = page;
    }

    private List<int> GetVisiblePages()
    {
        var pages = new List<int>();
        if (TotalPages <= 7)
        {
            for (int i = 1; i <= TotalPages; i++) pages.Add(i);
        }
        else
        {
            pages.Add(1);
            if (currentPage > 3) pages.Add(-1);
            for (int i = Math.Max(2, currentPage - 1); i <= Math.Min(TotalPages - 1, currentPage + 1); i++)
                pages.Add(i);
            if (currentPage < TotalPages - 2) pages.Add(-1);
            pages.Add(TotalPages);
        }
        return pages;
    }

    private decimal CalculateEarnings(Service service)
    {
        if (service.CommissionValue <= 0) return 0;
        return service.CommissionType == "percentage"
            ? service.Price * service.CommissionValue / 100
            : service.CommissionValue;
    }
}
